<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.17.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Django + REST + SQLite @ docker로 Eaten_Away 서비스 개발하기 - 위즐리 블로그</title>
<meta name="description" content="Overview ">


  <meta name="author" content="Wizley">


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="위즐리 블로그">
<meta property="og:title" content="Django + REST + SQLite @ docker로 Eaten_Away 서비스 개발하기">
<meta property="og:url" content="http://localhost:4000/dev/Django-+-REST-+-SQLite-@-docker%EB%A1%9C-Eaten_Away-%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B0%9C%EB%B0%9C%ED%95%98%EA%B8%B0/">


  <meta property="og:description" content="Overview ">







  <meta property="article:published_time" content="2020-03-02T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/dev/Django-+-REST-+-SQLite-@-docker%EB%A1%9C-Eaten_Away-%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B0%9C%EB%B0%9C%ED%95%98%EA%B8%B0/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Wizley",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="위즐리 블로그 Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

    
  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          위즐리 블로그
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/dev/" >dev</a>
            </li><li class="masthead__menu-item">
              <a href="/android/" >android</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="https://avatars1.githubusercontent.com/u/32321029?s=460&v=4" alt="Wizley" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Wizley</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>I think I wanna become Android developer for now</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">KR</span>
        </li>
      

      
        
          
        
          
        
          
        
      

      

      
        <li>
          <a href="mailto:wizley@kakao.com">
            <meta itemprop="email" content="wizley@kakao.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> 이메일
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/wizleysw" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Django + REST + SQLite @ docker로 Eaten_Away 서비스 개발하기">
    <meta itemprop="description" content="Overview">
    <meta itemprop="datePublished" content="2020-03-02T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Django + REST + SQLite @ docker로 Eaten_Away 서비스 개발하기
</h1>
          
          <!--
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  46 분 소요

</p>
          -->
          <p class="page_data"><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 게시일: <time datetime="2020-03-02T00:00:00+09:00">March 02, 2020</time></p>
            
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu">
  <li><a href="#overview">Overview</a></li>
  <li><a href="#settings">Settings</a>
    <ul>
      <li><a href="#django">Django</a></li>
      <li><a href="#rest-framework">REST FrameWork</a></li>
      <li><a href="#dockerfile">Dockerfile</a></li>
      <li><a href="#requirementstxt">requirements.txt</a></li>
      <li><a href="#docker-compose">docker-compose</a></li>
    </ul>
  </li>
  <li><a href="#django-help">django help</a>
    <ul>
      <li><a href="#superuser">superuser</a></li>
      <li><a href="#stale-contenttype">stale contenttype</a></li>
      <li><a href="#check">check</a></li>
      <li><a href="#createcachetable">createcachetable</a></li>
    </ul>
  </li>
  <li><a href="#django-projectapp">Django project/app</a>
    <ul>
      <li><a href="#project">project</a></li>
      <li><a href="#app">app</a></li>
    </ul>
  </li>
  <li><a href="#settingspy">settings.py</a>
    <ul>
      <li><a href="#secret_key">SECRET_KEY</a></li>
    </ul>
  </li>
  <li><a href="#user-app-개발">user app 개발</a>
    <ul>
      <li><a href="#helloworld-출력">HelloWorld 출력</a></li>
      <li><a href="#user-account-db-설계">User, Account db 설계</a></li>
      <li><a href="#템플릿">템플릿</a></li>
      <li><a href="#회원가입-페이지-만들기">회원가입 페이지 만들기</a></li>
      <li><a href="#recaptcha">recaptcha</a></li>
      <li><a href="#rest-framework-도입">rest framework 도입</a></li>
      <li><a href="#id--email-중복-검사">ID / email 중복 검사</a></li>
      <li><a href="#회원가입-구현">회원가입 구현</a></li>
      <li><a href="#이메일-인증-구현">이메일 인증 구현</a></li>
      <li><a href="#rest_framework의-편의성을-위한-user-model-변경">rest_framework의 편의성을 위한 User model 변경</a></li>
      <li><a href="#jwt를-활용하여-로그인-구현">jwt를 활용하여 로그인 구현</a></li>
    </ul>
  </li>
  <li><a href="#food-app-개발">food app 개발</a>
    <ul>
      <li><a href="#csv-파일로-bulk_create하여-음식정보-한번에-추가하기">csv 파일로 bulk_create하여 음식정보 한번에 추가하기</a></li>
      <li><a href="#menu에-대한-정보-뿌려주는-페이지-작성하기">menu에 대한 정보 뿌려주는 페이지 작성하기</a></li>
      <li><a href="#사용자-정보-그래프로-뿌려주기">사용자 정보 그래프로 뿌려주기</a></li>
      <li><a href="#사용자에게-맞는-음식-추천하기">사용자에게 맞는 음식 추천하기</a></li>
      <li><a href="#사용자가-먹은-음식에-대한-정보-등록하는-페이지-생성">사용자가 먹은 음식에 대한 정보 등록하는 페이지 생성</a></li>
      <li><a href="#kakao-map-api-연동하기">kakao map api 연동하기</a></li>
      <li><a href="#dailyuserfood-rest-delete로-삭제하기">DailyUserFood REST DELETE로 삭제하기</a></li>
    </ul>
  </li>
  <li><a href="#리팩토링-및-api에-jwt-권한-설정">리팩토링 및 API에 JWT 권한 설정</a>
    <ul>
      <li><a href="#user-app-리팩토링">user app 리팩토링</a></li>
      <li><a href="#food-app-리팩토링">food app 리팩토링</a></li>
      <li><a href="#api-app-리팩토링">api app 리팩토링</a></li>
      <li><a href="#jwt-api-권한-설정">JWT API 권한 설정</a></li>
      <li><a href="#github-link">GITHUB link</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h2 id="overview">Overview</h2>

<p>방금 PHP 개발 프로젝트를 마무리하고 바로 시작하게 된 다음 프로젝트는 요즘 젤 잘 나가는 강력한 프레임워크인 Django를 사용한다. 그리고 이전 포스팅은 간단한 게시판을 구현한 정도였다면 이번에는 하나의 서비스를 개발한다는 생각으로 진행할 예정이다. 이번에도 docker를 사용할 것인데 도커 이외에 Django + REST + SQLite라는 또다시 나에게 생소한 조합으로 개발을 진행하고자 한다.</p>

<p>이번에 서비스의 주제로 정한 키워드는 “음식”이다. 내 일과를 생각해보았을 때, 아침, 점심, 저녁에 뭘 먹을지에 대한 고민이 꽤 큰 비율을 차지한다. 그래서 이번 프로젝트는 다음의 기능을 가지고 있는 서비스를 개발하고자 한다.</p>

<ol>
  <li>RANDOM으로 추천메뉴를 가져온 뒤 선택할 시 메뉴에 대한 상세 정보 및 상점의 리스트를 사용자에게 보여주는 기능</li>
  <li>먹고 싶은 메뉴를 검색하여 조회</li>
  <li>개개인이 먹은 메뉴 정보를 저장하여 특정 주기동안 임의의 음식을 몇번이나 또는 얼마만의 주기마다 먹었는지를 확인하여 그래프 등으로 표시하는 기능</li>
</ol>

<p>그리고 해당 개념을 토대로 구현하고자 하는 세부적인 목표를 정하자면 다음과 같다.</p>

<ol>
  <li>회원가입 / 로그인 -&gt; 메일 인증 기능</li>
  <li>음식관련 개인정보 열람(본인에 의하여/타인에 의하여) 및 수정</li>
  <li>게시물의 댓글 + 대댓글 기능 구현</li>
  <li>맵 관련 api 연동</li>
  <li>실시간 대화 or 1:1 대화방 구현</li>
</ol>

<p>약간 배달 어플과 흡사한 기능을 가지고 있다고 볼 수도 있을 것 같다. 어쩌면 거의 같을지도 모르겠다. 적는 지금 생각을 해보니 음식점에 대한 정보를 업데이트 하기 위해서 DB에서 사용자에 대한 정보를 다음과 같이 세분화 할 수 있을 것 같다. 점주 부분의 경우 추가하지 않을 수도 있음!</p>

<ol>
  <li>사용자</li>
  <li>점주</li>
  <li>관리자</li>
</ol>

<p>세부적인 사항은 DB를 설계하게 되면 그 때 더 심층적으로 고민을 해보도록 하고 지금해야할 것은 REST api와 Docker에 대해 이해하는 것과 그에 따라 docker-compose파일을 작성하는 것이다. 그러면 먼 여정을 시작해보도록 하자.</p>

<p>(중간중간 생략된 값들이 있기 때문에 필자의 깃허브를 통해 코드를 확인하기를 추천하는 바이다.)</p>

<h2 id="settings">Settings</h2>

<h3 id="django">Django</h3>

<p>장고는 MVT 구조를 채택하고 있다. 아래의 링크를 통해 해당 부분을 공부할 수 있다.</p>

<p><a href="https://butter-shower.tistory.com/49?category=718374">Django MVT 패턴</a></p>

<p>장고는 python 기반으로 구현되었기 때문에 python 문법을 알면 개발이 가능하다는 특장점이 있으며, 정해진 규칙에 의거하여 개발을 진행해야 하기 때문에 딴 사람의 코드에 대한 이해가 쉽고 개발을 오래하여 구현에 익숙해지면 쉽다는 장점이 있다.</p>

<h3 id="rest-framework">REST FrameWork</h3>

<p>이 주제도 아래의 링크에 잘 설명되어 있다.</p>

<p><a href="https://gmlwjd9405.github.io/2018/09/21/rest-and-restful.html">REST API란</a></p>

<p>얘를 왜 쓰고싶었냐면 안드로이드/웹 등의 멀티 플랫폼 개발에서 효율적으로 사용될 뿐만 아니라 POST/GET 등의 HTTP 메소드를 통해 API를 구현하기 때문에 형식적이고 간단하다는 느낌이 들었다. 아직 제대로 활용을 안해봤기 때문에 사용하면서 느껴봐야 할 것 같다.</p>

<h3 id="dockerfile">Dockerfile</h3>

<p>이번에는 Docker에 Django 세팅이 필요하다. python2의 지원이 만료되는 시점에서 python3를 사용하는게 좋을것같기에 Ubuntu 이미지 내부에 Django 및 REST framework를 설치하는 방식을 사용하기로 하였다. 자 그럼 도커파일을 먼저 만들어야 되는데 Django같은 경우 Ubuntu 또는 Python 이미지를 베이스로 생성을 한다. python3 이미지를 사용하면 pip / python3에 대한 버전관리가 되며 이미지 용량이 Ubuntu보다 가볍기 때문에 Python 이미지를 베이스로 사용하는 것이 좋을 것 같았다.</p>

<p>그래서 다음과 같이 초기 Dockerfile을 만들었다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">FROM python:3

</span><span class="gp">MAINTAINER Wizley &lt;wizley@kakao.com&gt;</span><span class="w">
</span><span class="go">
WORKDIR /code

RUN pip3 install \
	django \
	django-cors-headers \
	djangorestframework \
	djangorestframework-jwt

ENTRYPOINT \
	django-admin startproject eatenAway  \ 
</span><span class="gp">	python3 $</span><span class="o">(</span><span class="nb">pwd</span><span class="o">)</span>/eatenAway/manage.py makemigrations <span class="o">&amp;&amp;</span> <span class="se">\</span>
	python3 <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/eatenAway/manage.py migrate <span class="o">&amp;&amp;</span> <span class="se">\</span>
	<span class="nb">echo</span> <span class="s2">"from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser('root', 'wizley@github.com', 'alpine')"</span> | python3 <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/eatenAway/manage.py shell <span class="o">&amp;&amp;</span> <span class="se">\</span>
	python3 <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/eatenAway/manage.py runserver 0.0.0.0:8000
</code></pre></div></div>

<p>이제 아래의 명령어로 image를 생성한다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span>docker build <span class="nt">--tag</span> django:1.0 <span class="nb">.</span>
<span class="go">Successfully built 18300e8ec004
Successfully tagged django:1.0

</span><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span>docker images
<span class="go">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
django              1.0                 18300e8ec004        2 minutes ago       976MB
</span></code></pre></div></div>

<p>확인을 하기 위해서 container로 해당 이미지를 올려볼 것이다. 일단은 테스트이기 때문에 abc라는 이름으로 컨테이너를 올린 뒤 접속해보았다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span>docker run <span class="nt">-it</span> <span class="nt">-d</span> <span class="nt">--name</span> abc <span class="nt">-p</span> 8000:8000 django
<span class="go">fd826b9f72a23f08d2c7755e2bca48d46397d6ea28e9f154ff9e233d7ea15c2c

</span><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span>docker ps <span class="nt">-a</span>
<span class="go">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES
fd826b9f72a2        django                "/bin/sh -c 'django-…"   7 seconds ago       Exited (2) 6 seconds ago                       abc
</span></code></pre></div></div>

<p>Exited 상태가 떴다. 예감이 안좋다. 명령어상에 문제가 없어서 docker logs 명령어로 문제의 발생지점을 찾아보았다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span>docker logs abc
<span class="go">usage: django-admin startproject [-h] [--template TEMPLATE]
                                 [--extension EXTENSIONS] [--name FILES]
                                 [--version] [-v {0,1,2,3}]
                                 [--settings SETTINGS]
                                 [--pythonpath PYTHONPATH] [--traceback]
                                 [--no-color] [--force-color]
                                 name [directory]
django-admin startproject: error: unrecognized arguments: /code/eatenAway/manage.py makemigrations
</span></code></pre></div></div>

<p>arguments 결과가 잘못들어간 것을 확인할 수 있었다!! 적는 과정에서 startproject뒷 부분에 &amp;&amp;을 까먹고 넣지 않았던 것이다. 해당 부분을 수정하고 다시 빌드를 한 뒤 같은 명령어로 실행시켜보았다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span>docker run <span class="nt">-it</span> <span class="nt">-d</span> <span class="nt">--name</span> abc <span class="nt">-p</span> 8000:8000 django:1.0
<span class="go">310f35fcfdb2743a4616f7d0a38f8d7a3a73c06b99e9162db9129cd5872e8873

</span><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span>docker ps <span class="nt">-a</span>
<span class="go">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS                    NAMES
</span><span class="gp">310f35fcfdb2        django:1.0          "/bin/sh -c 'django-…"   3 seconds ago       Up 2 seconds               0.0.0.0:8000-&gt;</span>8000/tcp   abc
</code></pre></div></div>

<p>제대로 올라간 것을 확인가능하다. 이제 shell을 붙어서 상태를 확인해보겠다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@310f35fcfdb2:/code/eatenAway#</span><span class="w"> </span>ps <span class="nt">-ef</span>
<span class="go">UID        PID  PPID  C STIME TTY          TIME CMD
</span><span class="gp">root         1     0  0 11:07 pts/0    00:00:00 /bin/sh -c django-admin startproject eatenAway &amp;&amp; ?python3 $</span><span class="o">(</span><span class="nb">pwd</span><span class="o">)</span>/eate
<span class="go">root        20     1  0 11:07 pts/0    00:00:00 python3 /code/eatenAway/manage.py runserver 0.0.0.0:8000
root        22    20  5 11:07 pts/0    00:00:03 /usr/local/bin/python3 /code/eatenAway/manage.py runserver 0.0.0.0:808
root        25     0  0 11:08 pts/1    00:00:00 /bin/bash
root        36    25  0 11:09 pts/1    00:00:00 ps -ef
</span></code></pre></div></div>

<p>이제 localhost:8000을 접속해보도록 하자.</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/startproject.png" alt="startproject" /></p>

<p>빙고! 장고 프로젝트가 정상적으로 시작된 것을 확인할 수 있다. 여기서 끝내지 않고 조금 더 나아가서 requirements.txt로 패키지의 내용들을 분리한 뒤 실행하여 설치하는 방식으로 수정하도록 하겠다.</p>

<h3 id="requirementstxt">requirements.txt</h3>

<p>pip의 freeze라는 명령어를 사용하면 설치된 패키지를 알파벳 순으로 출력하는 것이 가능하다. 이를 통해 버전에 대한 정보를 가져올 수 있다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@de8d3ccac6db:/code#</span><span class="w"> </span>pip3 freeze <span class="o">&gt;</span> requirements.txt
<span class="gp">root@de8d3ccac6db:/code#</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">eatenAway  requirements.txt
</span><span class="gp">root@de8d3ccac6db:/code#</span><span class="w"> </span><span class="nb">cat </span>requirements.txt
<span class="go">asgiref==3.2.3
attrs==19.3.0
coverage==5.0.3
Django==3.0.3
django-cors-headers==3.2.1
djangorestframework==3.11.0
djangorestframework-jwt==1.11.0
more-itertools==8.2.0
packaging==20.1
pluggy==0.13.1
py==1.8.1
PyJWT==1.7.1
pyparsing==2.4.6
pytest==5.3.5
pytest-cov==2.8.1
pytz==2019.3
six==1.14.0
sqlparse==0.3.0
wcwidth==0.1.8
</span></code></pre></div></div>

<p>이제 도커를 다음과 같이 변경을 한다. 이제 requirements.txt를 바탕으로 패키지에 대한 설치가 진행되도록 한 것이다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">FROM python:3

</span><span class="gp">MAINTAINER Wizley &lt;wizley@kakao.com&gt;</span><span class="w">
</span><span class="go">
WORKDIR /code
COPY ./requirements.txt /code

RUN pip3 install -r ./requirements.txt

</span><span class="gp">ENTRYPOINT \
	django-admin startproject eatenAway &amp;&amp; \
	python3 $</span><span class="o">(</span><span class="nb">pwd</span><span class="o">)</span>/eatenAway/manage.py makemigrations <span class="o">&amp;&amp;</span> <span class="se">\</span>
	python3 <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/eatenAway/manage.py migrate <span class="o">&amp;&amp;</span> <span class="se">\</span>
	<span class="nb">echo</span> <span class="s2">"from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser('root', 'wizley@github.com', 'alpine')"</span> | python3 <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/eatenAway/manage.py shell <span class="o">&amp;&amp;</span> <span class="se">\</span>
	python3 <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/eatenAway/manage.py runserver 0.0.0.0:8000
<span class="go">
</span></code></pre></div></div>

<p>이제 다시 image를 빌드한 뒤 run을 시키게 되면 기본 container를 돌릴 수 있다.</p>

<h3 id="docker-compose">docker-compose</h3>

<p>자 이제는 compose 파일을 만들차례이다. 이번에는 PHP 프로젝트와 달리 일단은 하나의 컨테이너만을 사용할 예정이기 때문에 network 설정은 하지 않도록 한다. 
(여기서 엄청나게 삽질을 시작하였다…)</p>

<p>지금까지 ENTRYPOINT로 호출했었는데 한번만 startproject가 실행되어야 하므로 결론적으로 Dockerfile을 다음과 같이 변경하였다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">FROM python:3

</span><span class="gp">MAINTAINER Wizley &lt;wizley@kakao.com&gt;</span><span class="w">
</span><span class="go">
WORKDIR /code
COPY ./requirements.txt /code
COPY ./docker-entrypoint.sh /code

RUN pip3 install -r ./requirements.txt
</span></code></pre></div></div>

<p>그리고 docker-compose를 다음과 같이 작성하였다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">version: '3'

services:
 django:
  container_name: django_eatenAway
  image: django:1.0
  environment:
    - DJANGO_DEBUG=true
  volumes:
    - ./code:/code
  ports:
    - "8000:8000"
  tty: true
  command: python3 ./eatenAway/manage.py runserver 0:8000
</span></code></pre></div></div>

<p>맨처음에는 command가 없이 실행을 한 뒤 code 내부에 옮겨둔 docker-entrypoint.sh를 실행시킨다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>django-admin startproject eatenAway
python <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/eatenAway/manage.py makemigrations
python <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/eatenAway/manage.py migrate
<span class="nb">echo</span> <span class="s2">"from django.contrib.auth import get_user_model; User = get_user_model(); User.objects.create_superuser('root', 'wizley@github.com', 'alpine')"</span> | python3 <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span>/eatenAway/manage.py shell
</code></pre></div></div>

<p>그 후에 command를 추가하는 방식으로 진행하면 빌드에 성공할 수 있다. 자 이제 다시 명령어를 입력한다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">docker build --tag django:1.0 . ;</span><span class="w"> </span>docker-compose up
<span class="go">
Recreating django_eatenAway ... done
Attaching to django_eatenAway
django_eatenAway | Python 3.8.1 (default, Feb  2 2020, 08:37:37)
django_eatenAway | [GCC 8.3.0] on linux
django_eatenAway | Type "help", "copyright", "credits" or "license" for more information.
</span></code></pre></div></div>

<p>그리고 컨테이너 내부로 접속한다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span><span class="nb">cat </span>shell.sh
<span class="go">docker exec -it django_eatenAway /bin/bash
</span><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span>sh shell.sh
<span class="gp">root@f7aadb20f3c1:/code#</span><span class="w">
</span></code></pre></div></div>

<p>code에 넣어둔 docker-entrypoint.sh 파일을 실행시키게 되면</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@f7aadb20f3c1:/code#</span><span class="w"> </span>sh docker-entrypoint.sh
<span class="go">No changes detected
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying sessions.0001_initial... OK

</span><span class="gp">root@f7aadb20f3c1:/code#</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-al</span>
<span class="go">total 8
drwxr-xr-x 4 root root  128 Feb 26 14:36 .
drwxr-xr-x 1 root root 4096 Feb 26 14:35 ..
-rw-r--r-- 1 root root  319 Feb 26 14:15 docker-entrypoint.sh
drwxr-xr-x 5 root root  160 Feb 26 14:36 eatenAway
</span></code></pre></div></div>

<p>project로 eatenAway가 생성되는 것을 확인할 수 있다. 이제 컴포즈에 윗 부분의 runserver를 추가하면 아래와 같이 up을 통하여 서버를 구동할 수 있다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">Wizley:~/Project/Django/eatenAway #</span><span class="w"> </span>docker-compose up
<span class="go">Recreating django_eatenAway ... done
Attaching to django_eatenAway
django_eatenAway | Watching for file changes with StatReloader
django_eatenAway | Performing system checks...
django_eatenAway |
django_eatenAway | System check identified no issues (0 silenced).
django_eatenAway | February 26, 2020 - 14:37:39
django_eatenAway | Django version 3.0.3, using settings 'eatenAway.settings'
django_eatenAway | Starting development server at http://0:8000/
django_eatenAway | Quit the server with CONTROL-C.
</span></code></pre></div></div>

<p>이제 기본적인 docker 세팅이 끝났다.</p>

<h2 id="django-help">django help</h2>

<p>Django를 python2버전을 사용해서 동아리 신입생 지원사이트를 만들어본 뒤로 건드려본 적이 없기 때문에 가물가물한 기억에 의존해서 개발을 하는 것보다 처음 접한다는 생각으로 공부에 접근하고자 한다. 이에는 아래의 사이트가 많은 도움이 되 줄 것이다.</p>

<p><a href="https://docs.djangoproject.com/en/3.0/">django documentation</a></p>

<h3 id="superuser">superuser</h3>

<p>프레임워크의 help를 보면 어떤 기능이 존재하는지 대략적으로 알아낼 수 있다. 그렇기에 help 명령어를 통해 사용가능한 옵션을 확인해보았다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@50a2c9a1cf4b:/code/eatenAway#</span><span class="w"> </span>python manage.py <span class="nb">help</span>
<span class="go">
</span><span class="gp">Type 'manage.py help &lt;subcommand&gt;</span><span class="s1">' for help on a specific subcommand.
</span><span class="go">
Available subcommands:

[auth]
    changepassword
    createsuperuser

[contenttypes]
    remove_stale_contenttypes

[django]
    check
    compilemessages
    createcachetable
    dbshell
    diffsettings
    dumpdata
    flush
    inspectdb
    loaddata
    makemessages
    makemigrations
    migrate
    sendtestemail
    shell
    showmigrations
    sqlflush
    sqlmigrate
    sqlsequencereset
    squashmigrations
    startapp
    startproject
    test
    testserver

[sessions]
    clearsessions

[staticfiles]
    collectstatic
    findstatic
    runserver
</span></code></pre></div></div>

<p>auth 카테고리는 superuser를 추가하거나 password 변경에 사용하는 것 같고 초기에 docker-entrypoint.sh를 통해 root / alpine이라는 superuser를 생성했었다. localhost:8000/admin/ 페이지에서 해당 정보로 로그인을 시도하여 성공하는 것을 통해 정상적으로 계정이 등록되었음으로 확인할 수 있다.</p>

<p>이제 여기서 하나의 궁금증이 생겼다. 그렇다면 이렇게 등록한 superuser는 어디에 저장이 되는걸까?</p>

<p><a href="https://docs.djangoproject.com/en/3.0/ref/contrib/auth/#django.contrib.auth.models.User.is_superuser">django.contrib.auth</a></p>

<p>django.contrib.auth.models import User 명령어를 통해 User정보를 가져오며 그 내부에 is_superuser라는 값이 존재한다고 한다. 눈으로 직접 있는지 확인을 하기 위해서 찾아 들어가보자.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@50a2c9a1cf4b:/code/eatenAway#</span><span class="w"> </span>python <span class="nt">-m</span> site
<span class="go">sys.path = [
    '/code/eatenAway',
    '/usr/local/lib/python38.zip',
    '/usr/local/lib/python3.8',
    '/usr/local/lib/python3.8/lib-dynload',
    '/usr/local/lib/python3.8/site-packages',
]
USER_BASE: '/root/.local' (doesn't exist)
USER_SITE: '/root/.local/lib/python3.8/site-packages' (doesn't exist)
ENABLE_USER_SITE: True
</span></code></pre></div></div>

<p>python 명령어로 package의 위치를 파악한다. 그리고 내부로 들어가보았다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@50a2c9a1cf4b:/usr/local/lib/python3.8/site-packages/django/contrib/auth#</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">__init__.py  apps.py	   checks.py		    decorators.py  hashers.py  middleware.py  models.py		      templates  validators.py
__pycache__  backends.py   common-passwords.txt.gz  forms.py	   locale      migrations     password_validation.py  tokens.py  views.py
admin.py     base_user.py  context_processors.py    handlers	   management  mixins.py      signals.py	      urls.py
</span></code></pre></div></div>

<p>여기에 models.py가 존재한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">):</span>
    <span class="n">extra_fields</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'is_staff'</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">extra_fields</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'is_superuser'</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">extra_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'is_staff'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Superuser must have is_staff=True.'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extra_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'is_superuser'</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Superuser must have is_superuser=True.'</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_user</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_fields</span><span class="p">)</span>
</code></pre></div></div>

<p>내부에서 create_superuser 부분을 보면 is_superuser라는 field를 설정하는 것을 확인할 수 있다. 그리고 이 값은 어디에 저장되는고 하고 보니 sqlite3의 db안에서 찾을 수 있었다.</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/superuser.png" alt="superuser" /></p>

<p>is_superuser필드가 1인 상태로 저장되어 있다. 이렇게 django에서는 User 인스턴스에 대한 관리를 수행한다는 것을 눈으로 확인할 수 있었다.</p>

<h3 id="stale-contenttype">stale contenttype</h3>

<p>stale contenttype이 먼지 잘 모르겠어서 찾아봤더니 만약 어떤 model이 deleted된 상태일 때 그 모델과 관련된 권한(permission)과 같은 정보들을 stale contenttpye이라고 하는 것 같다. 그래서 해당 명령어를 통해 명시한 더이상 필요하지 않은 정보들을 정리하는 역할을 수행하는 것 같다. 해당 옵션은 optional이기 때문에 이를 위해서는 추가적인 세팅이 필요하다.</p>

<h3 id="check">check</h3>

<p>django-admin check를 통해 실행되는 명령어인데 주로 데이터베이스 변경 등의 상황에서 검사를 위해 사용되는 것 같다.</p>

<h3 id="createcachetable">createcachetable</h3>

<p>데이터베이스 캐시 테이블을 생성할 때 사용하는 명령어인것 같다.</p>

<p><a href="https://orashelter.tistory.com/50">장고 커맨드라인 명령어</a></p>

<p>그 외의 나머지 명령어들에 대한 설명이 해당 블로그에 잘 되어 있어서 대체하도록 하겠다.</p>

<h2 id="django-projectapp">Django project/app</h2>

<h3 id="project">project</h3>

<p>젤 처음에 eatenAway라는 프로젝트를 생성하였었고 그로 인하여 eatenAway라는 새로운 폴더가 생성이 되었다. 현재 시점에서 해당 구조를 확인해보면 아래와 같이 나타나는 것을 확인할 수 있다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@50a2c9a1cf4b:/code#</span><span class="w"> </span>tree eatenAway/
<span class="go">eatenAway/
├── db.sqlite3
├── eatenAway
│   ├── __init__.py
│   ├── __pycache__
│   │   ├── __init__.cpython-38.pyc
│   │   ├── settings.cpython-38.pyc
│   │   ├── urls.cpython-38.pyc
│   │   └── wsgi.cpython-38.pyc
│   ├── asgi.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
└── manage.py

2 directories, 11 files
</span></code></pre></div></div>

<p>장고 프레임워크는 Project과 App으로 구분할 수 있는데 프로젝트는 개발 대상이 되는 통짜의 전체 프로그램을 의미하고 프로젝트 내부의 세부적인 서브 프로그램들을 어플리케이션으로 표현한다고 한다. 즉 각각의 부분을 서브 프로그램인 앱으로 개발을 한 뒤에 프로젝트 레벨에서 통합을 한 모습이 장고라고 할 수 있다.</p>

<p>내부를 보면 asgi.py, settings.py, urls.py wsgi.py가 eatenAway라는 하위 디렉토리 안에 존재하는데 각각은 다음과 같은 역할을 수행한다.</p>

<p>1) asgi.py : ASGI 프로토콜과 연결을 위한 설정 파일
2) settings.py : 프로젝트 설정 파일
3) urls.py : URL패턴을 설정하는 최상위 파일(하위 디렉토리 내에도 urls.py 존재)
4) wsgi.py : 상용 웹 서버와 물리기 위한 설정 파일</p>

<h3 id="app">app</h3>

<p>자 이제 user에 대한 관리를 수행할 앱을 만들어보자. 이름으로 정말 많은 시간 고민을 했는데 걍 user를 쓰기로 하였다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">django-admin startapp user
</span></code></pre></div></div>

<p>이제 tree로 확인을 해보면 아래와 같이 user내부에 여러개의 파일이 생성된 것을 확인할 수 있다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">.
</span><span class="go">├── db.sqlite3
├── eatenAway
│   ├── __init__.py
│   ├── __pycache__
│   │   ├── __init__.cpython-38.pyc
│   │   ├── settings.cpython-38.pyc
│   │   ├── urls.cpython-38.pyc
│   │   └── wsgi.cpython-38.pyc
│   ├── asgi.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── manage.py
└── user
    ├── __init__.py
    ├── admin.py
    ├── apps.py
    ├── migrations
    │   └── __init__.py
    ├── models.py
    ├── tests.py
    └── views.py
</span></code></pre></div></div>

<p>메인 앱과는 다르게 django의 MVT 모델로 활용되는 models.py와 views.py가 추가된 것을 확인할 수 있다.</p>

<h2 id="settingspy">settings.py</h2>

<p>장고의 많은 부분과 연관된 값들이 저장되 있는 settings.py를 보면 DB, language, APP list 그리고 SECRET_KEY 값들이 존재한다. 배포 시에 여러가지를 신경써야겠지만 SECRET_KEY 꼭 고려를 해야되는 부분이다.</p>

<h3 id="secret_key">SECRET_KEY</h3>

<p>장고의 settings.py 부분을 보면 SECRET_KEY가 존재한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># SECURITY WARNING: keep the secret key used in production secret!
</span><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">'78bpynx(+e(1(c-=@_!3-l1@xi)_)v4w=3+n=</span><span class="si">%</span><span class="s">$9=z28-u9inz'</span>
</code></pre></div></div>

<p>아래의 블로그에는 해당 값에 내용이 잘 설명되어 있다.</p>

<p><a href="https://wayhome25.github.io/django/2017/07/11/django-settings-secret-key/">Django - settings.py 의 SECRET_KEY 변경 및 분리하기</a></p>

<p>이 값을 설정하는 방법에는 환경변수와 비밀파일 2가지가 존재하는데 비밀파일 방식을 적용해보고자 한다. json파일을 생성하여 50자리의 임의의 값을 설정한 뒤 해당 값을 가져오도록 코드를 변경하면 된다고 한다.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">root@</span><span class="mi">50</span><span class="err">a</span><span class="mi">2</span><span class="err">c</span><span class="mi">9</span><span class="err">a</span><span class="mi">1</span><span class="err">cf</span><span class="mi">4</span><span class="err">b:/code/eatenAway/eatenAway#</span><span class="w"> </span><span class="err">cat</span><span class="w"> </span><span class="err">secret.json</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"SECRET_KEY"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"wizleywizleywizleywizleywizleywizleywizleywizleysw"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>위와 같이 secret.json으로 SECRET_KEY의 값을 가지고 있는 임의의 파일을 생성하였다. 이제 블로그를 참조해서 SECRET_KEY의 값을 가져오는 코드를 추가하면 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">os</span><span class="p">,</span> <span class="n">json</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>

<span class="c1"># Build paths inside the project like this: os.path.join(BASE_DIR, ...)
</span><span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)))</span>

<span class="c1"># My custom secretKey is in secret.json file
</span><span class="n">secret_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'eatenAway/secret.json'</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">secret_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">get_secretKey</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">secret</span><span class="o">=</span><span class="n">secret</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">secret</span><span class="p">[</span><span class="n">setting</span><span class="p">]</span>
    <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s">"Set the {} environment variable"</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

<span class="c1"># SECURITY WARNING: keep the secret key used in production secret!
</span><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">get_secretKey</span><span class="p">(</span><span class="s">"SECRET_KEY"</span><span class="p">)</span>
</code></pre></div></div>

<p>자 이제 SECRET_KEY를 custom하게 가져오게 되었다. github에 공유할 때 .gitignore를 통해 secret.json 파일을 제외해주면 된다.</p>

<h2 id="user-app-개발">user app 개발</h2>

<p>벌써 3월이다. 저번에 만들어만 뒀던 user 어플리케이션을 구현해보도록 하자. user 앱에서 구현하고자 하는 기능은 크게 다음과 같다.</p>

<ol>
  <li>회원가입/회원탈퇴</li>
  <li>로그인/로그아웃</li>
  <li>아이디/패스워드 찾기 및 변경</li>
  <li>인증기능(이메일)</li>
</ol>

<p>PHP로 구현했었던 게시판에 들어갔었던 기능의 대부분이 해당 범주에 있다. 역시나 django에서도 MVT에 기반하여 개발후에 HelloWorld를 찍는 부분부터 진행을 하도록 하겠다.</p>

<h3 id="helloworld-출력">HelloWorld 출력</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">"HelloWorld from user!"</span><span class="p">)</span>
</code></pre></div></div>

<p>제일 먼저 views.py 부분에 다음과 같이 작성을 한다. 이 index를 호출하기 위해서는 URL 정보를 등록하여야 한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'index'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>위와같이 urlpatterns 정보를 user/urls.py를 생성하여 적어준다. 해당 url 패턴을 타기 위해서는 project의 메인 프로젝트의 urls.py에 해당 정보를 추가해주어야 한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'user/'</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">'user.urls'</span><span class="p">)),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>위와 같이 eatenAway/urls.py에 user를 path로 추가해주었다. 이렇게 되면 main App에서 localhost:8000/user/ 라는 url이 입력이 되면 urlpatterns에서 추가된 부분의 루틴에 따라 user/urls.py 내부의 urlpatterns을 확인하게 된다. 그리고 user/urls.py의 정보에 의하여 / 루트에 대하여 views.py의 index 함수를 호출해준다. 만약 path의 / 부분이 abcd/였다면 localhost:8000/user/abcd/ 를 입력하면 index라는 python 코드가 해석되는 것이다. 이런 URL 디자인 패턴을 ‘우아한 URL 패턴’이라고 한다. 이를 통해 아래와 같이 첫 페이지를 확인할 수가 있다!</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/helloworld.png" alt="helloworld" /></p>

<h3 id="user-account-db-설계">User, Account db 설계</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Database
# https://docs.djangoproject.com/en/3.0/ref/settings/#databases
</span>
<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'default'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">'ENGINE'</span><span class="p">:</span> <span class="s">'django.db.backends.sqlite3'</span><span class="p">,</span>
        <span class="s">'NAME'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'db.sqlite3'</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>settings.py 부분을 보면 위와같이 database 항목이 있다. 그리고 django는 default 옵션으로 sqlite3를 사용한다. 만약 mysql과 같이 다른 db사용을 위해서는 해당 부분을 변경해주어야 한다. 그리고 settings.py의 하위 항목부분에 시간설정 부분이 존재한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s">'en-us'</span>

<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s">'UTC'</span>

<span class="n">USE_I18N</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">USE_L10N</span> <span class="o">=</span> <span class="bp">True</span>

<span class="n">USE_TZ</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></div></div>

<p>한국 시간을 사용하기 위해서 아래와 같이 변경해주었다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s">'en-us'</span>

<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s">'Asia/Seoul'</span>
</code></pre></div></div>

<p>자 이번에는 models.py를 수정하여 database와 관련된 필드에 대한 구성을 해보도록 하겠다. 제일 먼저 해야될 것이 사용자에 대한 db정보를 생성하는 것이다. 그렇다면 user를 관리하기 위해서는 어떤 값들이 필요할까를 고민해볼 차례이다. 생각나는 것들을 적어보면 다음과 같다.</p>

<ol>
  <li>이름</li>
  <li>생일</li>
  <li>성별</li>
  <li>가입 날짜</li>
  <li>id</li>
  <li>password</li>
  <li>email address</li>
  <li>user_no(primary key)</li>
  <li>계정 상태(active 여부)</li>
</ol>

<p>자 이제 위의 정보를 토대로 사용자로부터 입력을 받을 정보를 추려보면 다음과 같다.</p>

<p>개인정보</p>
<ol>
  <li>이름</li>
  <li>생일</li>
  <li>성별</li>
</ol>

<p>계정정보</p>
<ol>
  <li>id</li>
  <li>password</li>
  <li>email address</li>
</ol>

<p>위의 정보들을 종합하여 내가 처음으로 설계한 models.py의 모습은 다음과 같다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">birth</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">sex_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'M'</span><span class="p">,</span> <span class="s">'남성'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'W'</span><span class="p">,</span> <span class="s">'여성'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sex</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">sex_selection</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user_info</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">User</span><span class="p">,</span>
        <span class="n">on_delete</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">"개인정보"</span>
    <span class="p">)</span>
    <span class="n">account_no</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'ID'</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'이메일'</span><span class="p">)</span>
    <span class="n">created_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">"가입날짜"</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">"코멘트"</span><span class="p">)</span>
    <span class="n">account_status_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'O'</span><span class="p">,</span> <span class="s">'정상'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'X'</span><span class="p">,</span> <span class="s">'삭제'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'B'</span><span class="p">,</span> <span class="s">'정지'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">account_status_selection</span><span class="p">)</span>
</code></pre></div></div>

<p>자 이제 확인을 위해서 settings.py에 user app을 추가하도록 한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s">'user'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div>

<p>자 이제 makemigrations를 사용하여 db를 생성한다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@50a2c9a1cf4b:/code/eatenAway#</span><span class="w"> </span>python manage.py makemigrations user
<span class="go">Migrations for 'user':
  user/migrations/0001_initial.py
    - Create model User
    - Create model Account
</span></code></pre></div></div>

<p>models.py에서 적용한 변경사항이나 추가된 혹은 삭제된 사항들을 감지하여 파일로 생성하는 단계가 makemigrations가 되는 것이다. 그리고 migrate의 경우 적용되지 않는 migrations 값들을 적용시키는 역할을 하기 때문에 해당 명령어도 아래와 같이 실행시키면 적용이 된다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@50a2c9a1cf4b:/code/eatenAway#</span><span class="w"> </span>python manage.py migrate
<span class="go">Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, user
Running migrations:
  Applying user.0001_initial... OK
</span></code></pre></div></div>

<p>자 이제 admin 페이지에 두 model을 추가해보자. 이를 위해서는 user/admin.py에 아래와 같이 정보를 추가해주어야 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">User</span><span class="p">,</span> <span class="n">Account</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span>
</code></pre></div></div>

<p>이제 localhost:8000/admin/ 에 superuser로 접속하면 정보가 추가된 것을 확인할 수 있다!</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/admin_add.png" alt="admin_add" /></p>

<p>이제 제대로 추가가 되었는지 확인을 할겸 렌더링해보도록 하겠다. 이 과정에서 manage.py shell을 통해 정보를 추가할 수도 있는데 나의 경우 admin 페이지를 통해 추가하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'index'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'user/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">getuser</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'getuser'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>가장 먼저 user/라는 sub url을 user/urls.py에 추가하였다. 이제 /user/user로 접속하면 뿌려줄 값을 views.py 부분에 추가하면 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">"HelloWorld from user!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getuser</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">account_info</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'account_no'</span><span class="p">)</span>
    <span class="n">user_info</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">account_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user_info_id</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">chain</span><span class="p">(</span><span class="n">account_info</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">user_info</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></div>

<p>여러 삽질을 통해 위와 같은 코드를 작성하였다. QuerySet으로 결과값을 받아오는데 해당 값에 대한 filter 및 order_by등을 통한 가공이 가능하다. 다른 모델에서 나온 두 쿼리셋을 어떻게 하면 합칠까에 대해서 삽질을 많이했는데 itertools를 사용하여 두 값을 체인하면 아래와 같은 결과를 가져올 수 있다.</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/queryset.png" alt="queryset" /></p>

<p>여러 사용법은 아래의 링크를 참고하면 될듯하다.</p>

<p><a href="https://ssungkang.tistory.com/entry/Django-데이터베이스-조회-queryset">django querySet</a></p>

<p>이제 templates에 연동을 해보자. 이를 위해 user 하위에 templates/index.html을 생성하였고 아래와 같이 작성하였다.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="nt">&lt;p&gt;</span>No User.<span class="nt">&lt;/p&gt;</span>

</code></pre></div></div>

<p>그리고 해당 부분을 views.py와 연동하는 작업을 위해 아래와 같이 수정하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">"HelloWorld from user!"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getuser</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">account_info</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'account_no'</span><span class="p">)</span>
    <span class="n">user_info</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">account_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user_info_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'index.html'</span><span class="p">,{</span><span class="s">'user_info'</span> <span class="p">:</span> <span class="n">account_info</span><span class="p">})</span>
</code></pre></div></div>

<p>render가 index.html에 user_info라는 객체의 정보로 account_info를 넘겨주게 되면 해당 부분을 html이 뿌려주는 것이다. 결과를 확인해보면 아래와 같이 내용이 출력되는 것을 확인할 수 있다.</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/template_user.png" alt="template_user" /></p>

<p>이제 간단한 MVT 모델에 대한 학습을 끝냈다.</p>

<p>지금 시점에서 막상 Models을 ForeignKey로 설계를 하니 초보자인 나에게 사용하기가 여간 불편한게 아니었다. 그래서 해당 부분을 하나로 통합하기로 하였다. 그래서 다음과 같이 다시 구조를 변경하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>

<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">account_no</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'이름'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'Chihiro'</span><span class="p">)</span>
    <span class="n">birth</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'지역'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'Seoul'</span><span class="p">)</span>
    <span class="n">sex_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'M'</span><span class="p">,</span> <span class="s">'남성'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'W'</span><span class="p">,</span> <span class="s">'여성'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sex</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">sex_selection</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'W'</span><span class="p">)</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'ID'</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'이메일'</span><span class="p">)</span>
    <span class="n">created_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">"가입날짜"</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">"코멘트"</span><span class="p">)</span>

    <span class="n">account_status_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'O'</span><span class="p">,</span> <span class="s">'정상'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'X'</span><span class="p">,</span> <span class="s">'삭제'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'B'</span><span class="p">,</span> <span class="s">'정지'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">account_status_selection</span><span class="p">)</span>
</code></pre></div></div>

<p>이제 위와 같이 DB를 수정하게 되면 기존의 ForeignField 값인 name, birth, area 그리고 sex에 대한 설정값이 사라지기 때문에 그게 대한 default를 세팅해주어야 된다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@50a2c9a1cf4b:/code/eatenAway#</span><span class="w"> </span>python manage.py makemigrations
<span class="gp">You are trying to add a non-nullable field 'sex' to account without a default;</span><span class="w"> </span>we can<span class="s1">'t do that (the database needs something to populate existing rows).
</span><span class="go">Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
 2) Quit, and let me add a default in models.py
Select an option: 2
</span></code></pre></div></div>

<p>만약 default 또는 null=true가 없을 경우에 위와 같은 문제가 발생한다. 이제 수정한 뒤에 아까와 같이 명령을 실행해주면 된다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@50a2c9a1cf4b:/code/eatenAway#</span><span class="w"> </span>python manage.py makemigrations
<span class="go">Migrations for 'user':
  user/migrations/0002_auto_20200303_1905.py
    - Remove field user_info from account
    - Add field area to account
    - Add field birth to account
    - Add field name to account
    - Add field sex to account
    - Delete model User
</span><span class="gp">root@50a2c9a1cf4b:/code/eatenAway#</span><span class="w"> </span>python manage.py migrate
<span class="go">Operations to perform:
  Apply all migrations: admin, auth, contenttypes, sessions, user
Running migrations:
  Applying user.0002_auto_20200303_1905... OK
</span></code></pre></div></div>

<p>Default 옵션으로 설정한 값들은 생각을 해보니 딱히 없앨 필요가 없을 것 같아서 필요해지기 전까지는 저대로 두기로 하였다. 이제 모델을 작성했으니 templates을 연결하여 회원가입을 짤 차례이다.</p>

<h3 id="템플릿">템플릿</h3>

<p>동아리 후배로부터 HTML 템플릿을 추천받았기에 해당 템플릿을 사용하도록 하겠다. 템플릿을 사용할 때는 꼭!! 라이센스를 확인해야된다.</p>

<p><a href="https://html5up.net/story">story</a></p>

<p>사실은 밑에 있는 템플릿을 사용하려다가 도저히 프론트쪽이 이해가 안되서 바꿨다 ㅎㅎ..</p>

<p><a href="https://colorlib.com/wp/template/burger/">burger template</a></p>

<p>다행히 해당 템플릿의 라이센스는  CC BY 3.0 였다. footer만 남기고는 마음껏 사용해도 될 것 같다.</p>

<p><a href="https://creativecommons.org/licenses/by/3.0/deed.ko">CC 3.0</a></p>

<h3 id="회원가입-페이지-만들기">회원가입 페이지 만들기</h3>

<p>admin 페이지를 통해 Account 정보를 손쉽게 확인이 가능하다. 이 점을 활용하여 회원가입 페이지를 작성해보도록 하겠다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'index'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'user/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">getuser</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'getuser'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'signup/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">signup</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'signup'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>이제 URL을 수정한 뒤 signup에 해당하는 골격을 짠다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">getuser</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'signup.html'</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></div>

<p>이제 templates을 signup.html로 넣어줬는데 CSS가 정상적으로 로드되지 않았다.</p>

<p><a href="https://m.blog.naver.com/shino1025/221320924962">django css 설정</a></p>

<p>django에서는 static에 css/js등의 값을 넣어서 관리한다고 하는데 이를 위해서 위의 링크를 따라 작성하였다. 간단하게 요약해놓자면 settings.py에 경로에 대한 정보를 아래와 같이 입력한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s">'/static/'</span>
<span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s">'static'</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div></div>

<p>그 후 user/static 아래에 파일들을 옮긴 후 아래와 같이 html 템플릿에 load static 및 static을 붙힌 경로로 바꿔주면 된다.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">&lt;!doctype html&gt;</span>
{% load static %}
<span class="nt">&lt;html</span> <span class="na">class=</span><span class="s">"no-js"</span> <span class="na">lang=</span><span class="s">"zxx"</span><span class="nt">&gt;</span>

<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"x-ua-compatible"</span> <span class="na">content=</span><span class="s">"ie=edge"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;title&gt;</span>Burger<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">""</span><span class="nt">&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="nt">&gt;</span>

  <span class="c">&lt;!-- &lt;link rel="manifest" href="site.webmanifest"&gt; --&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"shortcut icon"</span> <span class="na">type=</span><span class="s">"image/x-icon"</span> <span class="na">href=</span><span class="s">"{% static 'img/favicon.png' %}"</span><span class="nt">&gt;</span>

</code></pre></div></div>

<p>이 시점에서 느낀건데 HTML을 이쁘게 만들면서 하기에는 프론트를 1도 모르기 때문에 거의 불가능에 가깝다고 보았다. 그래서 볼만한 수준의 정도만 만들고 넘어가는 방식으로 진행을 해야할 것 같다. (html에 대한 부분의 코드는 생략한다.)</p>

<h3 id="recaptcha">recaptcha</h3>

<p>로봇이 아닙니다를 위해서 recaptcha를 추가해주기 위해서 아래의 링크를 참조하였다.</p>

<p><a href="https://wikidocs.net/10378">recaptcha 등록절차</a></p>

<p>여기서 submit action이 수행시에 캡차 여부를 확인하기 위한 스크립트를 추가로 작성하였다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">var</span> <span class="nx">check</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">password</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">==</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">password2</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">green</span><span class="dl">'</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">패스워드가 일치합니다.</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">color</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">red</span><span class="dl">'</span><span class="p">;</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">패스워드가 올바르지 않습니다.</span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nx">checkRecap</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">grecaptcha</span><span class="p">.</span><span class="nx">getResponse</span><span class="p">();</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
      <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">캡차를 확인하세요</span><span class="dl">'</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>위의 코드의 checkRecap은 아래의 사이트에서 가져왔다.</p>

<p><a href="https://galid1.tistory.com/337">recaptcha 스크립트</a></p>

<p>여러 사이트에서 invisible의 형식으로 button에 캡차를 넣기도 하던데 실습을 하는데 잘 안되서 지금처럼 checkRecap을 onsubmit에서 거치도록 구현하였다.</p>

<p>이 시점에서 회원가입 폼을 받는 페이지에서의 HTML의 구현은 다 되었고 아이디와 이메일 사용여부를 확인해주는 부분을 구현해야 된다.</p>

<h3 id="rest-framework-도입">rest framework 도입</h3>

<p>회원가입 부분에서 아이디/이메일 중복 체크 및 회원가입 버튼을 클릭한 경우에 REST api로 처리가 되면 어떨가라는 고민을 하게 되었고 이 부분에 도입을 해보기로 하였다. 이를 위해서 django-rest-auth를 추가적으로 설치를 해주었다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@b099b068dc26:/code#</span><span class="w"> </span>pip <span class="nb">install </span>django-rest-auth django-rest-authtoken
<span class="gp">root@b099b068dc26:/code#</span><span class="w"> </span>pip list
<span class="go">Package                 Version
----------------------- -------
asgiref                 3.2.3
attrs                   19.3.0
coverage                5.0.3
Django                  3.0.3
django-cors-headers     3.2.1
django-rest-auth        0.9.5
django-rest-authtoken   1.2.4
djangorestframework     3.11.0
djangorestframework-jwt 1.11.0
more-itertools          8.2.0
packaging               20.1
pip                     20.0.2
pluggy                  0.13.1
py                      1.8.1
PyJWT                   1.7.1
pyparsing               2.4.6
pytest                  5.3.5
pytest-cov              2.8.1
pytz                    2019.3
setuptools              45.1.0
six                     1.14.0
sqlparse                0.3.0
wcwidth                 0.1.8
wheel                   0.34.2
</span></code></pre></div></div>

<p>이제 settings.py 부분에서 INSTALLED_APP에 rest와 관련된 모듈들을 추가해주어야 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s">'rest_framework'</span><span class="p">,</span>
    <span class="s">'rest_framework.authtoken'</span><span class="p">,</span>
    <span class="s">'rest_auth'</span><span class="p">,</span>
    <span class="s">'user'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div>

<p>지금부터는 아래의 블로그의 내용을 보면서 공부를 진행하였다.</p>

<p><a href="https://inma.tistory.com/85?category=984128">DRF A-Z</a></p>

<p>이번에는 user app아래에 api/serializers.py를 생성한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">Account</span>


<span class="k">class</span> <span class="nc">AccountSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Account</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">'__all__'</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s">"password"</span><span class="p">:</span> <span class="p">{</span><span class="s">"write_only"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}}</span>
</code></pre></div></div>

<p>다음과 같이 ModelSerializer로 AccountSerializer를 생성한다. password같은 경우 숨겨야 하는 값이기 때문에 extra_kwargs로 write_only로 설정해준다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">viewsets</span>
<span class="kn">from</span> <span class="nn">.api.serializers</span> <span class="kn">import</span> <span class="n">AccountSerializer</span>

<span class="k">class</span> <span class="nc">AccountViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">AccountSerializer</span>

</code></pre></div></div>

<p>views.py 부분에 다음과 같이 AccountViewSet을 추가해준다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">routers</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">router</span> <span class="o">=</span> <span class="n">routers</span><span class="o">.</span><span class="n">DefaultRouter</span><span class="p">()</span>
<span class="n">router</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">'account'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">AccountViewSet</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'user/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">getuser</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'getuser'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'signup/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">signup</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'signup'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">''</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">urls</span><span class="p">))</span>
<span class="p">]</span>
</code></pre></div></div>

<p>그리고 urls.py 부분에 router를 설정해줌으로써 /user/account로 라우팅을 해주게 된다.</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/apiroot.png" alt="apiroot" /></p>

<p>이 시점에서 localhost:8000/user/로 접속을 하면 위와 같은 창을 확인할 수가 있다.</p>

<p>여기서 조금 더하여 id를 검사하여 해당 아이디 값을 찾아주는 query_param은 다음의 방식으로 추가할 수 있다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">AccountViewSet</span><span class="p">(</span><span class="n">viewsets</span><span class="o">.</span><span class="n">ModelViewSet</span><span class="p">):</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">AccountSerializer</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>

        <span class="n">search</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'id'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">search</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qs</span>
</code></pre></div></div>

<p>위와 같이 작성하면 localhost:8000/user/account/?id=wizley와 같이 찾아보면 그에 따른 결과값을 가져올 수 있다.</p>

<h3 id="id--email-중복-검사">ID / email 중복 검사</h3>

<p>이제 이 부분을 아주 긴 삽질의 시간을 지나 다음과 같이 만들었다. rest api를 활용하여 /user/api/check/username or email 의 형식으로 값을 조회하여 사용가능한 경우에 사용됨을 사용불가능한 경우에는 불가능함을 알려주는 코드를 작성하였다. 이 과정에서 id를 username으로 변경하여 migration을 진행하였다.</p>

<p>urls.py는 다음과 같이 수정하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'signup/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">signup</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'signup'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'api/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">AccountList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'api/check/username/&lt;str:username&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">is_username_exist</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'api/check/email/&lt;str:email&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">is_email_exist</span><span class="o">.</span><span class="n">as_view</span><span class="p">())</span>
<span class="p">]</span>

</code></pre></div></div>

<p>그 뒤 serializer 부분에 검증코드를 추가하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AccountSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Account</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">'__all__'</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s">"password"</span><span class="p">:</span> <span class="p">{</span><span class="s">"write_only"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}}</span>

    <span class="k">def</span> <span class="nf">validate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">"이미 사용중인 아이디입니다."</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">"사용가능한 아이디입니다."</span>

    <span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">"해당 이메일은 이미 사용중입니다."</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">"사용가능한 이메일입니다."</span>

    <span class="k">def</span> <span class="nf">validate_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">serializers</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">"패스워드는 최소 </span><span class="si">%</span><span class="s">s자 이상이어야 합니다."</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

</code></pre></div></div>

<p>처리를 위한 코드를 views.py에 추가하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""
id 중복 검사 
/user/api/check/id/&lt;str:id&gt;/
"""</span>
<span class="k">class</span> <span class="nc">is_username_exist</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Account</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"OK"</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ac</span> <span class="o">==</span> <span class="s">"OK"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">"사용가능한 아이디입니다."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AccountSerializer</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">.</span><span class="n">validate_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>

<span class="s">"""
email 중복 검사 
/user/api/check/username/&lt;str:username&gt;/
"""</span>
<span class="k">class</span> <span class="nc">is_email_exist</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Account</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"OK"</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ac</span> <span class="o">==</span> <span class="s">"OK"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">"사용가능한 이메일입니다."</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AccountSerializer</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">.</span><span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</code></pre></div></div>

<p>그리고 해당 부분을 handle하는 확인 코드를 XMLHttpRequest를 활용하여 작성하였다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">function</span> <span class="nx">checkUsername</span><span class="p">(){</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">username</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">){</span>
      <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">아이디를 입력하세요.</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
      <span class="nx">link</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http://localhost:8000/user/api/check/username/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="nx">link</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
      <span class="nx">alert</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">checkEmail</span><span class="p">(){</span>
    <span class="nx">email</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">email</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">regExp</span> <span class="o">=</span> <span class="sr">/^</span><span class="se">[</span><span class="sr">0-9a-zA-Z</span><span class="se">]([</span><span class="sr">-_.</span><span class="se">]?[</span><span class="sr">0-9a-zA-Z</span><span class="se">])</span><span class="sr">*@</span><span class="se">[</span><span class="sr">0-9a-zA-Z</span><span class="se">]([</span><span class="sr">-_.</span><span class="se">]?[</span><span class="sr">0-9a-zA-Z</span><span class="se">])</span><span class="sr">*.</span><span class="se">[</span><span class="sr">a-zA-Z</span><span class="se">]{2,3}</span><span class="sr">$/i</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">regExp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">email</span><span class="p">)){</span>
      <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
      <span class="nx">link</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http://localhost:8000/user/api/check/email/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">email</span><span class="p">;</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span> <span class="nx">link</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
      <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
      <span class="nx">alert</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span><span class="p">{</span>
      <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">잘못된 이메일 형식입니다</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>여기까지 작성이 끝나면 아이디 및 이메일 중복검사 기능이 수행된다. 하지만 형식이 마음에 들지 않아서 약간의 수정을 하도록 하겠다.</p>

<p>먼저 api라는 앱을 추가하여 해당 url과 처리를 관리하는 부분을 user로부터 분리하였다. 그 후 api로 시작하는 경로에 다음과 같이 url pattern을 추가하였다.(정확히 말하면 user -&gt; api로 수정하면서 이전하였다.)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'accounts/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">AccountList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'accounts/verify/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">verifyExistence</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'accounts/verify/&lt;str:username&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">verifyExistence</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>verify는 세분화적으로 2개로 나뉘는데 verify그 자체는 GET 메소드를 받아서 id의 중복검사를 수행하는 루틴을 수행할 것이고 POST로 데이터를 받으면 email의 중복검사를 처리하도록 수정하였다. 그에 따라 serializer는 다음과 같다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>
<span class="kn">from</span> <span class="nn">user.models</span> <span class="kn">import</span> <span class="n">Account</span>


<span class="k">class</span> <span class="nc">AccountSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Account</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s">'__all__'</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s">"password"</span><span class="p">:</span> <span class="p">{</span><span class="s">"write_only"</span><span class="p">:</span> <span class="bp">True</span><span class="p">}}</span>

    <span class="k">def</span> <span class="nf">validate_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">validate_email</span><span class="p">(</span><span class="n">selfself</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
</code></pre></div></div>

<p>각각에 대해서 존재하는지에 대한 여부를 검사하는 코드를 시리얼라이저 내부에 넣어두었다. 해당 기능들은 form 데이터를 검증하여 유저를 생성하는 과정에서도 사용되기 때문에 해당 위치에 분리해두었다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">user.forms</span> <span class="kn">import</span> <span class="n">AccountForm</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">rest_framework.response</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">rest_framework.views</span> <span class="kn">import</span> <span class="n">APIView</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">AccountSerializer</span>
<span class="kn">from</span> <span class="nn">user.models</span> <span class="kn">import</span> <span class="n">Account</span>

<span class="k">class</span> <span class="nc">AccountList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">queryset</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">all</span><span class="p">()</span>
        <span class="n">serializer</span> <span class="o">=</span> <span class="n">AccountSerializer</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">serializer</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'DEBUG email : '</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>

<span class="s">"""
id 중복 검사 : 
GET /api/account/verify/&lt;str:id&gt;/

email 중복 검사 : 
POST /api/account/verify/
"""</span>
<span class="k">class</span> <span class="nc">verifyExistence</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">getObject_with_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Account</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"OK"</span>

    <span class="k">def</span> <span class="nf">getObject_with_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Account</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">"OK"</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObject_with_username</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ac</span> <span class="o">==</span> <span class="s">"OK"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">"사용가능한 아이디입니다."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AccountSerializer</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">.</span><span class="n">validate_username</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">"사용가능한 아이디입니다."</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Http404</span>


    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getObject_with_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ac</span> <span class="o">==</span> <span class="s">"OK"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">"사용가능한 이메일입니다."</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">AccountSerializer</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">.</span><span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">"사용가능한 이메입니다."</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Http404</span>

</code></pre></div></div>

<p>views.py의 경우 verifyExistence라는 클래스가 궁극적으로 id/email의 중복검사를 수행해주는데 get과 post가 각각 id와 email에 대한 정보를 넘겨받는다. 그리고 시리얼라이저 내부의 검증코드루틴의 결과에 따라 리턴을 수행한다.</p>

<p>POST의 경우 csrf_token에 대한 정보가 없으면 forbidden이 발생하기 때문에 해당 부분에 대한 처리가 필요했다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">checkEmail</span><span class="p">(){</span>
  <span class="nx">email</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">email</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">csrf_token</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">[name=csrfmiddlewaretoken]</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">regExp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">email</span><span class="p">)){</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
          <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:8000/api/accounts/verify/</span><span class="dl">'</span><span class="p">,</span>
          <span class="na">data</span> <span class="p">:</span> <span class="p">{</span>
              <span class="na">email</span><span class="p">:</span> <span class="nx">email</span><span class="p">,</span>
              <span class="na">csrfmiddlewaretoken</span><span class="p">:</span> <span class="nx">csrf_token</span><span class="p">,</span>
          <span class="p">},</span>
          <span class="na">error</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">error</span><span class="p">){</span>
              <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">이미 사용중인 이메일입니다.</span><span class="dl">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="p">},</span>
          <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span>
            <span class="nx">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">사용가능한 이메일입니다.</span><span class="dl">"</span><span class="p">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
          <span class="p">},</span>
      <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="p">{</span>
    <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">잘못된 이메일 형식입니다</span><span class="dl">'</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>이를 위해서 ajax를 통해 POST 데이터를 전송할 때 csrf_token에 대한 값을 같이 날려주어야 된다. email과 csrfmiddlewaretoken을 같이 전송을 해주게 되면 그 결과가 error인지 success인지에 따라 분기를 다르게 탐으로써 조건문의 수행이 된다.</p>

<p>마지막으로 javascript코드를 static/js/signup.js로 분리하는 것으로 id/email 검증에 대한 구현이 마무리되었다.</p>

<h3 id="회원가입-구현">회원가입 구현</h3>

<p>회원가입의 경우에도 REST로 처리해야되는데 내가 그리는 로직상 이동하는 페이지와 API 서버는 다르기 때문에 ajax로 POST를 쏘는 방식으로 구현을 진행하였다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">lastCheck</span><span class="p">(){</span>
  <span class="nx">id</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">username</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">){</span>
    <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">아이디를 다시 확인해주세요.</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">password</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span> <span class="o">!=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">password2</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">){</span>
    <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">패스워드를 다시 확인해주세요.</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">password</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">){</span>
    <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">패스워드 최소길이는 8글자입니다.</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">email</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">email</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">regExp</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">email</span><span class="p">))){</span>
    <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">이메일을 다시 확인해주세요.</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">checkRecap</span><span class="p">()){</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">tryRes</span><span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">queryString</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">form[name=registerForm]</span><span class="dl">"</span><span class="p">).</span><span class="nx">serialize</span><span class="p">();</span>

        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
            <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">http://localhost:8000/api/accounts/</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">data</span> <span class="p">:</span> <span class="nx">queryString</span><span class="p">,</span>
            <span class="na">dataType</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">async</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="na">error</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">error</span><span class="p">){</span>
                <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">정보를 다시 확인해주세요.</span><span class="dl">'</span><span class="p">);</span>
                <span class="nx">grecaptcha</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
                <span class="nx">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
            <span class="p">},</span>
            <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">){</span>
                <span class="nx">alert</span><span class="p">(</span><span class="dl">'</span><span class="s1">회원가입 신청이 완료되었습니다.</span><span class="dl">'</span><span class="p">);</span>
                <span class="nx">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">},</span>
        <span class="p">});</span>

        <span class="k">return</span> <span class="nx">flag</span><span class="p">;</span>
       <span class="p">}</span>

       <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">tryRes</span><span class="p">();</span>
       <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>폼이 전송되는 obSubmit 시점에서 해당 함수가 호출이되는데 javascript단에서 한번 form 데이터를 검증한다. 그 후 tryRes라는 함수가 REST api로 POST를 쏘게 되는데 그 값의 여부에 따라서 flag값이 설정이 된다. 처음에는 함수로 진행하여 res로 값을 빼지 않았을 경우에 ajax의 response가 돌아오기 까지의 시간이 느리기 때문에 아래의 flow가 실행되는 문제가 있어서 res에 남아두고 해당 값을 return 하는 방식을 사용하였다.</p>

<p>해당 REST를 컨트롤 하기 위해서 urls.py는 다음과 같이 추가되었다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'accounts/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">AccountList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'accounts/verify/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">verifyExistence</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'accounts/verify/&lt;str:username&gt;/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">verifyExistence</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>

</code></pre></div></div>

<p>AccountList라는 Class는 유저의 계정을 생성/조회/삭제/최신화하는 역할을 위해서 개설되었고 지금은 post에 대한 값만 처리를 진행한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AccountList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'HelloWorld'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">form_data</span> <span class="o">=</span> <span class="n">AccountForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkRecaptcha</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'g-recaptcha-response'</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">"fail."</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form_data</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="n">verifyExistence</span><span class="p">();</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">verifyExistence</span><span class="o">.</span><span class="n">getObject_with_username</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'username'</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">AccountSerializer</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">.</span><span class="n">validate_username</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'username'</span><span class="p">]):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'fail.'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

            <span class="n">ac</span> <span class="o">=</span> <span class="n">verifyExistence</span><span class="o">.</span><span class="n">getObject_with_email</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">form_data</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'email'</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">AccountSerializer</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span><span class="o">.</span><span class="n">validate_email</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'fail.'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

            <span class="n">new_account</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">new_account</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'password'</span><span class="p">])</span>
            <span class="n">new_account</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'success.'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'fail.'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div></div>

<p>리턴값은 2가지로 나뉜다. 실패했을 경우 400_BAD_REQUEST를 리턴하고 성공할 경우에만 201_CREATED를 리턴해준다. 그리고 그 과정에서 form_data와 비교하여 값이 제대로 POST 데이터로 들어왔는지 검증을 해준 뒤, id/email 검증을 수행한다. 그 후 new_account로 form_data를 넘겨준뒤 save를 진행한다. 이 과정에서 평문으로 저장되는 password를 해쉬화 하기 위해서 set_password 패스워드를 사용하고 싶었기에 user/models.py를 다음과 같이 변경하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AbstractBaseUser</span>

<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">AbstractBaseUser</span><span class="p">):</span>
    <span class="n">account_no</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'이름'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'Chihiro'</span><span class="p">)</span>
    <span class="n">birth</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'지역'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'Seoul'</span><span class="p">)</span>
    <span class="n">sex_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'M'</span><span class="p">,</span> <span class="s">'남성'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'W'</span><span class="p">,</span> <span class="s">'여성'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sex</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">sex_selection</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'W'</span><span class="p">)</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'아이디'</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'패스워드'</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'이메일'</span><span class="p">)</span>
    <span class="n">created_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">"가입날짜"</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">"코멘트"</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s">"user_profile/profile_picture"</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">account_status_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'O'</span><span class="p">,</span> <span class="s">'정상'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'X'</span><span class="p">,</span> <span class="s">'삭제'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'B'</span><span class="p">,</span> <span class="s">'정지'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'W'</span><span class="p">,</span> <span class="s">'검증'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">account_status_selection</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"W"</span><span class="p">)</span>

    <span class="n">USERNAME_FIELD</span> <span class="o">=</span> <span class="s">'username'</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>
</code></pre></div></div>

<p>AbstractBaseUser를 상속받는 방식으로 set_password와 같이 기본 메소드를 상속받는게 가능하다. 그리고 이 경우에 USERNAME_FIELD를 명시를 해줘야 한다.</p>

<p>위와 같이 구현을 하면 회원가입에 대한 처리가 /api/account URL을 통해 POST로 처리가 된다.</p>

<h3 id="이메일-인증-구현">이메일 인증 구현</h3>

<p>이메일 인증의 경우 아래의 사이트에 기본적인 사용방법이 적혀있다.</p>

<p><a href="https://inma.tistory.com/116">회원가입 인증메일 보내기</a></p>

<p>settings.py에 EMAIL 전송과 관련된 값들을 적어준다. 물론 중요한 아이디/패스워드 정보는 secrets.json 파일에 빼놓고 가져오는 방식을 사용한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Google SMTP
</span><span class="n">EMAIL_BACKEND</span> <span class="o">=</span> <span class="s">'django.core.mail.backends.smtp.EmailBackend'</span>
<span class="n">EMAIL_HOST</span> <span class="o">=</span> <span class="s">'smtp.gmail.com'</span>
<span class="n">EMAIL_HOST_USER</span> <span class="o">=</span> <span class="n">get_secretKey</span><span class="p">(</span><span class="s">"EMAIL_HOST_USER"</span><span class="p">)</span>
<span class="n">EMAIL_HOST_PASSWORD</span> <span class="o">=</span> <span class="n">get_secretKey</span><span class="p">(</span><span class="s">"EMAIL_HOST_PASSWORD"</span><span class="p">)</span>
<span class="n">EMAIL_PORT</span> <span class="o">=</span> <span class="mi">587</span>
<span class="n">EMAIL_USE_TLS</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">DEFAULT_FROM_EMAIL</span> <span class="o">=</span> <span class="n">EMAIL_HOST_USER</span>
</code></pre></div></div>

<p>토큰을 만드는 과정에 대한 코드는 api/views.py의 아이디 정보를 만든 뒤 생성한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            <span class="n">new_account</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">new_account</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'password'</span><span class="p">])</span>
            <span class="n">new_account</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">user</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">form_data</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'username'</span><span class="p">])</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s">'activate.html'</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">'domain'</span><span class="p">:</span> <span class="s">'localhost:8000'</span><span class="p">,</span>
                <span class="s">'user'</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                <span class="s">'uid'</span><span class="p">:</span> <span class="n">urlsafe_base64_encode</span><span class="p">(</span><span class="n">force_bytes</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)),</span>
                <span class="s">'token'</span><span class="p">:</span> <span class="n">account_activation_token</span><span class="o">.</span><span class="n">make_token</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="p">})</span>

            <span class="n">mail_subject</span> <span class="o">=</span> <span class="s">'eaten-Away 이메일 인증'</span>
            <span class="n">to_email</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">'email'</span><span class="p">]</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="n">mail_subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="p">[</span><span class="n">to_email</span><span class="p">])</span>
            <span class="n">email</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
</code></pre></div></div>

<p>여기서 new_account로 인하여 새로운 Account 정보가 DB에 저장이 되고 난 뒤 user로 해당 계정에 대한 정보를 가져와 message를 만들어 activate.html에 파싱해준다. 이 과정에서 account_activation_token.make_token에 의하여 토큰에 대한 정보가 메일에 남게된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib.auth.tokens</span> <span class="kn">import</span> <span class="n">PasswordResetTokenGenerator</span>
<span class="kn">import</span> <span class="nn">six</span>


<span class="k">class</span> <span class="nc">AccountActivationTokenGenerator</span><span class="p">(</span><span class="n">PasswordResetTokenGenerator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_make_hash_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
                <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="o">+</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="p">)</span>

<span class="n">account_activation_token</span> <span class="o">=</span> <span class="n">AccountActivationTokenGenerator</span><span class="p">()</span>
</code></pre></div></div>

<p>token의 경우 다음과 같이 Account의 pk정보와 timestamp 정보를 토대로 해쉬화 한다.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
{% load static %}
{% load i18n %}
{% blocktrans %}
{{ user.username }} 님, 아래의 링크를 클릭하여 회원가입을 완료해주세요.
{% endblocktrans %}
http://{{ domain }}{% url 'activate' uidb64=uid token=token %}

</code></pre></div></div>

<p>template의 경우 email로 전송되는 값을 가지고 있는데 여기서 domain, url, uid, token의 값이 링크화 되게 된다. 그리고 이 값들은 윗 부분의 render_to_string 부분의 값을 통해 결정이 된다. 이를 통해 사용자가 회원가입을 신청하게 되면 hash된 link가 가입한 이메일 주소로 전송이 되게 된다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizley님, 아래의 링크를 클릭하여 회원가입을 완료해주세요.

http://localhost:8000/api/activate/NDk/5ek-d54078f9b30b418cacf4
</code></pre></div></div>

<p>그럼 위와 같이 링크가 형성이 되고 누르게 되면 사용자 계정이 활성화 상태가 된다. 이제 해당 부분을 처리하기 위한 url 등록이 필요하다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">path</span><span class="p">(</span><span class="s">'activate/&lt;str:uidb64&gt;/&lt;str:token&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">EmailActivate</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">'activate'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EmailActivate</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">AllowAny</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">uidb64</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="n">force_text</span><span class="p">(</span><span class="n">urlsafe_base64_decode</span><span class="p">(</span><span class="n">uidb64</span><span class="p">))</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">uid</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">account_activation_token</span><span class="o">.</span><span class="n">check_token</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
                <span class="n">user</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">'O'</span>
                <span class="n">user</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'emailverifysuccess.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'result'</span><span class="p">:</span><span class="bp">True</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'emailverifysuccess.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'result'</span><span class="p">:</span><span class="bp">False</span><span class="p">})</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'emailverifysuccess.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'result'</span><span class="p">:</span><span class="bp">False</span><span class="p">})</span>
</code></pre></div></div>

<p>이제 링크에 접속이 되면 get으로 들어오는 데이터에 대해 검증을 한뒤 result의 결과에 따라 emailverifysuccess.html을 렌더하게 된다. 그 과정에서 user.status와 user.active에 대한 값이 설정이 된다.</p>

<h3 id="rest_framework의-편의성을-위한-user-model-변경">rest_framework의 편의성을 위한 User model 변경</h3>

<p>로그인에서 토큰방식을 사용하기 위해 고민을 하던 와중에 rest_framework의 jwt 또는 auth_token이 눈에 들어왔다. 여러 앱에 대하여 모의해킹을 하는 과정에서 많이들 사용하는 것 같았기 때문이다. 하지만 구현을 하던 중 하나의 문제를 마주하였다. 해당 값들은 BASE USER 모델에 대해서 지원을 해주기 때문에 내가 임의로 만든 Account라는 커스텀 모델에 적용이 안되는 것이다. 결국 여러모로 고민을 해보다가 많은 개발자들이 User를 사용하기 때문에 나 또한 userModel을 변경하기로 마음먹었다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">AbstractBaseUser</span><span class="p">,</span> <span class="n">BaseUserManager</span>


<span class="k">class</span> <span class="nc">AccountManager</span><span class="p">(</span><span class="n">BaseUserManager</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Account must have an username'</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span> <span class="nf">create_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
            <span class="n">username</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>


<span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">AbstractBaseUser</span><span class="p">):</span>
    <span class="n">account_no</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'이름'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'Chihiro'</span><span class="p">)</span>
    <span class="n">birth</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'생일'</span><span class="p">)</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'지역'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'Seoul'</span><span class="p">)</span>
    <span class="n">sex_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'M'</span><span class="p">,</span> <span class="s">'남성'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'W'</span><span class="p">,</span> <span class="s">'여성'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">sex</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'성별'</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">sex_selection</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'W'</span><span class="p">)</span>

    <span class="n">username</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'아이디'</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'패스워드'</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'이메일'</span><span class="p">)</span>
    <span class="n">created_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">"가입날짜"</span><span class="p">)</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'코멘트'</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s">"user_profile/profile_picture"</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'프로필'</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">account_status_selection</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">'O'</span><span class="p">,</span> <span class="s">'정상'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'X'</span><span class="p">,</span> <span class="s">'삭제'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'B'</span><span class="p">,</span> <span class="s">'정지'</span><span class="p">),</span>
        <span class="p">(</span><span class="s">'W'</span><span class="p">,</span> <span class="s">'검증'</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'계정 상태'</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">account_status_selection</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"W"</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">"이메일 인증여부"</span><span class="p">)</span>

    <span class="n">is_active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">is_admin</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">AccountManager</span><span class="p">()</span>

    <span class="n">USERNAME_FIELD</span> <span class="o">=</span> <span class="s">'username'</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>

    <span class="k">def</span> <span class="nf">has_perm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">has_module_perms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">is_staff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_admin</span>
</code></pre></div></div>

<p>기존의 방식에서 username에 unique옵션을 추가해주었고, AccountManager를 추가하였다. 해당 클래스는 helper와 같은 역할을 한다. 그 뒤 settings.py에 USER_MODEL에 대한 정보를 추가하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># USER MODEL
</span><span class="n">AUTH_USER_MODEL</span> <span class="o">=</span> <span class="s">'user.Account'</span>
</code></pre></div></div>

<p>그 뒤 migrations을 하려고 하는데 제대로 적용이 되지 않았다. 그래서 sqlite를 삭제하였음에도 불구하고 superuser가 이미 존재하기 때문에 작동을 제대로 하지 않는 문제가 발생하였다. 그 경우 아래의 명령어를 통해 해결이 가능하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">migrate</span> <span class="o">--</span><span class="n">run</span><span class="o">-</span><span class="n">syncdb</span>
</code></pre></div></div>

<p>이와 같이 지정을 하고 나면 Account라는 custom model이 장고의 User Model로 설정이 완료된다.</p>

<h3 id="jwt를-활용하여-로그인-구현">jwt를 활용하여 로그인 구현</h3>

<p>Account를 User.model로 설정을 했으니 로그인 부분에 jwt 프레임워크를 사용하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framework_jwt.views</span> <span class="kn">import</span> <span class="n">obtain_jwt_token</span><span class="p">,</span> <span class="n">refresh_jwt_token</span><span class="p">,</span> <span class="n">verify_jwt_token</span><span class="p">,</span> <span class="n">ObtainJSONWebToken</span>

    <span class="n">path</span><span class="p">(</span><span class="s">'token/'</span><span class="p">,</span> <span class="n">obtain_jwt_token</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'token/verify/'</span><span class="p">,</span> <span class="n">verify_jwt_token</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'token/refresh/'</span><span class="p">,</span> <span class="n">refresh_jwt_token</span><span class="p">),</span>
</code></pre></div></div>

<p>먼저 api의 urls.py에 다음의 3가지 경로를 추가한다.</p>

<p>user/views.py 부분에서 로그인을 처리하는 함수는 다음과 같다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">):</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'password'</span><span class="p">]</span>
        <span class="n">recaptcha</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'g-recaptcha-response'</span><span class="p">]</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/accounts/login/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'username'</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s">'password'</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s">'g-recaptcha-response'</span><span class="p">:</span> <span class="n">recaptcha</span><span class="p">})</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'token'</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'login.html'</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'token'</span><span class="p">]</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">'/user/main/'</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s">'token'</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">checkTokenVerification</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">'/user/main'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">'/user/login'</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s">'token'</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'login.html'</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></div>

<p>POST의 형태로 값이 들어올 경우에 /api/accounts/login으로 post요청을 보내게 된다. 그리고 그 결과값으로 token이 돌아올 경우에 token을 cookie에 추가하여 main페이지로 이동하게 된다. 만약 POST가 아닌 형식으로 login 페이지에 들어오게 된 경우 token이 cookie에 존재하는 경우에는 token에 대한 값을 검증한다. 만약 토큰이 정상적인 값이라면 main으로 바로 리다이렉트를 하고 그게 아닌 경우에 token 쿠키를 삭제한 뒤 login 폼을 띄워준다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="s">"""
post : login
delete : logout
"""</span>
<span class="k">class</span> <span class="nc">AccountAuthentication</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BasicAuthentication</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">AllowAny</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">authenticateAccount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">AccountInfo</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">AccountInfo</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">AccountInfo</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">'O'</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkRecaptcha</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'g-recaptcha-response'</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">"fail."</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'password'</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticateAccount</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/token/"</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'username'</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s">'password'</span><span class="p">:</span> <span class="n">password</span><span class="p">})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'token'</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'fail'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'token'</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s">'token'</span><span class="p">:</span> <span class="n">token</span><span class="p">},</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'fail.'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'failed'</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div></div>

<p>api/views.py 부분에서 login을 처리할 때 불리는 루틴은 AccountAuthentication 내부의 post이다. recaptcha를 먼저 검증한 뒤 username, password를 기반으로 사용자 정보와 일치하는지 검사한다. 그 뒤 Account의 정보중에 status가 활성화 상태인 경우에 token을 발급해주는 /api/token으로 발급을 요청한다. 만약 성공적으로 발급된 경우에 token을 return 해주고 그게 아닌경우 400_BAD_REQUEST를 띄우게 된다.</p>

<h2 id="food-app-개발">food app 개발</h2>

<p>이제 음식과 관련된 서비스부분의 개발을 하기 위해서 food라는 이름으로 app을 새로 생성하였다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@b099b068dc26:/code/eatenAway#</span><span class="w"> </span>django-admin startapp food
</code></pre></div></div>

<p>이제 settings.py에 해당 app을 추가한다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span>
    <span class="s">'user'</span><span class="p">,</span>
    <span class="s">'food'</span><span class="p">,</span>
    <span class="s">'api'</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></div></div>

<h3 id="csv-파일로-bulk_create하여-음식정보-한번에-추가하기">csv 파일로 bulk_create하여 음식정보 한번에 추가하기</h3>

<p>먼저 음식에 대한 DB를 생성할 것인데 그 이름을 Food라고 하겠다. 그리고 필드는 다음과 같이 설정하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span> <span class="nc">Food</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">menuname</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'메뉴이름'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'카테고리'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,)</span>
    <span class="n">country</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'나라'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,)</span>
    <span class="n">ingredient</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'재료'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">taste</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'맛'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,)</span>
    <span class="n">stock</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'국물여부'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'설명'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">profile</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="s">"food_profile/profile_picture"</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s">'음식사진'</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">is_active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">verbose_name</span><span class="o">=</span><span class="s">'활성화 여부'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">menuname</span>
</code></pre></div></div>

<p>model에 대해서 설명을 하자면 category는 크게 밥/패스트푸드/면으로 나누었고 ingredient는 고기/해물/야채로 구분하였다. taste의 경우 단맛 ~ 보통 ~ 매운맛인데 주관적인 기준으로 1-3 ~ 4 ~ 5-7로 나누었다. description의 경우 해당 Food에 대한 탭을 표시하기 위한 설명이고 profile은 음식에 대한 사진정보가 들어간다.</p>

<p>이제 excel 파일을 활용하여 menuname, category, country, ingredient, taste, stock에 대한 정보를 csv파일의 형식으로 만들었다. 이제 해당 파일을 읽고 Food Model에 추가하는 코드를 작성한다.</p>

<p>(CSV파일을 읽어서 django 모델을 bulk_create하기)[https://junebuug.github.io/2018-02-19/make-bulk-update-from-csv-django]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">django</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'DJANGO_SETTINGS_MODULE'</span><span class="p">,</span> <span class="s">'eatenAway.settings'</span><span class="p">)</span>

<span class="n">django</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>

<span class="kn">from</span> <span class="nn">food.models</span> <span class="kn">import</span> <span class="n">Food</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">'FoodList.csv'</span><span class="p">,</span> <span class="s">'r'</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">)</span>
<span class="n">info</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">rdr</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rdr</span><span class="p">:</span>
    <span class="n">menuname</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">ingredient</span><span class="p">,</span> <span class="n">taste</span><span class="p">,</span> <span class="n">stock</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">row</span>
    <span class="k">if</span> <span class="n">stock</span> <span class="o">==</span> <span class="s">'TRUE'</span><span class="p">:</span>
        <span class="n">stock</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stock</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">menuname</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">ingredient</span><span class="p">,</span> <span class="n">taste</span><span class="p">,</span> <span class="n">stock</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>

<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">instances</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">menuname</span><span class="p">,</span> <span class="n">category</span><span class="p">,</span> <span class="n">country</span><span class="p">,</span> <span class="n">ingredient</span><span class="p">,</span> <span class="n">taste</span><span class="p">,</span> <span class="n">stock</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
    <span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Food</span><span class="p">(</span><span class="n">menuname</span><span class="o">=</span><span class="n">menuname</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="n">country</span><span class="p">,</span> <span class="n">ingredient</span><span class="o">=</span><span class="n">ingredient</span><span class="p">,</span> <span class="n">taste</span><span class="o">=</span><span class="n">taste</span><span class="p">,</span> <span class="n">stock</span><span class="o">=</span><span class="n">stock</span><span class="p">))</span>

<span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</code></pre></div></div>

<p>이제 해당 코드를 실행시키면 정상적으로 Food에 추가되는 것을 확인할 수 있다.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@b099b068dc26:/code/eatenAway#</span><span class="w"> </span>python bulk.py
<span class="go">['menuname', 'category', 'country', 'ingredient', 'taste', 'stock', 'description', '']
['간장 치킨', '패스트푸드', '한국', '고기', '1', 'FALSE', '', '']
['양념 치킨', '패스트푸드', '한국', '고기', '3', 'FALSE', '', '']
['그라탕', '패스트푸드', '이탈리아', '야채', '4', 'FALSE', '', '']
['피자', '패스트푸드', '이탈리아', '야채', '4', 'FALSE', '', '']
['피시앤칩스', '패스트푸드', '영국', '해물', '4', 'FALSE', '', '']
['반미', '패스트푸드', '베트남', '고기', '3', 'FALSE', '', '']
['버거킹', '패스트푸드', '미국', '고기', '2', 'FALSE', '', '']
['서브웨이', '패스트푸드', '미국', '고기', '4', 'FALSE', '', '']
['수제버거', '패스트푸드', '미국', '고기', '2', 'FALSE', '', '']
['시카고피자', '패스트푸드', '미국', '고기', '4', 'FALSE', '', '']
['치즈버거', '패스트푸드', '미국', '고기', '3', 'FALSE', '', '']
['핫도그', '패스트푸드', '미국', '고기', '2', 'FALSE', '', '']
['햄버거', '패스트푸드', '미국', '고기', '2', 'FALSE', '', '']
['후라이드 치킨', '패스트푸드', '미국', '고기', '4', 'FALSE', '', '']
['갈비찜', '밥', '한국', '고기', '1', 'FALSE', '', '']
['갈치조림', '밥', '한국', '해물', '1', 'FALSE', '', '']
['감자탕', '밥', '한국', '고기', '3', 'TRUE', '', '']
['경양식 돈가스', '밥', '한국', '고기', '2', 'FALSE', '', '']
['고등어 구이', '밥', '한국', '해물', '3', 'FALSE', '', '']
['곱창', '밥', '한국', '고기', '5', 'FALSE', '', '']
['김밥', '밥', '한국', '야채', '4', 'FALSE', '', '']
['김치볶음밥', '밥', '한국', '고기', '3', 'FALSE', '', '']
['김치찌개', '밥', '한국', '야채', '5', 'TRUE', '', '']
['낙지볶음', '밥', '한국', '해물', '6', 'FALSE', '', '']
['단팥죽', '밥', '한국', '야채', '1', 'TRUE', '', '']
['닭발', '밥', '한국', '고기', '7', 'FALSE', '', '']
['닭볶음탕', '밥', '한국', '고기', '5', 'TRUE', '', '']
['닭불고기덮밥', '밥', '한국', '고기', '5', 'FALSE', '', '']
</span></code></pre></div></div>

<h3 id="menu에-대한-정보-뿌려주는-페이지-작성하기">menu에 대한 정보 뿌려주는 페이지 작성하기</h3>

<p>이전과 비슷한 형식이다. REST로 음식에 대한 정보를 가져와 response로 돌려주고 그에 대한 결과를 기준으로 template에 뿌려주면 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">path</span><span class="p">(</span><span class="s">'food/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">FoodList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'food/&lt;str:foodname&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">FoodList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</code></pre></div></div>

<p>api의 url로는 2개를 추가했는데 위는 post, 밑은 get을 처리해준다. post의 경우 해당 메뉴의 이미지를 돌려주고 아래의 food/피자 형식의 url은 메뉴에 대한 여러 정보를 리턴해준다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'test/'</span><span class="p">,</span>  <span class="n">views</span><span class="o">.</span><span class="n">testPage</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'test'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'menu/&lt;str:foodname&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">testPage</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'menu'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>food의 url에 menu/foodname을 추가하였으니 이제 localhost:8000/food/menu/피자의 형식으로 접근을 하게되면 해당 메뉴에 대한 정보를 뿌려주게 된다. 그를 위해서 다음과 같이 코드를 작성하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Food</span>


<span class="k">def</span> <span class="nf">testPage</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">foodname</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/"</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="n">foodname</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/user/intro/'</span><span class="p">)</span>
    <span class="n">menu</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'foodname'</span><span class="p">:</span> <span class="n">menu</span><span class="p">[</span><span class="s">'menuname'</span><span class="p">]})</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'foodmenu.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'menu'</span><span class="p">:</span><span class="n">menu</span><span class="p">})</span>
</code></pre></div></div>

<p>json 형식으로 menu를 받아와 그와 관련된 값들을 template에서 menu.taste와 같은 형식으로 뿌려준다. 그리고 그 뒤 post는 이미지 파일에 대한 정보를 가져오는 것은 확인하였지만 로직상 받아서 처리해주기가 어려웠기에 주석처리를 한 부분이다. 이렇게 받아온 정보를 토대로 template에 뿌려주면 해당 탭에 대한 구현이 끝나게 된다.</p>

<h3 id="사용자-정보-그래프로-뿌려주기">사용자 정보 그래프로 뿌려주기</h3>

<p>오랜만에 다시 글을 이어 적는듯한 느낌인데 흠흠, 사용자가 먹은 음식에 대한 부분을 뿌려주기는 모습을 상상하였기 때문에 당연히 해당 부분에 대한 처리 부분을 만들어주어야 했다. 사용자에 그래프 정보는 크게 3가지로 나누어서 구현하였다.</p>

<ol>
  <li>최근 9일간 먹은 음식의 횟수에 따른 통계</li>
  <li>최근 9일간 먹은 음식의 종류를 날짜에 따라 아침/점심/저녁 통계</li>
  <li>특정 음식을 아침/점심/저녁을 기준으로 비율에 대한 통계</li>
</ol>

<p>그래프의 경우 직접 그릴 실력은 안되기 때문에 많은 고민을 했었는데 구글차트에서 땡겨와 쓸 수가 있었다. 그렇게 가져온 형식은 다음과 같다.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">src=</span><span class="s">"https://www.gstatic.com/charts/loader.js"</span><span class="nt">&gt;&lt;/script&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
    <span class="nx">google</span><span class="p">.</span><span class="nx">charts</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span><span class="dl">"</span><span class="s2">current</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span><span class="na">packages</span><span class="p">:[</span><span class="dl">'</span><span class="s1">corechart</span><span class="dl">'</span><span class="p">]});</span>
    <span class="nx">google</span><span class="p">.</span><span class="nx">charts</span><span class="p">.</span><span class="nx">setOnLoadCallback</span><span class="p">(</span><span class="nx">drawChart</span><span class="p">);</span>
    <span class="kd">function</span> <span class="nx">drawChart</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">google</span><span class="p">.</span><span class="nx">visualization</span><span class="p">.</span><span class="nx">arrayToDataTable</span><span class="p">([</span>
       <span class="p">[</span><span class="dl">"</span><span class="s2">Element</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">먹은 횟수</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">style</span><span class="dl">"</span> <span class="p">}</span> <span class="p">],</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">in</span> <span class="nx">foodcount</span><span class="p">.</span><span class="nx">items</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="nx">forloop</span><span class="p">.</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">[</span><span class="dl">"</span><span class="s2">{{ key }}</span><span class="dl">"</span><span class="p">,</span> <span class="p">{{</span> <span class="nx">value</span> <span class="p">}},</span> <span class="dl">"</span><span class="s2">gold</span><span class="dl">"</span><span class="p">],</span>
        <span class="p">{</span><span class="o">%</span> <span class="nx">elif</span> <span class="nx">forloop</span><span class="p">.</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">[</span><span class="dl">"</span><span class="s2">{{ key }}</span><span class="dl">"</span><span class="p">,</span> <span class="p">{{</span> <span class="nx">value</span> <span class="p">}},</span> <span class="dl">"</span><span class="s2">silver</span><span class="dl">"</span><span class="p">],</span>
        <span class="p">{</span><span class="o">%</span> <span class="nx">elif</span> <span class="nx">forloop</span><span class="p">.</span><span class="nx">counter</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">[</span><span class="dl">"</span><span class="s2">{{ key }}</span><span class="dl">"</span><span class="p">,</span> <span class="p">{{</span> <span class="nx">value</span> <span class="p">}},</span> <span class="dl">"</span><span class="s2">color: #b87333</span><span class="dl">"</span><span class="p">],</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">[</span><span class="dl">"</span><span class="s2">{{ key }}</span><span class="dl">"</span><span class="p">,</span> <span class="p">{{</span> <span class="nx">value</span> <span class="p">}},</span> <span class="dl">"</span><span class="s2">color: #e5e4e2</span><span class="dl">"</span><span class="p">],</span>
        <span class="p">{</span><span class="o">%</span> <span class="nx">endif</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="nx">endfor</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">]);</span>

      <span class="kd">var</span> <span class="nx">view</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">visualization</span><span class="p">.</span><span class="nb">DataView</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="nx">view</span><span class="p">.</span><span class="nx">setColumns</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="p">{</span> <span class="na">calc</span><span class="p">:</span> <span class="dl">"</span><span class="s2">stringify</span><span class="dl">"</span><span class="p">,</span>
                         <span class="na">sourceColumn</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                         <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">,</span>
                         <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">annotation</span><span class="dl">"</span> <span class="p">},</span>
                       <span class="mi">2</span><span class="p">]);</span>

      <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">width</span><span class="p">:</span> <span class="mi">900</span><span class="p">,</span>
        <span class="na">height</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
        <span class="na">bar</span><span class="p">:</span> <span class="p">{</span><span class="na">groupWidth</span><span class="p">:</span> <span class="dl">"</span><span class="s2">95%</span><span class="dl">"</span><span class="p">},</span>
        <span class="na">legend</span><span class="p">:</span> <span class="p">{</span> <span class="na">position</span><span class="p">:</span> <span class="dl">"</span><span class="s2">none</span><span class="dl">"</span> <span class="p">},</span>
      <span class="p">};</span>
      <span class="kd">var</span> <span class="nx">chart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">google</span><span class="p">.</span><span class="nx">visualization</span><span class="p">.</span><span class="nx">ColumnChart</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">columnchart_values</span><span class="dl">"</span><span class="p">));</span>
      <span class="nx">chart</span><span class="p">.</span><span class="nx">draw</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">goFood</span><span class="p">(){</span>
    <span class="nx">redirect_url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://localhost:8000/food/menu/</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">gowithfoodname</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">redirect_url</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nt">&lt;/script&gt;</span>

</code></pre></div></div>

<p>위와 같이 javascript를 통해 그래프를 임의로 그리는 것이 가능하다. 위의 코드는 음식을 먹은 횟수에 따라 막대그래프에 그려주는 코드 부분이다.</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/graph_food.png" alt="graph_food" /></p>

<p>해당 부분의 값을 채우기 위해서 api을 하나 생성하였는데 url은 다음과 같다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">path</span><span class="p">(</span><span class="s">'food/user/&lt;str:username&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserDailyFoodList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</code></pre></div></div>

<p>세부 코드를 보면 get과 post로 값을 받는다. get은 위의 그래프와 Food TimeTable기능을 처리하기 위한 api이다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UserDailyFoodList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="c1"># FIXME : AUTHENTICATION, PERMISSION LEVEL TO TOKEN
</span>    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BasicAuthentication</span><span class="p">,)</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">AllowAny</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">DailyUserFood</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">date__range</span><span class="o">=</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'no info'</span><span class="p">,</span> <span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">foodcount</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">dateinfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">food</span> <span class="ow">in</span> <span class="n">foodcount</span><span class="p">:</span>
                        <span class="n">foodcount</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">food</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">foodcount</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">food</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">date</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dateinfo</span><span class="p">:</span>
                        <span class="n">dateinfo</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">date</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">dateinfo</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">date</span><span class="p">)][</span><span class="n">row</span><span class="o">.</span><span class="n">mealkind</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">food</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dateinfo</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">date</span><span class="p">)][</span><span class="n">row</span><span class="o">.</span><span class="n">mealkind</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">food</span>

                <span class="n">res</span><span class="p">[</span><span class="s">'foodcount'</span><span class="p">]</span> <span class="o">=</span> <span class="n">foodcount</span>
                <span class="n">res</span><span class="p">[</span><span class="s">'dateinfo'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dateinfo</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
                <span class="n">json_res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">json_res</span><span class="p">,</span> <span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">username</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'foodname'</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">DailyUserFood</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">food</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'foodname'</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">mealkind</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">mealkind</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">res</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">mealkind</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">json_res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">json_res</span><span class="p">,</span> <span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div></div>

<p>dictionary 형태는 대략적으로 나타내보면 아래와 같다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="n">foodcount</span><span class="p">:{</span>
    <span class="s">'돈가스'</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s">'피자'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="o">...</span>
  <span class="p">}</span>
  <span class="n">dateinfo</span><span class="p">:{</span>
    <span class="s">'2020-03-10'</span> <span class="p">:{</span>
        <span class="s">'B'</span> <span class="p">:</span> <span class="err">돈가스</span> 
        <span class="s">'L'</span> <span class="p">:</span> <span class="err">피자</span>
        <span class="s">'D'</span> <span class="p">:</span>
    <span class="p">},</span>
    <span class="s">'2020-03-11'</span> <span class="p">:{</span>
        <span class="s">'B'</span> <span class="p">:</span>
        <span class="s">'L'</span> <span class="p">:</span>
        <span class="s">'D'</span> <span class="p">:</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>이렇게 가져온 값들을 view에서 처리한 뒤에 뿌려주면 된다. (url에서는 jwt_value내에 username을 넣어놨기 때문에 해당 정보를 토대로 요청을 하면 된다.)</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/user/"</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="n">jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">])</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'main.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'username'</span><span class="p">:</span><span class="n">jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">],</span> <span class="s">'foodcount'</span><span class="p">:</span><span class="n">res</span><span class="p">[</span><span class="s">'foodcount'</span><span class="p">],</span> <span class="s">'dateinfo'</span><span class="p">:</span><span class="n">res</span><span class="p">[</span><span class="s">'dateinfo'</span><span class="p">],</span> <span class="s">'choice'</span><span class="p">:</span><span class="n">choice</span><span class="p">})</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'main.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'username'</span><span class="p">:</span><span class="n">jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">],</span> <span class="s">'choice'</span><span class="p">:</span><span class="n">choice</span><span class="p">})</span>
</code></pre></div></div>

<p>dateinfo 부분을 토대로 가공하면 아래와 같이 TimeTable을 생성할 수 있다.</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/food_timetable.png" alt="food_timetable" /></p>

<p>위의 UserDailyFoodList 클래스의 post 부분은 특정 메뉴에 대한 아침/점심/저녁에 먹은 비율에 대한 그래프를 표시하는데 사용된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">menuDetail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">foodname</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">checkTokenVerification</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="n">jwt_value</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">),</span> <span class="n">JWT_AUTH</span><span class="p">[</span><span class="s">'JWT_SECRET_KEY'</span><span class="p">])</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/user/"</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="n">jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'foodname'</span><span class="p">:</span> <span class="n">foodname</span><span class="p">})</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chart</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">chart</span> <span class="o">=</span> <span class="p">{</span><span class="s">'nope'</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>

            <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/"</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="n">foodname</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/user/main/'</span><span class="p">)</span>
            <span class="n">menu</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/food/user/"</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'foodmenu.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'username'</span><span class="p">:</span><span class="n">jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">],</span> <span class="s">'menu'</span><span class="p">:</span> <span class="n">menu</span><span class="p">,</span> <span class="s">'chart'</span><span class="p">:</span> <span class="n">chart</span><span class="p">})</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/user/intro/'</span><span class="p">)</span>
</code></pre></div></div>

<p>menuDetail 부분이 음식에 대한 세부정보를 뿌려주는데 그 부분에서 post로 foodname을 보내주게 되면 횟수에 대한 결과를 res[row.mealkind] 인 B/L/D 로 추가된다. 해당 결과를 뿌려주기만 하면 된다.</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/porklet_graph.png" alt="porklet_graph" /></p>

<p>이렇게 graph에 대한 부분을 구글차트를 활용하여 구현할 수 있었다.</p>

<h3 id="사용자에게-맞는-음식-추천하기">사용자에게 맞는 음식 추천하기</h3>

<p>사실 음식을 추천하는 기능은 중요한 기능인데 추천 알고리즘 및 AI에 대한 기초가 전혀 없기 때문에 random에 의존한 방식으로 구현을 하였다. 음식은 총 7가지를 추천하며 다음에 의거한다.</p>

<ol>
  <li>최근에 제일 많이 먹은 음식</li>
  <li>최근에 먹은 음식들의 taste 평균에 해당되는 음식</li>
  <li>최근에 먹은 음식들 중 가장 많이 소비한 재료로 이루어진 음식</li>
  <li>최근에 먹은 음식들 중 가장 많이 소비한 근원지(나라)의 음식</li>
  <li>최근에 먹은 음식들 중 가장 많이 소비한 카테고리의 음식</li>
  <li>완전 랜덤</li>
  <li>완전 랜덤</li>
</ol>

<p>역시나 url을 추가해준다. 아참, 이 추천 코드의 경우 사용자에 대한 정보가 존재하지 않을 시 추천에 대한 결과를 가져오지 못한다. 또한 코드가 반복되고 효율적이지 않기 때문에 이런식으로 코드를 짜서 흉내냈구나 정도로만 생각해주면 좋겠다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">path</span><span class="p">(</span><span class="s">'food/preference/&lt;str:username&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserFoodPreferenceList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</code></pre></div></div>

<p>처리하는 부분에 대한 코드는 다음과 같다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">UserFoodPreferenceList</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="c1"># FIXME : AUTHENTICATION, PERMISSION LEVEL TO TOKEN
</span>    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BasicAuthentication</span><span class="p">,)</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">AllowAny</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">DailyUserFood</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">date__range</span><span class="o">=</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'no info'</span><span class="p">,</span> <span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">mostpick</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">categories</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">ingredients</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">countries</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">taste</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">foodname</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">food</span>
                    <span class="n">foodname_based_data</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">menuname</span><span class="o">=</span><span class="n">foodname</span><span class="p">)</span>
                    <span class="n">taste</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">foodname_based_data</span><span class="o">.</span><span class="n">taste</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">foodname_based_data</span><span class="o">.</span><span class="n">menuname</span> <span class="ow">in</span> <span class="n">mostpick</span><span class="p">:</span>
                        <span class="n">mostpick</span><span class="p">[</span><span class="n">foodname_based_data</span><span class="o">.</span><span class="n">menuname</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mostpick</span><span class="p">[</span><span class="n">foodname_based_data</span><span class="o">.</span><span class="n">menuname</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">foodname_based_data</span><span class="o">.</span><span class="n">ingredient</span> <span class="ow">in</span> <span class="n">ingredients</span><span class="p">:</span>
                        <span class="n">ingredients</span><span class="p">[</span><span class="n">foodname_based_data</span><span class="o">.</span><span class="n">ingredient</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ingredients</span><span class="p">[</span><span class="n">foodname_based_data</span><span class="o">.</span><span class="n">ingredient</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">foodname_based_data</span><span class="o">.</span><span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
                        <span class="n">categories</span><span class="p">[</span><span class="n">foodname_based_data</span><span class="o">.</span><span class="n">category</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">categories</span><span class="p">[</span><span class="n">foodname_based_data</span><span class="o">.</span><span class="n">category</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">foodname_based_data</span><span class="o">.</span><span class="n">country</span> <span class="ow">in</span> <span class="n">countries</span><span class="p">:</span>
                        <span class="n">countries</span><span class="p">[</span><span class="n">foodname_based_data</span><span class="o">.</span><span class="n">country</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">countries</span><span class="p">[</span><span class="n">foodname_based_data</span><span class="o">.</span><span class="n">country</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">taste</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">taste</span><span class="o">/</span><span class="n">count</span><span class="p">)</span>
                <span class="n">mostpick</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mostpick</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">ingredients</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ingredients</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">categories</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">categories</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">countries</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">countries</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="n">res</span><span class="p">[</span><span class="s">'모스트 원픽'</span><span class="p">]</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">menuname</span><span class="o">=</span><span class="n">mostpick</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">taste</span><span class="o">=</span><span class="n">taste</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="k">while</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">taste</span><span class="o">=</span><span class="n">taste</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="n">res</span><span class="p">[</span><span class="s">'평균적인 맛에 의거한 추천'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">ingredient</span><span class="o">=</span><span class="n">ingredients</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="k">while</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">ingredient</span><span class="o">=</span><span class="n">ingredients</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="n">res</span><span class="p">[</span><span class="s">'재료에 의한 추천'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">categories</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="k">while</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">categories</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="n">res</span><span class="p">[</span><span class="s">'음식의 종류에 따른 추천'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="n">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="k">while</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">country</span><span class="o">=</span><span class="n">countries</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="n">res</span><span class="p">[</span><span class="s">'특정 나라음식 추천'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="k">while</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="n">res</span><span class="p">[</span><span class="s">'랜덤 추천'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

                <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="k">while</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">"?"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">menuname</span>
                <span class="n">res</span><span class="p">[</span><span class="s">'묻지마 추천'</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">HTTP_200_OK</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div></div>

<p>말 그래도 사용자가 최근에 먹은 음식에 대한 정보를 가져와 dict으로 조합한 뒤 그 정보를 기준으로 order_by(?) 를 사용하여 랜덤으로 가져와서 res에 넣어서 돌려준다. 그 과정에서 각각의 음식이 겹치지 않도록 while문으로 처리를 해주었다.(분명 더 좋은 방식이 있으리라…)</p>

<h3 id="사용자가-먹은-음식에-대한-정보-등록하는-페이지-생성">사용자가 먹은 음식에 대한 정보 등록하는 페이지 생성</h3>

<p>음식에 대한 조회 및 결과를 그래프로 뿌려주는 것이 main의 역할이기 때문에 결국 사용자가 자신이 어떤 음식을 먹었는지에 대한 정보를 DB에 업데이트를 해야된다. 그를 위해서 UI에서 사용자로부터 입력을 쉽게 받을 수 있도록 하는 작업이 필요하다.</p>

<p>방식은 기존과 크게 다르지 않다. food 부분에 url을 3개를 추가해주어서 관리를 담당하도록 설계하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'menu/&lt;str:foodname&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">menuDetail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'menu'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'addmenu/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">addMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'addmenu'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'checkdatemenu/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">checkDateMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'checkdatemenu'</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'updatedatemenu/'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">updateDateMenu</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'updatedatemneu'</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div></div>

<p>addmenu는 사용자로부터 날짜를 입력받는 첫 페이지이다. 해당 정보가 post로 넘어가게 되면 checkdatemenu부분에서는 아침/점심/저녁으로 해당 날짜에 저장된 값을 가져온다. 그리고 사용자는 아래의 form을 활용하여 새로운 데이터를 추가하거나 기존의 것을 수정하는 것이 가능하다. 위에 대한 처리를 위해 api 쪽의 url도 추가해주었다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">path</span><span class="p">(</span><span class="s">'food/date/&lt;str:username&gt;/&lt;str:date&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserFoodByDate</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'food/date/&lt;str:username&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserFoodByDate</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</code></pre></div></div>

<p>get은 특정 날짜의 사용자의 음식메뉴에 대한 정보를 가져올때 호출이 되며 post는 값을 저장할때 호출이 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'''
get : 특정 일자의 유저의 아침/점심/저녁 리스트 리턴
post : 특정 일자의 아침/점심/저녁 정보 추가 또는 업데이트 및 삭제
'''</span>
<span class="k">class</span> <span class="nc">UserFoodByDate</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="c1"># FIXME : AUTHENTICATION, PERMISSION LEVEL TO TOKEN
</span>    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">BasicAuthentication</span><span class="p">,)</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">AllowAny</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">DailyUserFood</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">res</span><span class="p">[</span><span class="s">'B'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">'L'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">'D'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'-'</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">mealkind</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">food</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">HTTP_200_OK</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'date'</span><span class="p">]</span>
            <span class="n">mealkind</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'mealkind'</span><span class="p">]</span>
            <span class="n">foodname</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">'foodname'</span><span class="p">]</span>
            <span class="n">food_data</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">menuname</span><span class="o">=</span><span class="n">foodname</span><span class="p">)</span>
            <span class="n">mealkind_choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">'B'</span><span class="p">,</span> <span class="s">'L'</span><span class="p">,</span> <span class="s">'D'</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mealkind</span> <span class="ow">in</span> <span class="n">mealkind_choice</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">DailyUserFood</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">mealkind</span><span class="o">=</span><span class="n">mealkind</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">food</span> <span class="o">=</span> <span class="n">foodname</span>
            <span class="n">data</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">DailyUserFood</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">DailyUserFood</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">food</span><span class="o">=</span><span class="n">foodname</span><span class="p">,</span> <span class="n">mealkind</span><span class="o">=</span><span class="n">mealkind</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_201_CREATED</span><span class="p">)</span>
</code></pre></div></div>

<p>이제 food의 views쪽에서 form의 값을 토대로 REST통신을 한 결과값을 처리해주기만 하면 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">def</span> <span class="nf">addMenu</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">checkTokenVerification</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'addmenu.html'</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/user/intro'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">checkDateMenu</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">checkTokenVerification</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="n">jwt_value</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">),</span> <span class="n">JWT_AUTH</span><span class="p">[</span><span class="s">'JWT_SECRET_KEY'</span><span class="p">])</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/date/"</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="n">jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'date'</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">dateres</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dateres</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'checkdatemenu.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'username'</span><span class="p">:</span><span class="n">jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">],</span> <span class="s">'date'</span><span class="p">:</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'date'</span><span class="p">],</span> <span class="s">'Breakfast'</span><span class="p">:</span><span class="n">dateres</span><span class="p">[</span><span class="s">'B'</span><span class="p">],</span> <span class="s">'Lunch'</span><span class="p">:</span><span class="n">dateres</span><span class="p">[</span><span class="s">'L'</span><span class="p">],</span> <span class="s">'Dinner'</span><span class="p">:</span><span class="n">dateres</span><span class="p">[</span><span class="s">'D'</span><span class="p">]})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s">'/user/intro'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">updateDateMenu</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">checkTokenVerification</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
            <span class="n">jwt_value</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">),</span> <span class="n">JWT_AUTH</span><span class="p">[</span><span class="s">'JWT_SECRET_KEY'</span><span class="p">])</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/date/"</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="n">jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">'정보를 다시 확인해주세요.'</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">'요청이 정상적으로 반영되었습니다.'</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="n">jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'date'</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">dateres</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dateres</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'updatedatemenu.html'</span><span class="p">,</span> <span class="p">{</span><span class="s">'msg'</span><span class="p">:</span><span class="n">msg</span><span class="p">,</span> <span class="s">'date'</span><span class="p">:</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">'date'</span><span class="p">],</span> <span class="s">'Breakfast'</span><span class="p">:</span><span class="n">dateres</span><span class="p">[</span><span class="s">'B'</span><span class="p">],</span> <span class="s">'Lunch'</span><span class="p">:</span><span class="n">dateres</span><span class="p">[</span><span class="s">'L'</span><span class="p">],</span> <span class="s">'Dinner'</span><span class="p">:</span><span class="n">dateres</span><span class="p">[</span><span class="s">'D'</span><span class="p">]})</span>

</code></pre></div></div>

<h3 id="kakao-map-api-연동하기">kakao map api 연동하기</h3>

<p>당장 구현하고 싶었던 것은 menu탭에서 특정 음식 목록에 들어갔을 때 사용자의 area 정보를 토대로 근처의 해당 음식점에 대한 정보를 맵으로 표현해주는 것이었다. 이를 위해서 네이버와 카카오 맵 api를 써보았는데 예제부터가 카카오가 훨씬 자세하고 쓰기가 간편했다. 거의 수정을 안하고 사용하였다!!</p>

<p><a href="http://apis.map.kakao.com/web/sample/keywordList/">KAKAO MAP api</a></p>

<p>kakao map api 관련 key를 입력받은 뒤 그대로 적용해주면 된다. 이를 위해서 사용자 DB로부터 area에 대한 정보를 가져왔던 /api/accounts/profile의 정보와 menuname을 토대로 검색 부분만 변경해주면 된다.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"wrapper style1 align-center"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"inner"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h2&gt;</span>Good place to eat {{ menu.menuname }} nearby<span class="nt">&lt;/h2&gt;</span>
        <span class="nt">&lt;p&gt;</span>{{ username}} 님이 등록하신 주소지인 <span class="nt">&lt;strong&gt;</span>{{ user_profile.area }}<span class="nt">&lt;/strong&gt;</span> 기준으로 근처 맛집을 검색해보았어요.<span class="nt">&lt;/p&gt;</span>

        <span class="nt">&lt;section&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span> <span class="na">align=</span><span class="s">"center"</span><span class="nt">&gt;</span>

                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"map_wrap"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"map"</span> <span class="na">style=</span><span class="s">"width:100%;height:100%;position:relative;overflow:hidden;"</span><span class="nt">&gt;&lt;/div&gt;</span>

                    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"menu_wrap"</span> <span class="na">class=</span><span class="s">"bg_white"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"option"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;div&gt;</span>
                                <span class="nt">&lt;form</span> <span class="na">onsubmit=</span><span class="s">"searchPlaces(); return false;"</span><span class="nt">&gt;</span>
                                    키워드 : <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"{{ user_profile.area }} {{ menu.menuname }} 맛집"</span> <span class="na">id=</span><span class="s">"keyword"</span> <span class="na">size=</span><span class="s">"15"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>검색하기<span class="nt">&lt;/button&gt;</span>
                                <span class="nt">&lt;/form&gt;</span>
                            <span class="nt">&lt;/div&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                        <span class="nt">&lt;hr&gt;</span>
                        <span class="nt">&lt;ul</span> <span class="na">id=</span><span class="s">"placesList"</span><span class="nt">&gt;&lt;/ul&gt;</span>
                        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"pagination"</span><span class="nt">&gt;&lt;/div&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/div&gt;</span>


            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/section&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/section&gt;</span>

</code></pre></div></div>

<p>그러면 아래와 같이 이쁜 지도창을 구현할 수 있다.</p>

<p><img src="https://raw.githubusercontent.com/wizleysw/wizleysw.github.io/master/_posts/img/eatenAway/foodmap.png" alt="foodmap" /></p>

<h3 id="dailyuserfood-rest-delete로-삭제하기">DailyUserFood REST DELETE로 삭제하기</h3>

<p>그 전에 수정과 추가는 구현을 했었는데 DELETE 부분에 대한 구현을 끝마치지 않았었다. 이를 위해서 url을 하나 추가하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">path</span><span class="p">(</span><span class="s">'food/date/&lt;str:username&gt;/&lt;str:date&gt;/&lt;str:mealkind&gt;'</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">UserFoodByDate</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
</code></pre></div></div>

<p>DELETE의 경우 data를 같이 넘기지 못하기 때문에 쿼리 조회에 필요한 정보인 username, date, mealkind를 url로 입력을 받기로 하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">mealkind</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">DailyUserFood</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">,</span> <span class="n">mealkind</span><span class="o">=</span><span class="n">mealkind</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>
</code></pre></div></div>

<p>그리고 위와 같이 get을 통해 찾은 뒤 delete를 하도록 설정해주면 끝이 난다.</p>

<h2 id="리팩토링-및-api에-jwt-권한-설정">리팩토링 및 API에 JWT 권한 설정</h2>

<p>구현하고자 하는 기능들을 대부분 구현한 후에 해야되는 것은 리팩토링 작업이다! 내가 짱짱 개발자가 아니기 때문에 무조건적으로 코드를 손봐야되는데 views.py의 가독성을 높히는 방향으로 가고자하였고, 각각을 클래스화시켜서 나누는 방식으로 진행하였다.</p>

<h3 id="user-app-리팩토링">user app 리팩토링</h3>

<p>기존의 코드를 user app 하위에 새 파일을 작성하여 관리하였다. views.py에서 요청하는 requests를 apis.py 하위의 클래스에 통일하여 배치하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="k">class</span> <span class="nc">APIAboutUser</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>

    <span class="k">def</span> <span class="nf">get_user_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">recaptcha</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/accounts/login/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'username'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">'password'</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span> <span class="s">'g-recaptcha-response'</span><span class="p">:</span> <span class="n">recaptcha</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'token'</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">get_user_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/accounts/profile/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'JWT '</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">get_user_preference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/preference/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'JWT '</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">get_user_foodcount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/user/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'JWT '</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">res2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">'dateinfo'</span><span class="p">]</span>
                <span class="n">res3</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s">'foodcount'</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res2</span> <span class="o">=</span> <span class="n">res3</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">res2</span><span class="p">,</span> <span class="n">res3</span>
</code></pre></div></div>

<p>그리고 token관련 작업 또한 tokens.py를 새로 만들어서 관리하는 방식으로 변경하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">eatenAway.settings</span> <span class="kn">import</span> <span class="n">JWT_AUTH</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">jwt</span>


<span class="k">class</span> <span class="nc">Token</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>

    <span class="k">def</span> <span class="nf">has_token</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_account_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/token/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'username'</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s">'password'</span><span class="p">:</span> <span class="n">password</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'token'</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_token</span><span class="p">():</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/token/verify/"</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'token'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">'token'</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">decode_jwt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_token</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">JWT_AUTH</span><span class="p">[</span><span class="s">'JWT_SECRET_KEY'</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">None</span>
</code></pre></div></div>

<p>이렇게 변경을 하게 되면 views.py의 main 페이지 부분은 다음과 같이 이쁘게 변환이 가능하다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">RenderMainPage</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">tk</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">))</span>
    <span class="n">tk_jwt_value</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">decode_jwt</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tk_jwt_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">tk_jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>
        <span class="n">user_api</span> <span class="o">=</span> <span class="n">APIAboutUser</span><span class="p">(</span><span class="n">tk_jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">],</span> <span class="n">tk</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
        <span class="n">user_profile</span> <span class="o">=</span> <span class="n">user_api</span><span class="o">.</span><span class="n">get_user_profile</span><span class="p">()</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="n">user_api</span><span class="o">.</span><span class="n">get_user_preference</span><span class="p">()</span>
        <span class="n">date_info</span><span class="p">,</span> <span class="n">food_count</span> <span class="o">=</span> <span class="n">user_api</span><span class="o">.</span><span class="n">get_user_foodcount</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'main.html'</span><span class="p">,</span>
                      <span class="p">{</span><span class="s">'username'</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s">'foodcount'</span><span class="p">:</span> <span class="n">food_count</span><span class="p">,</span> <span class="s">'dateinfo'</span><span class="p">:</span> <span class="n">date_info</span><span class="p">,</span>
                       <span class="s">'choice'</span><span class="p">:</span> <span class="n">choice</span><span class="p">,</span> <span class="s">'user_profile'</span><span class="p">:</span> <span class="n">user_profile</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">'/user/login'</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s">'token'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div>

<h3 id="food-app-리팩토링">food app 리팩토링</h3>

<p>food app도 마찬가지로 requests를 통해 api와 통신하는 부분을 apis.py로 분리하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="k">class</span> <span class="nc">APIAboutFood</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">foodname</span><span class="p">,</span> <span class="n">tk</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">foodname</span> <span class="o">=</span> <span class="n">foodname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tk</span> <span class="o">=</span> <span class="n">tk</span>

    <span class="k">def</span> <span class="nf">get_food_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">foodname</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'JWT '</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">get_user_food</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/user/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">'foodname'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">foodname</span><span class="p">},</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'JWT '</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s">'nope'</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">get_user_food_by_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/date/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">date</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'JWT '</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">res</span><span class="p">[</span><span class="s">'B'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">'L'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s">'D'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'-'</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">update_user_food_by_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requested_data</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/date/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">requested_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'JWT '</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s">'요청이 정상적으로 반영되었습니다.'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s">'정보를 다시 확인해주세요.'</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">delete_user_food_by_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">mealkind</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/date/"</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="s">'/'</span> <span class="o">+</span> <span class="n">mealkind</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'JWT '</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s">'요청이 정상적으로 반영되었습니다.'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s">'정보를 다시 확인해주세요.'</span>
        <span class="k">return</span> <span class="n">res</span>

</code></pre></div></div>

<p>그에 따라 아래와 같이 좀 더 가독성이 좋아진 views.py를 마주하게 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">RenderFoodPage</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">foodname</span><span class="p">):</span>
    <span class="n">tk</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">COOKIES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">))</span>
    <span class="n">tk_jwt_value</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">decode_jwt</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tk_jwt_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">tk_jwt_value</span><span class="p">[</span><span class="s">'username'</span><span class="p">]</span>
        <span class="n">food_api</span> <span class="o">=</span> <span class="n">APIAboutFood</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">foodname</span><span class="p">,</span> <span class="n">tk</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
        <span class="n">user_api</span> <span class="o">=</span> <span class="n">APIAboutUser</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">tk</span><span class="p">)</span>
        <span class="n">chart</span> <span class="o">=</span> <span class="n">food_api</span><span class="o">.</span><span class="n">get_user_food</span><span class="p">()</span>
        <span class="n">user_profile</span> <span class="o">=</span> <span class="n">user_api</span><span class="o">.</span><span class="n">get_user_profile</span><span class="p">()</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">food_api</span><span class="o">.</span><span class="n">get_food_detail</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'foodmenu.html'</span><span class="p">,</span>
                      <span class="p">{</span><span class="s">'username'</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span> <span class="s">'menu'</span><span class="p">:</span> <span class="n">menu</span><span class="p">,</span> <span class="s">'chart'</span><span class="p">:</span> <span class="n">chart</span><span class="p">,</span> <span class="s">'user_profile'</span><span class="p">:</span> <span class="n">user_profile</span><span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="s">'/user/login'</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="s">'token'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div>

<h3 id="api-app-리팩토링">api app 리팩토링</h3>

<p>마지막으로 api app의 경우 accounts.py, foods.py를 세부적으로 관리하여 각각 해당 앱의 Model과 관련된 작업을 하는 부분을 분리하였다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib.auth.hashers</span> <span class="kn">import</span> <span class="n">check_password</span>
<span class="kn">from</span> <span class="nn">django.utils.http</span> <span class="kn">import</span> <span class="n">urlsafe_base64_encode</span><span class="p">,</span> <span class="n">urlsafe_base64_decode</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="kn">import</span> <span class="n">force_bytes</span><span class="p">,</span> <span class="n">force_text</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">.tokens</span> <span class="kn">import</span> <span class="n">account_activation_token</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">EmailMessage</span>
<span class="kn">from</span> <span class="nn">user.models</span> <span class="kn">import</span> <span class="n">Account</span>


<span class="k">class</span> <span class="nc">UserAccount</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">is_account_status_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s">'O'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">is_account_available</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_account_status_ok</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">is_password_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_account_available</span><span class="p">()</span> <span class="ow">and</span> <span class="n">check_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">already_have_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">already_have_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_account_by_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uidb64</span><span class="p">):</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">force_text</span><span class="p">(</span><span class="n">urlsafe_base64_decode</span><span class="p">(</span><span class="n">uidb64</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">uid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">get_account</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">check_account_activation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">account_activation_token</span><span class="o">.</span><span class="n">check_token</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">'O'</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_email_link</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">render_to_string</span><span class="p">(</span><span class="s">'activate.html'</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">'domain'</span><span class="p">:</span> <span class="s">'localhost:8000'</span><span class="p">,</span>
            <span class="s">'username'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">'uid'</span><span class="p">:</span> <span class="n">urlsafe_base64_encode</span><span class="p">(</span><span class="n">force_bytes</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">pk</span><span class="p">)),</span>
            <span class="s">'token'</span><span class="p">:</span> <span class="n">account_activation_token</span><span class="o">.</span><span class="n">make_token</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">message</span>

    <span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
        <span class="n">mail_subject</span> <span class="o">=</span> <span class="s">'eaten-Away 이메일 인증'</span>
        <span class="n">to_email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_email_link</span><span class="p">()</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="n">mail_subject</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="p">[</span><span class="n">to_email</span><span class="p">])</span>
        <span class="n">email</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
</code></pre></div></div>

<p>이와 같이 분리함으로써 views.py에서 중복되는 코드들을 줄일 수 있을 뿐더러 가독성도 향상되었다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"""
GET : user/apis.py -&gt; get_user_preference (/api/food/preference/&lt;str:username&gt;)
용도  : 특정 기간 내의 사용자의 음식 리스트를 조회하여 추천 메뉴 7개를 선정함
"""</span>
<span class="k">class</span> <span class="nc">APIForUserFoodChoice</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="p">):</span>
        <span class="n">UserFood</span> <span class="o">=</span> <span class="n">DailyFood</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="n">foodlist</span> <span class="o">=</span> <span class="n">UserFood</span><span class="o">.</span><span class="n">get_user_food_with_day</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">foodlist</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="n">HTTP_400_BAD_REQUEST</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">UserFood</span><span class="o">.</span><span class="n">get_preference</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">HTTP_200_OK</span><span class="p">)</span>
</code></pre></div></div>

<p>사용자가 먹은 음식 리스트를 토대로 7가지의 음식을 추천해주는 코드는 무려 다음과 같이 8줄 내외로 줄어들었다.</p>

<h3 id="jwt-api-권한-설정">JWT API 권한 설정</h3>

<p>예전에 settings.py에서 코드를 다음과 같이 변경하였었다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'DEFAULT_PERMISSION_CLASSES'</span><span class="p">:</span> <span class="p">(</span>
        <span class="s">'rest_framework.permissions.IsAuthenticated'</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s">'DEFAULT_RENDERER_CLASSES'</span><span class="p">:</span> <span class="p">(</span>
        <span class="s">'rest_framework.renderers.JSONRenderer'</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s">'DEFAULT_AUTHENTICATION_CLASSES'</span><span class="p">:</span> <span class="p">(</span>
        <span class="s">'rest_framework_jwt.authentication.JSONWebTokenAuthentication'</span><span class="p">,</span>
        <span class="s">'rest_framework.authentication.SessionAuthentication'</span><span class="p">,</span>
        <span class="s">'rest_framework.authentication.BasicAuthentication'</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">}</span>
</code></pre></div></div>

<p>하지만 개발하는 과정에서는 테스트를 위해서 권한을 AllowAny로 뒀었는데 보안성 강화를 위해서 유저가 로그인 후에 사용할 수 있는 기능을 제공하는 API부분에 JWT가 필요하도록 설정해주자. 이미 위의 코드에 등장하지만 headers를 다음과 같이 추가해주면 된다.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_food_detail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="s">"http://localhost:8000/api/food/"</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">foodname</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'JWT '</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tk</span><span class="p">})</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></div>

<p>Authorization 부분에 JWT + token 값을 추가해주면 성공할 경우에는 정상적인 API 기능이 수행되고 잘못된 값일 경우 401이 status_code로 돌아오게 된다. 이를 통해 로그인 된 사용자의 JWT 토큰을 검증하여 API가 기능을 하게 되었다.</p>

<h3 id="github-link">GITHUB link</h3>

<p>대댓글 기능을 구현하지 않긴 하였지만 해당 서비스에서 굳이 필요한 기능이라고 판단되지 않았기 때문에 과감히 생략하였다. 아래의 링크를 통해 전체 소스 코드를 확인가능하다.
(url에 대한 부분은 완전하게 설정을 하지 않았고, DEBUG 모드도 True인 상태이다.)</p>

<p><a href="https://github.com/wizleysw/eatenAway">eaten-Away 결과물</a></p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#django" class="page__taxonomy-item" rel="tag">Django</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#docker" class="page__taxonomy-item" rel="tag">docker</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#rest" class="page__taxonomy-item" rel="tag">REST</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#dev" class="page__taxonomy-item" rel="tag">dev</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 게시일:</strong> <time datetime="2020-03-02T00:00:00+09:00">March 2, 2020</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Django+%2B+REST+%2B+SQLite+%40+docker%EB%A1%9C+Eaten_Away+%EC%84%9C%EB%B9%84%EC%8A%A4+%EA%B0%9C%EB%B0%9C%ED%95%98%EA%B8%B0%20http%3A%2F%2Flocalhost%3A4000%2Fdev%2FDjango-%2B-REST-%2B-SQLite-%40-docker%25EB%25A1%259C-Eaten_Away-%25EC%2584%259C%25EB%25B9%2584%25EC%258A%25A4-%25EA%25B0%259C%25EB%25B0%259C%25ED%2595%2598%25EA%25B8%25B0%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fdev%2FDjango-%2B-REST-%2B-SQLite-%40-docker%25EB%25A1%259C-Eaten_Away-%25EC%2584%259C%25EB%25B9%2584%25EC%258A%25A4-%25EA%25B0%259C%25EB%25B0%259C%25ED%2595%2598%25EA%25B8%25B0%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fdev%2FDjango-%2B-REST-%2B-SQLite-%40-docker%25EB%25A1%259C-Eaten_Away-%25EC%2584%259C%25EB%25B9%2584%25EC%258A%25A4-%25EA%25B0%259C%25EB%25B0%259C%25ED%2595%2598%25EA%25B8%25B0%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/dev/PHP-+-nginx-+-mysql-@-docker%EB%A1%9C-%EA%B2%8C%EC%8B%9C%ED%8C%90-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0/" class="pagination--pager" title="PHP + nginx + mysql @ docker로 게시판 구현하기
">이전</a>
    
    
      <a href="/dev/JAVA-+-graphQL%EB%A1%9C-%EC%95%88%EB%93%9C%EB%A1%9C%EC%9D%B4%EB%93%9C-%EC%96%B4%ED%94%8C-%ED%81%B4%EB%A1%A0%EC%BD%94%EB%94%A9%ED%95%98%EA%B8%B0/" class="pagination--pager" title="JAVA + graphQL로 안드로이드 어플 클론코딩하기
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">참고</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/dev/%EB%84%88%EC%9D%98-%EC%9D%B4%EB%A6%84%EC%9D%80-%EC%98%81%ED%99%94%EC%97%90-%EB%82%98%EC%98%A8-MyDiary%EB%A5%BC-%EA%B5%AC%ED%98%84%ED%95%9C-%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4-%EC%95%B1-%EB%98%91%EA%B0%99%EC%9D%B4-%EB%94%B0%EB%9D%BC-%EC%BD%94%EB%94%A9%ED%95%B4%EB%B3%B4%EA%B8%B0/" rel="permalink">너의 이름은 영화에 나온 MyDiary를 구현한 오픈소스 앱 똑같이 따라 코딩해보기
</a>
      
    </h2>
    <!--
      comments:
        아카이브 싱글 페이지 각 포스트 제목 하단에 Updated 시간 표기
        기존에는 read_time이 표기됨
    
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  18 분 소요

</p>
    
    -->
    
    <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> June 02 2020</p>
    

    <p class="archive__item-excerpt" itemprop="description">Overview
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/dev/JAVA-+-graphQL%EB%A1%9C-%EC%95%88%EB%93%9C%EB%A1%9C%EC%9D%B4%EB%93%9C-%EC%96%B4%ED%94%8C-%ED%81%B4%EB%A1%A0%EC%BD%94%EB%94%A9%ED%95%98%EA%B8%B0/" rel="permalink">JAVA + graphQL로 안드로이드 어플 클론코딩하기
</a>
      
    </h2>
    <!--
      comments:
        아카이브 싱글 페이지 각 포스트 제목 하단에 Updated 시간 표기
        기존에는 read_time이 표기됨
    
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  38 분 소요

</p>
    
    -->
    
    <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> April 03 2020</p>
    

    <p class="archive__item-excerpt" itemprop="description">Overview
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/dev/PHP-+-nginx-+-mysql-@-docker%EB%A1%9C-%EA%B2%8C%EC%8B%9C%ED%8C%90-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0/" rel="permalink">PHP + nginx + mysql @ docker로 게시판 구현하기
</a>
      
    </h2>
    <!--
      comments:
        아카이브 싱글 페이지 각 포스트 제목 하단에 Updated 시간 표기
        기존에는 read_time이 표기됨
    
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  37 분 소요

</p>
    
    -->
    
    <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> February 25 2020</p>
    

    <p class="archive__item-excerpt" itemprop="description">Overview
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/dev/Hello-Design-Pattern/" rel="permalink">Hello Design Pattern!
</a>
      
    </h2>
    <!--
      comments:
        아카이브 싱글 페이지 각 포스트 제목 하단에 Updated 시간 표기
        기존에는 read_time이 표기됨
    
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 분 소요

</p>
    
    -->
    
    <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> February 19 2020</p>
    

    <p class="archive__item-excerpt" itemprop="description">HelloWorld!
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    

    
      
        
          <li><a href="https://github.com/wizleysw" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Wizley. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
