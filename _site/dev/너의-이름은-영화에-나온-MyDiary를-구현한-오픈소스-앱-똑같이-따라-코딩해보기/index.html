<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.17.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>너의 이름은 영화에 나온 MyDiary를 구현한 오픈소스 앱 똑같이 따라 코딩해보기 - 위즐리 블로그</title>
<meta name="description" content="Overview ">


  <meta name="author" content="Wizley">


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="위즐리 블로그">
<meta property="og:title" content="너의 이름은 영화에 나온 MyDiary를 구현한 오픈소스 앱 똑같이 따라 코딩해보기">
<meta property="og:url" content="http://localhost:4000/dev/%EB%84%88%EC%9D%98-%EC%9D%B4%EB%A6%84%EC%9D%80-%EC%98%81%ED%99%94%EC%97%90-%EB%82%98%EC%98%A8-MyDiary%EB%A5%BC-%EA%B5%AC%ED%98%84%ED%95%9C-%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4-%EC%95%B1-%EB%98%91%EA%B0%99%EC%9D%B4-%EB%94%B0%EB%9D%BC-%EC%BD%94%EB%94%A9%ED%95%B4%EB%B3%B4%EA%B8%B0/">


  <meta property="og:description" content="Overview ">







  <meta property="article:published_time" content="2020-06-02T00:00:00+09:00">





  

  


<link rel="canonical" href="http://localhost:4000/dev/%EB%84%88%EC%9D%98-%EC%9D%B4%EB%A6%84%EC%9D%80-%EC%98%81%ED%99%94%EC%97%90-%EB%82%98%EC%98%A8-MyDiary%EB%A5%BC-%EA%B5%AC%ED%98%84%ED%95%9C-%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4-%EC%95%B1-%EB%98%91%EA%B0%99%EC%9D%B4-%EB%94%B0%EB%9D%BC-%EC%BD%94%EB%94%A9%ED%95%B4%EB%B3%B4%EA%B8%B0/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Wizley",
      "url": "http://localhost:4000/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="위즐리 블로그 Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

    
  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          위즐리 블로그
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/dev/" >dev</a>
            </li><li class="masthead__menu-item">
              <a href="/android/" >android</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="https://avatars1.githubusercontent.com/u/32321029?s=460&v=4" alt="Wizley" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Wizley</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>I think I wanna become Android developer for now</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">팔로우</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">KR</span>
        </li>
      

      
        
          
        
          
        
          
        
      

      

      
        <li>
          <a href="mailto:wizley@kakao.com">
            <meta itemprop="email" content="wizley@kakao.com" />
            <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> 이메일
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/wizleysw" itemprop="sameAs" rel="nofollow noopener noreferrer">
            <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="너의 이름은 영화에 나온 MyDiary를 구현한 오픈소스 앱 똑같이 따라 코딩해보기">
    <meta itemprop="description" content="Overview">
    <meta itemprop="datePublished" content="2020-06-02T00:00:00+09:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">너의 이름은 영화에 나온 MyDiary를 구현한 오픈소스 앱 똑같이 따라 코딩해보기
</h1>
          
          <!--
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  26 분 소요

</p>
          -->
          <p class="page_data"><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 게시일: <time datetime="2020-06-02T00:00:00+09:00">June 02, 2020</time></p>
            
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu">
  <li><a href="#overview">Overview</a>
    <ul>
      <li><a href="#target">Target</a></li>
    </ul>
  </li>
  <li><a href="#코딩시작">코딩시작</a>
    <ul>
      <li><a href="#initactivity">InitActivity</a></li>
      <li><a href="#passwordactivity">PasswordActivity</a></li>
      <li><a href="#mainactivity">MainActivity</a></li>
      <li><a href="#settingactivity">SettingActivity</a></li>
      <li><a href="#backupactivity">BackupActivity</a></li>
      <li><a href="#contactsactivity">ContactsActivity</a></li>
      <li><a href="#memoactivity">MemoActivity</a></li>
    </ul>
  </li>
</ul>

            </nav>
          </aside>
        
        <h2 id="overview">Overview</h2>

<p>두 달이라는 기간동안 안드로이드 어플리케이션을 개발하기 위해 열중하였고 결국 aintstagram이라는 완성본을 만들게 되었다. 하지만 구현을 하는 도중에 이게 최선의 방법일까라는 고민을 수도 없이 하였고 좀 더 좋은 방법이 분명 존재할 것 같다는 생각을 자주 하게 되었다. 그래서 이번에는 다른 개발자가 구현한 앱의 코드 흐름을 그대로 따라가면서 좀 더 효율적인 코딩을 하기 위한 방법을 배우고자 한다.</p>

<h3 id="target">Target</h3>

<p>인스타그램 클론 프로젝트를 구현하는 동안 가장 많이 사용한 것은 RecyclerView와 관련된 내용들이었다. 그래서 이 기능을 활용하는 앱을 따라해보아야겠다는 생각을 하였다. 그리하여 선택한 앱은 MyDiary라는 앱이다.</p>

<p><a href="https://github.com/DaxiaK/MyDiary">MyDiary</a></p>

<p>해당 앱은 너의 이름은 이라는 애니메이션에 등장한 다이어리 어플을 구현한 것으로 MIT 라이센스로 무려 500회가 넘는 커밋기록과 1400개 이상의 star를 받은 작품이다. 해당 앱을 따라하는 과정에서 많은 것들을 배울것으로 확신하고 타겟으로 정하게 되었다. 무엇보다 가장 좋은 점은 따라하는 프로젝트다보니 이미지 관련부분을 고민하지 않아도 된다는 점이다. 물론 코드를 이해해야 겠지만..</p>

<h2 id="코딩시작">코딩시작</h2>

<h3 id="initactivity">InitActivity</h3>

<p>어플리케이션을 리버싱 할 때 가장 먼저 확인하는 것이 AndroidManifest였다. 시작점을 찾기가 용이하기 떄문이랄까? 코딩도 마찬가지였다. MAIN 부터 프로그램이 흐름을 따라가기 시작하기 때문에 이를 찾아서 해당 지점부터 구현을 진행하기로 하였다. 매니페스트를 통해 InitActivity가 splash효과를 위해 사용된 것을 확인할 수 있었다. 그 전에 여러 resource 정보들을 추가하기로 하였는데 layout을 제외하고 drawable과 color, 그리고 styles 정보를 복사해왔다.</p>

<p>InitActivity 쪽을 보니 onCreate부분에서는 핸들러에 대한 초기화와 View에 대한 할당을 진행하는 것 외의 별다른 특징은 보이지 않았다. onCreate -&gt; onStart -&gt; onResume의 단계에서 사용자와의 커뮤니케이션을 시작하는 부분인 onResume에서 SPFManager로부터 메소드를 호출하는 것을 확인할 수 있었다. 이제 SPFManager가 무엇인지를 확인할 차례이다.</p>

<p>SPF는 SharedPreference의 줄임말인듯하다. 왜냐하면 getLocalLanguageCode와 같은 메소드들이 SharedPreference로부터 값을 가져오고 setConfigLocalLanguage 등의 메소드가 SharedPreference의 값을 설정하기 때문이었다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getLocalLanguageCode</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">){</span>
    <span class="nc">SharedPreferences</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getSharedPreferences</span><span class="o">(</span><span class="no">SPF_CONFIG</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="no">CONFIG_LOCAL_LANGUAGE</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>가져오는 방식은 대부분 동일하였다. settings로 SPF_CONFIG를 가져온 뒤 특정 값을 return으로 넘겨주는 방식이었다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setConfigLocalLanguage</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">int</span> <span class="n">languageCode</span><span class="o">){</span>
    <span class="nc">SharedPreferences</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getSharedPreferences</span><span class="o">(</span><span class="no">SPF_CONFIG</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="nc">SharedPreferences</span><span class="o">.</span><span class="na">Editor</span> <span class="no">PE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="na">edit</span><span class="o">();</span>
    <span class="no">PE</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="no">CONFIG_LOCAL_LANGUAGE</span><span class="o">,</span> <span class="n">languageCode</span><span class="o">);</span>

    <span class="c1">// Changed it as apply is more faster than commit which means async</span>
    <span class="no">PE</span><span class="o">.</span><span class="na">apply</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>마찬가지로 set도 같은 방식으로 정보를 가져온 뒤 edit를 할 수 있게 Editor를 할당한다. 그 후 putInt와 같은 명령어를 통해 해당 값을 넣어주게 된다. 원본의 코드에서는 PE.commit()이 사용되었는데 해당 예제와 같이 return 값에 대한 처리가 필요하지 않은 경우에는 apply로 바꿈으로써 비동기로 진행하여 더 빠른 처리를 할 수 있다고 한다. 그리하여 apply로 모든 코드를 변경하였다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onResume</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onResume</span><span class="o">();</span>
    <span class="c1">//This apk is first install or was updated</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">SPFManager</span><span class="o">.</span><span class="na">getVersionCode</span><span class="o">(</span><span class="nc">InitActivity</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">&lt;</span> <span class="nc">BuildConfig</span><span class="o">.</span><span class="na">VERSION_CODE</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">TV_init_message</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="nc">View</span><span class="o">.</span><span class="na">VISIBLE</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">initHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">InitTask</span><span class="o">(</span><span class="nc">InitActivity</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="nc">InitActivity</span><span class="o">.</span><span class="na">this</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">},</span> <span class="n">initTime</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>InitTask는 onResume 부분에서 initTime인 2500(2.5초)의 대기시간을 가진 뒤 postDelayed에 의해 호출이 된다. InitTask는 AsyncTask를 상속받는데 AsyncTask의 선언방식에 대해서 알아보았다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InitTask</span> <span class="kd">extends</span> <span class="nc">AsyncTask</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">Void</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="o">{</span>
</code></pre></div></div>

<p>3가지 파라미터는 각각 다른 의미를 내포한다. 첫 번째 파라미터는 background 작업에 사용할 data 자료형을 의미하며, background 작업 진행 표시를 위해 사용할 인자가 두 번째 파라미터, 작업의 결과를 표현할 자료형을 세 번째 파라미터로 지정해준다.</p>

<p>AsyncTask 또한 특정 루틴이 존재하는데 onPreExecuted는 백그라운드 작업이 활성화되기 전에 수행되며 만약 AsyncTask가 이미지 관련 작업을 처리 중인 상태라면 로딩 중임을 표시하는 이미지 띄워넣기 등의 작업을 수행하기 위해 사용된다. 그 후 백그라운드 작업을 수행하게 되는데 doInBackground는 execute를 호출한 당시를 인자로 받아서 수행을 하게 되는데 위 예제에서 context와 callback이 이에 해당된다. 그리고 publishProgress와 같이 진행 상태를 나타내는데 사용되는 메소드들이 존재하며 doInBackground 작업이 마무리되면 onPostExecuted가 호출이 되면서 결과를 리턴해주어 쓰레드 작업이 끝난 뒤의 행동을 수행하도록 한다. 다만 execute의 호출을 UIThread에서 해주어야 되며 Task가 한 번만 실행가능하다는 단점이 있다.</p>

<p>InitTask에서는 doInBackground 부근에서는 DB로부터 sampleData를 가져오는 역할을 수행하고 onPostExecute는 결과값을 InitCallback 인터페이스의 onInitCompiled 메소드로 반환하게 된다.</p>

<p>doInBackground 부분에서 SQLite DB와 관련된 작업을 수행하는데 이를 위해 db라는 패키지가 존재한다. 안드로이드의 SQLite DataBase는 Contract, Helper, Database로 크게 나뉘는데 Contract는 코드상에서 DBStructure에 해당되며 어떤식으로 계약을 진행할지 나타내는 문서가 되며 Helper는 계약서의 내용을 가져와 CRUD 작업을 수행하며 이를 위한 DB구조가 DBStructure에 명시되어 있다고 보면 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DBStructure</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">DiaryEntry</span> <span class="kd">implements</span> <span class="nc">BaseColumns</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TABLE_NAME</span> <span class="o">=</span> <span class="s">"diary_entry"</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COLUMN_TIME</span> <span class="o">=</span> <span class="s">"diary_time"</span><span class="o">;</span>
        <span class="c1">//Fix  diary_count -&gt; diary_title in V2</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COLUMN_TITLE</span> <span class="o">=</span> <span class="s">"diary_count"</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COLUMN_CONTENT</span> <span class="o">=</span> <span class="s">"diary_content"</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COLUMN_MOOD</span> <span class="o">=</span> <span class="s">"diary_mood"</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COLUMN_WEATHER</span> <span class="o">=</span> <span class="s">"diary_weather"</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COLUMN_ATTACHMENT</span> <span class="o">=</span> <span class="s">"diary_attachment"</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COLUMN_REF_TOPIC__ID</span> <span class="o">=</span> <span class="s">"diary_ref_topic_id"</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">COLUMN_LOCATION</span> <span class="o">=</span> <span class="s">"diary_location"</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>DBStructure 클래스는 BaseColumns로 구현하는데 DiaryEntry에 대한 Column정보를 상수 문자열로 정의해준다. diary_entry라는 이름을 가진 계약서는 time, title, content 등의 컬럼을 가지게 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">SQL_CREATE_DIARY_ENTRIES</span> <span class="o">=</span>
        <span class="s">"CREATE TABLE "</span> <span class="o">+</span> <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">TABLE_NAME</span> <span class="o">+</span> <span class="s">" ("</span> <span class="o">+</span>
                <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">_ID</span> <span class="o">+</span> <span class="no">INTEGER_TYPE</span> <span class="o">+</span> <span class="s">" PRIMARY KEY AUTOINCREMENT,"</span> <span class="o">+</span>
                <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_TIME</span> <span class="o">+</span> <span class="no">INTEGER_TYPE</span> <span class="o">+</span> <span class="no">COMMA_SEP</span> <span class="o">+</span>
                <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_TITLE</span> <span class="o">+</span> <span class="no">TEXT_TYPE</span> <span class="o">+</span> <span class="no">COMMA_SEP</span> <span class="o">+</span>
                <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_CONTENT</span> <span class="o">+</span> <span class="no">TEXT_TYPE</span> <span class="o">+</span> <span class="no">COMMA_SEP</span> <span class="o">+</span>
                <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_MOOD</span> <span class="o">+</span> <span class="no">INTEGER_TYPE</span> <span class="o">+</span> <span class="no">COMMA_SEP</span> <span class="o">+</span>
                <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_WEATHER</span> <span class="o">+</span> <span class="no">INTEGER_TYPE</span> <span class="o">+</span> <span class="no">COMMA_SEP</span> <span class="o">+</span>
                <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_ATTACHMENT</span> <span class="o">+</span> <span class="no">INTEGER_TYPE</span> <span class="o">+</span> <span class="no">COMMA_SEP</span> <span class="o">+</span>
                <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_REF_TOPIC__ID</span> <span class="o">+</span> <span class="no">INTEGER_TYPE</span> <span class="o">+</span> <span class="no">COMMA_SEP</span> <span class="o">+</span>
                <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_LOCATION</span> <span class="o">+</span> <span class="no">TEXT_TYPE</span> <span class="o">+</span> <span class="no">COMMA_SEP</span> <span class="o">+</span>
                <span class="no">FOREIGN</span> <span class="o">+</span> <span class="s">" ("</span> <span class="o">+</span> <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_REF_TOPIC__ID</span> <span class="o">+</span> <span class="s">")"</span> <span class="o">+</span> <span class="no">REFERENCES</span> <span class="o">+</span> <span class="nc">TopicEntry</span><span class="o">.</span><span class="na">TABLE_NAME</span> <span class="o">+</span> <span class="s">"("</span> <span class="o">+</span> <span class="nc">TopicEntry</span><span class="o">.</span><span class="na">_ID</span> <span class="o">+</span> <span class="s">")"</span> <span class="o">+</span>
                <span class="s">" )"</span><span class="o">;</span>
</code></pre></div></div>

<p>helper부분을 보면 SQL_CREATE_DIARY_ENTRIES라는 문자열을 볼 수 있는데, DBStructure에서 정의한 값들에 대한 쿼리문을 나태는데 사용된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">SQLiteDatabase</span> <span class="n">db</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="no">SQL_CREATE_TOPIC_ENTRIES</span><span class="o">);</span>
    <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="no">SQL_CREATE_TOPIC_ORDER</span><span class="o">);</span>

    <span class="c1">//Diary V2 work from db version 4</span>
    <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="no">SQL_CREATE_DIARY_ENTRIES_V2</span><span class="o">);</span>
    <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="no">SQL_CREATE_DIARY_ITEM_ENTRIES_V2</span><span class="o">);</span>

    <span class="c1">//Add memo order table in version 6</span>
    <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="no">SQL_CREATE_MEMO_ENTRIES</span><span class="o">);</span>
    <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="no">SQL_CREATE_MEMO_ORDER</span><span class="o">);</span>

    <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="no">SQL_CREATE_CONTACTS_ENTRIES</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>DBHelper의 onCreate부분을 보면 execSQL로 db에 테이블을 생성해주는데 db상에 이미 존재할 경우 예외가 발생되기 때문에 주의해서 사용하여야 한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onUpgrade</span><span class="o">(</span><span class="nc">SQLiteDatabase</span> <span class="n">db</span><span class="o">,</span> <span class="kt">int</span> <span class="n">oldVersion</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newVersion</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newVersion</span> <span class="o">&gt;</span> <span class="n">oldVersion</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">db</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">oldVersion</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">oldVersion</span><span class="o">++;</span>
                <span class="nc">String</span> <span class="n">addLocationSql</span> <span class="o">=</span> <span class="s">"ALTER TABLE  "</span> <span class="o">+</span> <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">TABLE_NAME</span> <span class="o">+</span> <span class="s">" ADD COLUMN "</span> <span class="o">+</span> <span class="nc">DiaryEntry</span><span class="o">.</span><span class="na">COLUMN_LOCATION</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="no">TEXT_TYPE</span><span class="o">;</span>
                <span class="nc">String</span> <span class="n">addTopicOrderSql</span> <span class="o">=</span> <span class="s">"ALTER TABLE  "</span> <span class="o">+</span> <span class="nc">TopicEntry</span><span class="o">.</span><span class="na">TABLE_NAME</span> <span class="o">+</span> <span class="s">" ADD COLUMN "</span> <span class="o">+</span> <span class="nc">TopicEntry</span><span class="o">.</span><span class="na">COLUMN_ORDER</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="no">INTEGER_TYPE</span><span class="o">;</span>
                <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="n">addLocationSql</span><span class="o">);</span>
                <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="n">addTopicOrderSql</span><span class="o">);</span>
                <span class="n">db</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="no">SQL_CREATE_MEMO_ENTRIES</span><span class="o">);</span>
            <span class="o">}</span>

                <span class="c1">//Check update success</span>
            <span class="n">db</span><span class="o">.</span><span class="na">setTransactionSuccessful</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">db</span><span class="o">.</span><span class="na">endTransaction</span><span class="o">();</span>
        <span class="o">}</span>
</code></pre></div></div>

<p>버전의 경우 newVersion과 oldVersion을 확인한 뒤 sql문을 작성하여 execSQL을 하는 것을 확인할 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">openDB</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">SQLException</span><span class="o">{</span>
    <span class="n">mDBHelper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DBHelper</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">db</span> <span class="o">=</span> <span class="n">mDBHelper</span><span class="o">.</span><span class="na">getWritableDatabase</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">closeDB</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">mDBHelper</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>DBManger 부분의 opeDB는 위에서 정의한 Helper를 정의한 뒤 getWritableDatabase()를 호출하여 데이터베이스 객체를 가져온다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">beginTransaction</span><span class="o">(){</span>
    <span class="n">db</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTransactionSuccessful</span><span class="o">(){</span>
    <span class="n">db</span><span class="o">.</span><span class="na">setTransactionSuccessful</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">endTransaction</span><span class="o">(){</span>
    <span class="n">db</span><span class="o">.</span><span class="na">endTransaction</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>쿼리 작업을 할 때 호출되는 트랜젝션 관련 명령어도 DBManager의 해당 함수들을 호출함으로써 제어하게 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">long</span> <span class="nf">insertTopic</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">int</span> <span class="n">color</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span>
            <span class="nc">TopicEntry</span><span class="o">.</span><span class="na">TABLE_NAME</span><span class="o">,</span>
            <span class="kc">null</span><span class="o">,</span>
            <span class="k">this</span><span class="o">.</span><span class="na">createTopicCV</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">color</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">long</span> <span class="nf">insertTopicOrder</span><span class="o">(</span><span class="kt">long</span> <span class="n">topicId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ContentValues</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ContentValues</span><span class="o">();</span>
    <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">TopicOrderEntry</span><span class="o">.</span><span class="na">COLUMN_ORDER</span><span class="o">,</span> <span class="n">order</span><span class="o">);</span>
    <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">TopicOrderEntry</span><span class="o">.</span><span class="na">COLUMN_REF_TOPIC__ID</span><span class="o">,</span> <span class="n">topicId</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span>
            <span class="nc">TopicOrderEntry</span><span class="o">.</span><span class="na">TABLE_NAME</span><span class="o">,</span>
            <span class="kc">null</span><span class="o">,</span>
            <span class="n">values</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">long</span> <span class="nf">updateTopic</span><span class="o">(</span><span class="kt">long</span> <span class="n">topicId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">color</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ContentValues</span> <span class="n">values</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ContentValues</span><span class="o">();</span>
    <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">TopicEntry</span><span class="o">.</span><span class="na">COLUMN_NAME</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
    <span class="n">values</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">TopicEntry</span><span class="o">.</span><span class="na">COLUMN_COLOR</span><span class="o">,</span> <span class="n">color</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="na">update</span><span class="o">(</span>
            <span class="nc">TopicEntry</span><span class="o">.</span><span class="na">TABLE_NAME</span><span class="o">,</span>
            <span class="n">values</span><span class="o">,</span>
            <span class="nc">TopicEntry</span><span class="o">.</span><span class="na">_ID</span> <span class="o">+</span> <span class="s">" = ?"</span><span class="o">,</span>
            <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">topicId</span><span class="o">)});</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Topic과 관련된 메소드들을 보면 ContentValues 인스턴스를 생성하여 put으로 갑들을 넣은 뒤 insert를 통해 db에 삽입을 한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Cursor</span> <span class="nf">selectTopic</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Cursor</span> <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="na">rawQuery</span><span class="o">(</span><span class="s">"SELECT * FROM "</span> <span class="o">+</span> <span class="nc">TopicEntry</span><span class="o">.</span><span class="na">TABLE_NAME</span>
                    <span class="o">+</span> <span class="s">" LEFT OUTER JOIN "</span> <span class="o">+</span> <span class="nc">TopicOrderEntry</span><span class="o">.</span><span class="na">TABLE_NAME</span>
                    <span class="o">+</span> <span class="s">" ON "</span> <span class="o">+</span> <span class="nc">TopicEntry</span><span class="o">.</span><span class="na">_ID</span> <span class="o">+</span> <span class="s">" = "</span> <span class="o">+</span> <span class="nc">TopicOrderEntry</span><span class="o">.</span><span class="na">COLUMN_REF_TOPIC__ID</span>
                    <span class="o">+</span> <span class="s">" ORDER BY "</span> <span class="o">+</span> <span class="nc">TopicOrderEntry</span><span class="o">.</span><span class="na">COLUMN_ORDER</span> <span class="o">+</span> <span class="s">" DESC "</span>
            <span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">c</span><span class="o">.</span><span class="na">moveToFirst</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>selectTopic은 rawQuery라는 명령어로 직접 쿼리문을 작성하였는데 LEFT OUTER JOIN이라는 키워드가 보인다.</p>

<p><a href="https://coding-factory.tistory.com/87">JOIN의 종류설명</a></p>

<p>이는 테이블이 연관된 경우 교집합, 합집합 등을 가져오기 위한 것으로 LEFT OUTER JOIN을 사용한 위 쿼리는 TopicEntry의 내용을 조회하되 TopicEntry의 ID를 REF_TOPIC_ID로 가지고 있는 TopicOrderEntry들에 대한 값도 같이 가져온다는 의미이며 이렇게 가져온 값을 COLUMN_ORDER를 기준으로 DESC 즉, 내림차 순으로 정렬해서 가져온다는 의미이다. 위의 블로그에서 다이어그램을 확인하면 쉽게 이해가 가능하다.</p>

<p><a href="https://using.tistory.com/62">FileUtils</a></p>

<p>프로젝트 내에서 FileUtils를 활용하여 아래와 같은 처리를 수행하는 코드들이 존재한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nc">FileUtils</span><span class="o">.</span><span class="na">deleteDirectory</span><span class="o">(</span><span class="n">destDir</span><span class="o">);</span>
</code></pre></div></div>

<p>apache에서 배포한 것으로 org.apache.commons.io.FileUtils를 import하여 사용할 수 있다. 이를 사용하기 위해서는 gradle에서 implementation을 추가해주면 된다. 현재 버전이 2.7까지 나온것으로 확인되지만 해당 프로젝트에서 사용한 버전이 2.5이기 때문에 이를 사용하도록 한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="err">'</span><span class="n">commons</span><span class="o">-</span><span class="nl">io:</span><span class="n">commons</span><span class="o">-</span><span class="nl">io:</span><span class="mf">2.5</span><span class="err">'</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDiaryApplication</span> <span class="kd">extends</span> <span class="nc">Application</span> <span class="o">{</span>

    <span class="kt">boolean</span> <span class="n">hasPassword</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
        <span class="c1">//Use Fresco</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">RequestListener</span><span class="o">&gt;</span> <span class="n">listeners</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
        <span class="n">listeners</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">RequestLoggingListener</span><span class="o">());</span>
        <span class="nc">ImagePipelineConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="nc">ImagePipelineConfig</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setRequestListeners</span><span class="o">(</span><span class="n">listeners</span><span class="o">)</span>
                <span class="o">.</span><span class="na">setDownsampleEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="nc">Fresco</span><span class="o">.</span><span class="na">initialize</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
</code></pre></div></div>

<p>MyDiaryApplication 부분을 보면 Application으로 정의가 되어 있음을 확인할 수 있다. Application으로 정의된 클래스는 안드로이드 컴포넌트들 사이에서 공유가 가능한 클래스로 공동으로 사용될 항목들을 작성해두면 context를 통해 접근이 가능하다. 그리고 이렇게 생성된 Application은 매니페스트에 정의가 되어 있어야 된다.</p>

<p>Fresco는 페이스북에 만든 라이브러리로 이미지와 관련된 작업을 수행하는데 효율적이다. 캐싱을 지원해서 속도적인 측면에서도 우위를 점할 수 있는데, Application 레벨에서 초기화가 진행되어야 하기 때문에 어플리케이션의 onCreate에 추가되었다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">AppCompatDelegate</span><span class="o">.</span><span class="na">setDefaultNightMode</span><span class="o">(</span><span class="nc">AppCompatDelegate</span><span class="o">.</span><span class="na">MODE_NIGHT_NO</span><span class="o">);</span>
</code></pre></div></div>

<p>AndroidQ부터 NIGHT 시간에는 테마의 색깔이 변하는 설정이 있는데 위의 코드로 해당 기능을 비활성화해준다.</p>

<h3 id="passwordactivity">PasswordActivity</h3>

<p>패스워드가 설정된 경우 호출이 되는 액티비티로 주요 기능을 사용자로부터 패스워드를 입력받아 설정 또는 검증을 한다. 방식을 보면 로직은 간단하다. passwordPointer를 두고 사용자로부터 4자리를 입력받는다. 받을 때마다 pos를 옮기면서 조건문을 수행하며 그 과정에서 ImageResource를 입력결과에 따라 변경해준다. PorterDuff를 사용해서 원본이미지가 덮어씌어졌을때 이미지에 대한 처리도 진행한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">afterPasswordChanged</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">currentMode</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nl">CREATE_PASSWORD:</span>
            <span class="n">createdPassword</span> <span class="o">=</span> <span class="n">passwordStrBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="n">clearUiPassword</span><span class="o">();</span>
            <span class="n">currentMode</span> <span class="o">=</span> <span class="no">CREATE_PASSWORD_WITH_VERIFY</span><span class="o">;</span>
            <span class="n">initUI</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="nl">CREATE_PASSWORD_WITH_VERIFY:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">createdPassword</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">passwordStrBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">()))</span> <span class="o">{</span>
                <span class="n">setPassword</span><span class="o">(</span><span class="nc">Encryption</span><span class="o">.</span><span class="na">SHA256</span><span class="o">(</span><span class="n">passwordStrBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
                <span class="o">((</span><span class="nc">MyDiaryApplication</span><span class="o">)</span> <span class="n">getApplication</span><span class="o">()).</span><span class="na">setHasPassword</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
                <span class="n">finish</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">clearUiPassword</span><span class="o">();</span>
                <span class="n">setSubMessage</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
</code></pre></div></div>

<p>Mode에 따라 타는 루틴이 다른데 setPassword부분은 SharedPreference에 패스워드 값을 넣어주는 역할을 한다. 그 인자로 들어가는 값은 사용자로부터 버튼에 클릭된 4자리의 숫자 문자열의 암호화값인데 이를 위해 Encryption이라는 클래스가 존재한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Encryption</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">Encrypt</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">,</span> <span class="nc">String</span> <span class="n">encryptionMethod</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">encoded</span><span class="o">;</span>

        <span class="nc">MessageDigest</span> <span class="n">md</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">md</span> <span class="o">=</span> <span class="nc">MessageDigest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">encryptionMethod</span><span class="o">);</span>
            <span class="n">md</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">byteData</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="na">digest</span><span class="o">();</span>
            <span class="nc">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">();</span>
            <span class="k">for</span><span class="o">(</span><span class="kt">byte</span> <span class="n">aByteData</span> <span class="o">:</span> <span class="n">byteData</span><span class="o">){</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">((</span><span class="n">aByteData</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="o">)</span> <span class="o">+</span> <span class="mh">0x100</span><span class="o">,</span> <span class="mi">16</span><span class="o">).</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
            <span class="o">}</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchAlgorithmException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">encoded</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Encrypt는 Method정보를 받아서 수행하는데 MD5, SHA-256이 이에 해당된다. 이렇게 받은 정보를 토대로 digest를 수행한 뒤 append를 수행하는데 보면 0xff로 앤드 연산을 처리한 뒤 0x100을 더하고, substring(1)을 하는 행위를 반복한다.</p>

<p>어떤 행위인지 궁금해서 찾아봤더니 설명된 블로그가 존재하였다.</p>

<p><a href="https://javaslave.tistory.com/59">byte to hexstrings</a></p>

<p>쉽게 설명해서 16진수 값의 범위를 나타내기 위함인데 0x10전까지는 한자리의 값인 0x1, 0xf 등을 가지므로 이를 맞춰주기 위해서 0x101, 0x10f와 같이 만들어준 뒤, 자릿수를 맞추기 위해 맨 앞에 더해진 1을 빼서 0x01, 0x0f와 같이 만들어주는 과정이다. 이를 통해 동일한 자릿수를 만들 수 있다. 이렇게 해쉬화 된 값을 가지고 결과를 확인하는 행위를 하는 액티비티이다.</p>

<h3 id="mainactivity">MainActivity</h3>

<p>PasswordActivity 또는 InitActivity가 호출된 직후에 처리되는 루틴인데 본격적으로 RecyclerView가 사용되기 시작한다. 여기서 참신한 라이브러리를 알게 되는데 android-advancedrecyclerview이다. 직접 구현했던 여러 swipe과 같은 기능들을 오픈소스로 구현해둔 것으로 아래의 깃에서 확인이 가능하다.</p>

<p><a href="https://github.com/h6ah4i/android-advancedrecyclerview">advanced recyclerView</a></p>

<p>ITopic을 자료로 사용하는 MainTopicAdapter 부분을 분해해 볼 차례이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ITopic</span> <span class="o">{</span>
    <span class="cm">/**
     * The contacts , Mitsuha  and Taki change their cell phone number in this function.
     */</span>
    <span class="kt">int</span> <span class="no">TYPE_CONTACTS</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="cm">/**
     * Mitsuha and Taki write daily diary when their soul change.
     */</span>
    <span class="kt">int</span> <span class="no">TYPE_DIARY</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="cm">/**
     * Mitsuha and Taki add some memo to notice that something can't do.
     */</span>
    <span class="kt">int</span> <span class="no">TYPE_MEMO</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="nc">String</span> <span class="nf">getTitle</span><span class="o">();</span>

    <span class="cm">/**
     * For update topic
     */</span>
    <span class="kt">void</span> <span class="nf">setTitle</span><span class="o">(</span><span class="nc">String</span> <span class="n">title</span><span class="o">);</span>

    <span class="kt">int</span> <span class="nf">getType</span><span class="o">();</span>

    <span class="kt">long</span> <span class="nf">getId</span><span class="o">();</span>

    <span class="nd">@DrawableRes</span>
    <span class="kt">int</span> <span class="nf">getIcon</span><span class="o">();</span>

    <span class="cm">/**
     * For update count in Main Page
     */</span>
    <span class="kt">void</span> <span class="nf">setCount</span><span class="o">(</span><span class="kt">long</span> <span class="n">count</span><span class="o">);</span>

    <span class="kt">long</span> <span class="nf">getCount</span><span class="o">();</span>

    <span class="kt">int</span> <span class="nf">getColor</span><span class="o">();</span>

    <span class="cm">/**
     * For update topic
     */</span>
    <span class="kt">void</span> <span class="nf">setColor</span><span class="o">(</span><span class="kt">int</span> <span class="n">color</span><span class="o">);</span>

    <span class="cm">/**
     * For the left swipe
     */</span>

    <span class="kt">void</span> <span class="nf">setPinned</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">pinned</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">isPinned</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>나와는 다르게 interface를 ArrayList로 생성하여 사용하는 것을 확인할 수 있다. 그로 인하여 세부적인 구현에 대한 부분은 존재하지 않는다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">MainTopicAdapter</span><span class="o">(</span><span class="nc">MainActivity</span> <span class="n">activity</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ITopic</span><span class="o">&gt;</span> <span class="n">topicList</span><span class="o">,</span> <span class="nc">DBManager</span> <span class="n">dbManager</span><span class="o">){</span>
    <span class="k">this</span><span class="o">.</span><span class="na">activity</span> <span class="o">=</span> <span class="n">activity</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">originalTopicList</span> <span class="o">=</span> <span class="n">topicList</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">filteredTopicList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dbManager</span> <span class="o">=</span> <span class="n">dbManager</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>생성자의 경우도 context를 받는게 아닌 명시적으로 어떤 액티비티에서 들어올지를 판단하여 해당 액티비티를 변수로 가지고 있다는 점에서도 차이가 발생한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TopicViewHolder</span> <span class="kd">extends</span> <span class="nc">AbstractSwipeableItemViewHolder</span> <span class="o">{</span>
</code></pre></div></div>

<p>레이아웃과 연결해주는데 사용하는 TopicViewHoler의 정의 부분을 보면 AbstractSwipeableItemViewHolder를 상속받아 라이브러리를 적용한다는 점 또한 확인이 가능하다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TopicFilter</span> <span class="kd">extends</span> <span class="nc">Filter</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MainTopicAdapter</span> <span class="n">adapter</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ITopic</span><span class="o">&gt;</span> <span class="n">originalList</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ITopic</span><span class="o">&gt;</span> <span class="n">filteredList</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isFilter</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">TopicFilter</span><span class="o">(</span><span class="nc">MainTopicAdapter</span> <span class="n">adapter</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ITopic</span><span class="o">&gt;</span> <span class="n">originalList</span><span class="o">){</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">originalList</span> <span class="o">=</span> <span class="n">originalList</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">filteredList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">FilterResults</span> <span class="nf">performFiltering</span><span class="o">(</span><span class="nc">CharSequence</span> <span class="n">constraint</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">filteredList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>

        <span class="kd">final</span> <span class="nc">FilterResults</span> <span class="n">results</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FilterResults</span><span class="o">();</span>

        <span class="k">if</span><span class="o">(</span><span class="n">constraint</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
            <span class="n">filteredList</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">originalList</span><span class="o">);</span>
            <span class="n">isFilter</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">String</span> <span class="n">filterPattern</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">trim</span><span class="o">();</span>
            <span class="k">for</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ITopic</span> <span class="n">topic</span> <span class="o">:</span> <span class="n">originalList</span><span class="o">){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">topic</span><span class="o">.</span><span class="na">getTitle</span><span class="o">().</span><span class="na">toLowerCase</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="n">filterPattern</span><span class="o">)){</span>
                    <span class="n">filteredList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">isFilter</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">results</span><span class="o">.</span><span class="na">values</span> <span class="o">=</span> <span class="n">filteredList</span><span class="o">;</span>
        <span class="n">results</span><span class="o">.</span><span class="na">count</span> <span class="o">=</span> <span class="n">filteredList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">results</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">publishResults</span><span class="o">(</span><span class="nc">CharSequence</span> <span class="n">constraint</span><span class="o">,</span> <span class="nc">FilterResults</span> <span class="n">results</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">adapter</span><span class="o">.</span><span class="na">filteredTopicList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">adapter</span><span class="o">.</span><span class="na">filteredTopicList</span><span class="o">.</span><span class="na">addAll</span><span class="o">((</span><span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ITopic</span><span class="o">&gt;)</span> <span class="n">results</span><span class="o">.</span><span class="na">values</span><span class="o">);</span>
        <span class="n">adapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>Filterable은 인스타그램 프로젝트에서도 사용한 적이 있는데 Charsequence를 바탕으로 필터링을 진행하는 performFiltering과 filtering 작업이 끝난뒤에 호출되는 publishResults가 정의되어 있다. 방식은 내 코드와 거의 비슷하다고 봐도 무방한데 filteredPattern에 lowercase로 검색하여 조건에 만족하는 값들을 filteredlist로 옮긴 뒤 기존에 존재하던 filteredTopicList를 지우고 덮어씌우는 역할을 수행한다.</p>

<p>OnCreateViewHolder 부분에서는 RecyclerView의 아이템으로 사용할 레이아웃을 연결하는 작업만 수행하고 onBindViewHolder에서 나와 다르게 onClickListener를 추가해준 것이 확인이 가능하였다. 나라면 TopicViewHolder의 생성자부분에 listener를 달아주었을 것 같다. 아무래도 onBindViewHolder는 Holder를 바꾸는 과정에서 매번 호출이 되기 때문에 한 번만 수행해도 되는 행위가 여러분 수행되기 때문이다. 그래서 나는 다음과 같이 코드를 변경하였다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@NonNull</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">TopicViewHolder</span> <span class="nf">onCreateViewHolder</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ViewGroup</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">viewType</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">View</span> <span class="n">view</span> <span class="o">=</span> <span class="nc">LayoutInflater</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">parent</span><span class="o">.</span><span class="na">getContext</span><span class="o">()).</span><span class="na">inflate</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">rv_topic_item</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="kd">final</span> <span class="nc">TopicViewHolder</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopicViewHolder</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>

    <span class="n">holder</span><span class="o">.</span><span class="na">getRLTopic</span><span class="o">().</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">(){</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">gotoTopic</span><span class="o">(</span><span class="n">filteredTopicList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">getAdapterPosition</span><span class="o">()).</span><span class="na">getType</span><span class="o">(),</span> <span class="n">holder</span><span class="o">.</span><span class="na">getAdapterPosition</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">});</span>

    <span class="n">holder</span><span class="o">.</span><span class="na">getTopicLeftSettingEditView</span><span class="o">().</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO</span>
        <span class="o">}</span>
    <span class="o">});</span>

    <span class="n">holder</span><span class="o">.</span><span class="na">getTopicLeftSettingDeleteView</span><span class="o">().</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO</span>
        <span class="o">}</span>
    <span class="o">});</span>

    <span class="k">return</span> <span class="n">holder</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>holder의 position이 직접적으로 들어오지 않기 떄문에 getAdapterPosition을 활용하여 Adapter로부터 위치 정보를 가져오도록 한다. 이렇게 되면 예상치 못하게 pos 정보가 달라지는 경우에도 정확한 위치를 알아낼 수 있다는 장점이 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onCheckCanStartDrag</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">TopicViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>

    <span class="kd">final</span> <span class="nc">View</span> <span class="n">containerView</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getSwipeableContainerView</span><span class="o">();</span>

    <span class="kd">final</span> <span class="kt">int</span> <span class="n">offsetX</span> <span class="o">=</span> <span class="n">containerView</span><span class="o">.</span><span class="na">getLeft</span><span class="o">()</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="nc">ViewCompat</span><span class="o">.</span><span class="na">getTranslationX</span><span class="o">(</span><span class="n">containerView</span><span class="o">)</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="o">);</span>
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">offsetY</span> <span class="o">=</span> <span class="n">containerView</span><span class="o">.</span><span class="na">getTop</span><span class="o">()</span> <span class="o">+</span> <span class="o">(</span><span class="kt">int</span><span class="o">)(</span><span class="nc">ViewCompat</span><span class="o">.</span><span class="na">getTranslationY</span><span class="o">(</span><span class="n">containerView</span><span class="o">)</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="o">);</span>

    <span class="k">return</span> <span class="o">!</span><span class="n">topicFilter</span><span class="o">.</span><span class="na">isFilter</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="nc">ViewTools</span><span class="o">.</span><span class="na">hitTest</span><span class="o">(</span><span class="n">containerView</span><span class="o">,</span> <span class="n">x</span><span class="o">-</span><span class="n">offsetX</span><span class="o">,</span> <span class="n">y</span><span class="o">-</span><span class="n">offsetY</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Advanced RecyclerView를 위해서 구현해야 하는 메소드들이 몇개있는데 onCheckCanStartDrag는 행동을 하기 전에 해당 범위에 속해있는지를 검증할 때 사용된다. left좌표와 top의 좌표를 기준으로 holder의 크기 범위안에서 작업이 일어나는지를 확인하여 결과를 돌려준다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMoveItem</span><span class="o">(</span><span class="kt">int</span> <span class="n">fromPosition</span><span class="o">,</span> <span class="kt">int</span> <span class="n">toPosition</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">fromPosition</span> <span class="o">==</span> <span class="n">toPosition</span><span class="o">)</span> <span class="k">return</span><span class="o">;</span>

    <span class="kd">final</span> <span class="nc">ITopic</span> <span class="n">originalItem</span> <span class="o">=</span> <span class="n">originalTopicList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">fromPosition</span><span class="o">);</span>
    <span class="n">originalTopicList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">toPosition</span><span class="o">,</span> <span class="n">originalItem</span><span class="o">);</span>

    <span class="kd">final</span> <span class="nc">ITopic</span> <span class="n">filteredItem</span> <span class="o">=</span> <span class="n">filteredTopicList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">fromPosition</span><span class="o">);</span>
    <span class="n">filteredTopicList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">toPosition</span><span class="o">,</span> <span class="n">filteredItem</span><span class="o">);</span>

    <span class="kt">int</span> <span class="n">orderNumber</span> <span class="o">=</span> <span class="n">originalTopicList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">openDB</span><span class="o">();</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">deleteAllCurrentTopicOrder</span><span class="o">();</span>
    <span class="k">for</span><span class="o">(</span><span class="nc">ITopic</span> <span class="n">topic</span> <span class="o">:</span> <span class="n">originalTopicList</span><span class="o">){</span>
        <span class="n">dbManager</span><span class="o">.</span><span class="na">insertTopicOrder</span><span class="o">(</span><span class="n">topic</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="o">--</span><span class="n">orderNumber</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">closeDB</span><span class="o">();</span>
    <span class="n">notifyDataSetChanged</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>MoveEvent의 처리를 위한 방식으로 fromPosition의 값을 뺀 뒤, toPosition 뒤에 삽입한다. 그 후 dbManager를 통해 TopicOrder정보를 삭제한 뒤, 새롭게 추가한 뒤, adapter에 변화를 알리면서 끝을 낸다.</p>

<p><a href="https://github.com/HIREN4131KINAL/Advance-recycler2/blob/master/library/src/main/java/com/h6ah4i/android/widget/advrecyclerview/swipeable/SwipeableItemConstants.java">SwipeableItemAdapter</a></p>

<p>SwipeableItemAdapter 인터페이스를 implements 해주면 마찬가지로 오버라이딩이 필요한 메소드들이 존재한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">int</span> <span class="nf">onGetSwipeReactionType</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">TopicViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">ViewTools</span><span class="o">.</span><span class="na">hitTest</span><span class="o">(</span><span class="n">holder</span><span class="o">.</span><span class="na">getSwipeableContainerView</span><span class="o">(),</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">SwipeableItemConstants</span><span class="o">.</span><span class="na">REACTION_CAN_SWIPE_BOTH_H</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">SwipeableItemConstants</span><span class="o">.</span><span class="na">REACTION_CAN_NOT_SWIPE_BOTH_H</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>위와 같은 메소드인데 해당 enum값은 위의 링크에서 확인이 가능하다. onSetSwipeBackground의 경우 background color 등에 대한 정보를 변경할 수 있다고 한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Nullable</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">SwipeResultAction</span> <span class="nf">onSwipeItem</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">TopicViewHolder</span> <span class="n">holder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">int</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">result</span><span class="o">){</span>
        <span class="k">case</span> <span class="nc">SwipeableItemConstants</span><span class="o">.</span><span class="na">RESULT_SWIPED_RIGHT</span><span class="o">:</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">SwipeRightResultAction</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">position</span><span class="o">);</span>
        <span class="k">case</span> <span class="nc">SwipeableItemConstants</span><span class="o">.</span><span class="na">RESULT_SWIPED_LEFT</span><span class="o">:</span>
        <span class="k">case</span> <span class="nc">SwipeableItemConstants</span><span class="o">.</span><span class="na">RESULT_CANCELED</span><span class="o">:</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">position</span> <span class="o">!=</span> <span class="nc">RecyclerView</span><span class="o">.</span><span class="na">NO_POSITION</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nf">UnpinResultAction</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">position</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>                
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>onSwipeItem은 swap이벤트에 대한 처리를 담당하는 부분으로 RIGHT인 경우와 LEFT/CANCELED/DEFAULT인 경우로 나누어 처리해준다. 여기서 사용되는 리턴값은 재정의된 클래스이다.</p>

<p>다시 MainActivity의 onCreate로 돌아와서 보면 layout에 대한 할당 과정이 진행된 뒤에 initProfile이 호출이 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">initProfile</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nc">YourNameIs</span> <span class="o">=</span> <span class="nc">SPFManager</span><span class="o">.</span><span class="na">getYourName</span><span class="o">(</span><span class="nc">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">YourNameIs</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="nc">YourNameIs</span><span class="o">)){</span>
        <span class="nc">YourNameIs</span> <span class="o">=</span> <span class="n">themeManager</span><span class="o">.</span><span class="na">getThemeUserName</span><span class="o">(</span><span class="nc">MainActivity</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">TV_main_profile_username</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="nc">YourNameIs</span><span class="o">);</span>
    <span class="n">LL_main_profile</span><span class="o">.</span><span class="na">setBackground</span><span class="o">(</span><span class="n">themeManager</span><span class="o">.</span><span class="na">getProfileBgDrawable</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>

<p>해당 함수는 SharedPreference에 이름 정보가 없을 경우 default값을 세팅하는 용도로 사용된다. 또 다른 중요한 메소드인 initTopicAdapter을 보도록 하자.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">initTopicAdapter</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">mRecyclerViewSwipeManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RecyclerViewSwipeManager</span><span class="o">();</span>

    <span class="c1">// touch guard manager  (this class is required to suppress scrolling while swipe-dismiss animation is running)</span>
    <span class="n">mRecyclerViewTouchActionGuardManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RecyclerViewTouchActionGuardManager</span><span class="o">();</span>
    <span class="n">mRecyclerViewTouchActionGuardManager</span><span class="o">.</span><span class="na">setInterceptVerticalScrollingWhileAnimationRunning</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">mRecyclerViewTouchActionGuardManager</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

    <span class="nc">LinearLayoutManager</span> <span class="n">lmr</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinearLayoutManager</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">RecyclerView_topic</span><span class="o">.</span><span class="na">setLayoutManager</span><span class="o">(</span><span class="n">lmr</span><span class="o">);</span>
    <span class="n">RecyclerView_topic</span><span class="o">.</span><span class="na">setHasFixedSize</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">mainTopicAdapter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MainTopicAdapter</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">topicList</span><span class="o">,</span> <span class="n">dbManager</span><span class="o">);</span>
    <span class="n">mWrappedAdapter</span> <span class="o">=</span> <span class="n">mRecyclerViewSwipeManager</span><span class="o">.</span><span class="na">createWrappedAdapter</span><span class="o">(</span><span class="n">mainTopicAdapter</span><span class="o">);</span>

    <span class="kd">final</span> <span class="nc">GeneralItemAnimator</span> <span class="n">animator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DraggableItemAnimator</span><span class="o">();</span>
    <span class="n">animator</span><span class="o">.</span><span class="na">setSupportsChangeAnimations</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    
    <span class="n">mRecyclerViewDragDropManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RecyclerViewDragDropManager</span><span class="o">();</span>
    <span class="n">mRecyclerViewDragDropManager</span><span class="o">.</span><span class="na">setInitiateOnMove</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="n">mWrappedAdapter</span> <span class="o">=</span> <span class="n">mRecyclerViewDragDropManager</span><span class="o">.</span><span class="na">createWrappedAdapter</span><span class="o">(</span><span class="n">mWrappedAdapter</span><span class="o">);</span>
    
    <span class="n">RecyclerView_topic</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="n">mWrappedAdapter</span><span class="o">);</span>
    <span class="n">RecyclerView_topic</span><span class="o">.</span><span class="na">setItemAnimator</span><span class="o">(</span><span class="n">animator</span><span class="o">);</span>
</code></pre></div></div>

<p>RecyclerView에 사용되는 여러 변수들이 초기화 된다. RecyclerView의 경우 LinearLayoutManager로 정의가 된 뒤 mainTopicAdapter로 빈 ArrayList와 같이 초기화 된다. 그 후 setAdapter를 통해 DragDropManager로 wrapped 된 adapter를 recyclerView에 붙혀준다.</p>

<p>초기화가 끝나게 되면 DB로부터 Topic에 대한 항목들을 가져오는데 그 항목들은 3가지로 Contacts, Diary, Memo가 이에 해당된다. ITopic 인터페이스를 상속받는 객체들로 loadTopic에서는 이에 대한 처리가 진행된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadTopic</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">topicList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="nc">Cursor</span> <span class="n">topicCursor</span> <span class="o">=</span> <span class="n">dbManager</span><span class="o">.</span><span class="na">selectTopic</span><span class="o">();</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">topicCursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++){</span>
        <span class="k">switch</span><span class="o">(</span><span class="n">topicCursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">2</span><span class="o">)){</span>
            <span class="k">case</span> <span class="nc">ITopic</span><span class="o">.</span><span class="na">TYPE_CONTACTS</span><span class="o">:</span>
                <span class="n">topicList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nf">Contacts</span><span class="o">(</span><span class="n">topicCursor</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
                                <span class="n">topicCursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span><span class="n">topicCursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">5</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nc">ITopic</span><span class="o">.</span><span class="na">TYPE_DIARY</span><span class="o">:</span>
                <span class="n">topicList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nf">Diary</span><span class="o">(</span><span class="n">topicCursor</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
                                <span class="n">topicCursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
                                <span class="n">topicCursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">5</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="nc">ITopic</span><span class="o">.</span><span class="na">TYPE_MEMO</span><span class="o">:</span>
                <span class="n">topicList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nf">Memo</span><span class="o">(</span><span class="n">topicCursor</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
                                <span class="n">topicCursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
                                <span class="n">topicCursor</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">5</span><span class="o">)));</span>
                <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">topicCursor</span><span class="o">.</span><span class="na">moveToNext</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">topicCursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>topicList는 그 형태에 맞게 초기화가 진행된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">Contacts</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="kt">int</span> <span class="n">color</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">color</span> <span class="o">=</span> <span class="n">color</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Contacts의 생성자를 보면 id, title, color에 대한 정보를 가져오는 것을 확인할 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dbManager</span><span class="o">.</span><span class="na">openDB</span><span class="o">();</span>
<span class="n">loadTopic</span><span class="o">();</span>
<span class="n">dbManager</span><span class="o">.</span><span class="na">closeDB</span><span class="o">();</span>
<span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</code></pre></div></div>

<p>해당 작업이 마무리되면 notifyDataSetChanged로 viewholder에 들어갈 리스트에 대한 정보가 변경되었음을 알려준다. OOBE 부분은 사용자가 처음 실행하는 경우에 설명을 알려주기 위해서 호출되는 부분인데 생략하도록 한다.</p>

<p>여기까지하고 실행할 경우 unique_id 관련 문제가 발생한다. setHasStablesIds(boolean)을 adapter에 추가해주어야 되는데 이는 각각의 아이템 항목이 고유한 번호를 가지고 있음을 보장한다는 의미이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">long</span> <span class="nf">getItemId</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">filteredTopicList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">getId</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>이를 위해서는 getItemID를 재정의하여 고유한 id를 가질 수 있도록 보장해주어야 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="o">(</span><span class="n">getIntent</span><span class="o">().</span><span class="na">getBooleanExtra</span><span class="o">(</span><span class="s">"showReleaseNote"</span><span class="o">,</span> <span class="kc">false</span><span class="o">)){</span>
    <span class="nc">ReleaseNoteDialogFragment</span> <span class="n">releaseNoteDialogFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReleaseNoteDialogFragment</span><span class="o">();</span>
    <span class="n">releaseNoteDialogFragment</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">getSupportFragmentManager</span><span class="o">(),</span> <span class="s">"releaseNoteDialogFragment"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p>onCreate의 마지막부분에 DiaglogFragment를 실행하는 부분이 있다. 액티비티위에 Dialog 형식으로 띄울 수 있는데 해당 기능을 구현하는 Fragment이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@NonNull</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">Dialog</span> <span class="nf">onCreateDialog</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Dialog</span> <span class="n">dialog</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">onCreateDialog</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
    <span class="n">dialog</span><span class="o">.</span><span class="na">getWindow</span><span class="o">().</span><span class="na">requestFeature</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="na">FEATURE_NO_TITLE</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">dialog</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Nullable</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">getDialog</span><span class="o">().</span><span class="na">setCanceledOnTouchOutside</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="nc">View</span> <span class="n">rootView</span> <span class="o">=</span> <span class="n">inflater</span><span class="o">.</span><span class="na">inflate</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">dialog_fragment_release_note</span><span class="o">,</span> <span class="n">container</span><span class="o">);</span>

    <span class="n">RL_release_note</span> <span class="o">=</span> <span class="o">(</span><span class="nc">RelativeLayout</span><span class="o">)</span> <span class="n">rootView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">RL_release_note</span><span class="o">);</span>
    <span class="n">RL_release_note</span><span class="o">.</span><span class="na">setBackgroundColor</span><span class="o">(</span><span class="nc">ThemeManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getThemeMainColor</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()));</span>

    <span class="n">TV_release_note_text</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextView</span><span class="o">)</span> <span class="n">rootView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">TV_release_note_text</span><span class="o">);</span>
    <span class="n">TV_release_note_text</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">release_note</span><span class="o">));</span>

    <span class="n">CTV_release_note_knew</span> <span class="o">=</span> <span class="o">(</span><span class="nc">CheckedTextView</span><span class="o">)</span> <span class="n">rootView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">CTV_release_note_knew</span><span class="o">);</span>
    <span class="n">CTV_release_note_knew</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

    <span class="n">But_release_note_ok</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MyDiaryButton</span><span class="o">)</span> <span class="n">rootView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">But_release_note_ok</span><span class="o">);</span>
    <span class="n">But_release_note_ok</span><span class="o">.</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">rootView</span><span class="o">;</span>
<span class="o">}</span>

</code></pre></div></div>

<p>onCreateDialog에서는 dialog를 생성한 뒤 onCreateView 부분에서 레이아웃 작업을 수행한다. 그리고 onClick 리스너를 추가하여 버튼에 대한 동작을 구현하면 끝나게 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mRecyclerViewDragDropManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mRecyclerViewDragDropManager</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="n">mRecyclerViewDragDropManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mRecyclerViewSwipeManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mRecyclerViewSwipeManager</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="n">mRecyclerViewSwipeManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">mRecyclerViewTouchActionGuardManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">mRecyclerViewTouchActionGuardManager</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
        <span class="n">mRecyclerViewTouchActionGuardManager</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">RecyclerView_topic</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">RecyclerView_topic</span><span class="o">.</span><span class="na">setItemAnimator</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">RecyclerView_topic</span><span class="o">.</span><span class="na">setAdapter</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">RecyclerView_topic</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">mWrappedAdapter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">WrapperAdapterUtils</span><span class="o">.</span><span class="na">releaseAll</span><span class="o">(</span><span class="n">mWrappedAdapter</span><span class="o">);</span>
        <span class="n">mWrappedAdapter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">mainTopicAdapter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>onDestroy 부분을 살펴보면 어댑터와 연결된 요소들에 대한 release를 수행하고 Destroy를 수행한다.</p>

<p>YourNameDialogFragment 부분으로 가보도록 하자. 기본적인 DialogFragment 구현 부분은 거의 동일하니 생략하도록 하고, onClick 이벤트 부분을 살펴보도록 한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">case</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">IV_your_name_profile_picture</span><span class="o">:</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">PermissionHelper</span><span class="o">.</span><span class="na">checkPermission</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">REQUEST_WRITE_ES_PERMISSION</span><span class="o">))</span> <span class="o">{</span>
                <span class="nc">FileManager</span><span class="o">.</span><span class="na">startBrowseImageFile</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SELECT_PROFILE_PICTURE_BG</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">IV_your_name_profile_picture_cancel</span><span class="o">:</span>
            <span class="n">isAddNewProfilePicture</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">profilePictureFileName</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
            <span class="n">IV_your_name_profile_picture</span><span class="o">.</span><span class="na">setImageDrawable</span><span class="o">(</span>
                    <span class="nc">ViewTools</span><span class="o">.</span><span class="na">getDrawable</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="no">R</span><span class="o">.</span><span class="na">drawable</span><span class="o">.</span><span class="na">ic_person_picture_default</span><span class="o">));</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">But_your_name_ok</span><span class="o">:</span>
            <span class="n">saveYourName</span><span class="o">();</span>
            <span class="n">callback</span><span class="o">.</span><span class="na">updateName</span><span class="o">();</span>
            <span class="n">dismiss</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">But_your_name_cancel</span><span class="o">:</span>
            <span class="n">dismiss</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Dialog에는 cancel과 dismiss가 있고 차이가 있다. dismiss는 thread-safe하며 dialog를 화면에서 지우는 역할을 수행한다. 그리고 cancel의 경우 back 버튼을 누르는 것과 같은 상황에서도 호출이 되는데 dismiss루틴을 타기는 하지만 그 전에 cancel listener가 존재하면 콜백을 호출한 뒤에 dismiss를 실행한다는 점에서 차이가 있다.</p>

<p>그리고 해당 부분에서 이미지를 가져오기 위해서 Permission을 확인해야되는데 이를 담당하는 PermissionHelper 클래스를 확인할 수 있다. 해당 부분을 구현할 차례이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PermissionHelper</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">REQUEST_ACCESS_FINE_LOCATION_PERMISSION</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">REQUEST_CAMERA_AND_WRITE_ES_PERMISSION</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">REQUEST_WRITE_ES_PERMISSION</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">checkPermission</span><span class="o">(</span><span class="nc">Fragment</span> <span class="n">fragment</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">){</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">requestCode</span><span class="o">){</span>
            <span class="k">case</span> <span class="nl">REQUEST_ACCESS_FINE_LOCATION_PERMISSION:</span>
                <span class="k">if</span><span class="o">(</span><span class="nc">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="n">fragment</span><span class="o">.</span><span class="na">getActivity</span><span class="o">(),</span>
                        <span class="nc">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_FINE_LOCATION</span><span class="o">)</span> <span class="o">!=</span> <span class="nc">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">){</span>
                    <span class="k">if</span><span class="o">(</span><span class="nc">ActivityCompat</span><span class="o">.</span><span class="na">shouldShowRequestPermissionRationale</span><span class="o">(</span><span class="n">fragment</span><span class="o">.</span><span class="na">getActivity</span><span class="o">(),</span>
                            <span class="nc">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_FINE_LOCATION</span><span class="o">)){</span>
                        <span class="n">fragment</span><span class="o">.</span><span class="na">requestPermissions</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="nc">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_FINE_LOCATION</span><span class="o">},</span> <span class="n">requestCode</span><span class="o">);</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span><span class="o">{</span>
                        <span class="n">fragment</span><span class="o">.</span><span class="na">requestPermissions</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="nc">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">ACCESS_FINE_LOCATION</span><span class="o">},</span> <span class="n">requestCode</span><span class="o">);</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>checkPermission 부분에서 사용자의 Location 정보를 가져오기 위한 권한 요청 부분을 보면 다음과 같다. checkSelfPermission을 호출하여 해당 권한에 대한 승인이 되어 있지 않은 경우 shouldShowRequestPermissionRationale을 호출하여 권한이 왜 필요한지를 설명하는 방법과 그 외 설명없이 권한을 요청하는 두 가지 방법을 수행하는데 결국 두 루틴 모두 requestPermission을 통해 ACCESS_FINE_LOCATION 권한을 요청하는 역할을 수행한다. 해당 함수 리턴형은 Boolean이기에 권한이 허용되어 있는 경우에만 true를 리턴하도록 설계되어 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">IV_your_name_profile_picture</span><span class="o">:</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">PermissionHelper</span><span class="o">.</span><span class="na">checkPermission</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">REQUEST_WRITE_ES_PERMISSION</span><span class="o">))</span> <span class="o">{</span>
        <span class="nc">FileManager</span><span class="o">.</span><span class="na">startBrowseImageFile</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SELECT_PROFILE_PICTURE_BG</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">break</span><span class="o">;</span>
</code></pre></div></div>

<p>onClick이벤트를 통해 위의 루틴이 실행된 뒤 PermissionHelper가 권한에 대한 요청 및 처리를 마무리 하게 되면 FileManager의 startBrowseImageFile이 호출이 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRequestPermissionsResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">permissions</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">grantResults</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="nc">PermissionHelper</span><span class="o">.</span><span class="na">REQUEST_WRITE_ES_PERMISSION</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">grantResults</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="o">&amp;&amp;</span> <span class="nc">PermissionHelper</span><span class="o">.</span><span class="na">checkAllPermissionResult</span><span class="o">(</span><span class="n">grantResults</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">FileManager</span><span class="o">.</span><span class="na">startBrowseImageFile</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="no">SELECT_PROFILE_PICTURE_BG</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">PermissionHelper</span><span class="o">.</span><span class="na">showAddPhotoDialog</span><span class="o">(</span><span class="n">getActivity</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>onRequestPermissionsResult 부분에서도 requestCode를 검사한 뒤 조건에 성립하면 Image Intent를 호출하는 것 또한 확인이 가능하다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startBrowseImageFile</span><span class="o">(</span><span class="nc">Activity</span> <span class="n">activity</span><span class="o">,</span> <span class="kt">int</span> <span class="n">requestCode</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Intent</span> <span class="n">intentImage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
        <span class="n">intentImage</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="s">"image/*"</span><span class="o">);</span>
        <span class="n">intentImage</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">ACTION_GET_CONTENT</span><span class="o">);</span>
        <span class="n">activity</span><span class="o">.</span><span class="na">startActivityForResult</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">createChooser</span><span class="o">(</span><span class="n">intentImage</span><span class="o">,</span> <span class="s">"Select Picture"</span><span class="o">),</span> <span class="n">requestCode</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">ActivityNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>해당 메소드는 ACTION_GET_CONTENT를 호출하여 사용자가 사진을 앨범으로부터 선택할 수 있도록 해준다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">saveYourName</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//Save name</span>
    <span class="nc">SPFManager</span><span class="o">.</span><span class="na">setYourName</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">EDT_your_name_name</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">toString</span><span class="o">());</span>
    <span class="c1">//Save profile picture</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">isAddNewProfilePicture</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//Remove the old file</span>
        <span class="nc">FileManager</span> <span class="n">bgFM</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileManager</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="nc">FileManager</span><span class="o">.</span><span class="na">SETTING_DIR</span><span class="o">);</span>
        <span class="nc">File</span> <span class="n">oldProfilePictureFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">bgFM</span><span class="o">.</span><span class="na">getDirAbsolutePath</span><span class="o">()</span>
                <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="nc">ThemeManager</span><span class="o">.</span><span class="na">CUSTOM_PROFILE_PICTURE_FILENAME</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">oldProfilePictureFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">oldProfilePictureFile</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">profilePictureFileName</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//Copy the profile into setting dir</span>
                <span class="nc">FileManager</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">tempFileManager</span><span class="o">.</span><span class="na">getDirAbsolutePath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">profilePictureFileName</span><span class="o">),</span>
                        <span class="n">oldProfilePictureFile</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">toast_save_profile_picture_fail</span><span class="o">),</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>사용자가 이름을 변경 요청할 시 호출되는 메소드인 saveYourName을 보면 SPFManager를 통해 레이아웃으로부터 String값을 가져온 뒤 SharedPreference에 저장한다. 그 후 isAddNewProfilePicture을 검증하여 만약 프로파일에 대한 변화가 있을 경우에 getDirAbsolutePath을 호출하여 File에 대한 경로를 얻어온 뒤, 존재하는 경우에 삭제해준다. 그 후 이미지를 tempFileManager를 통해 oldProfilePictureFile로 복사함으로써 새로운 이미지를 적용하게 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="no">SELECT_PROFILE_PICTURE_BG</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resultCode</span> <span class="o">==</span> <span class="no">RESULT_OK</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">.</span><span class="na">getData</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>

                <span class="c1">//Create fileManager for get temp folder</span>
                <span class="n">tempFileManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileManager</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="nc">FileManager</span><span class="o">.</span><span class="na">TEMP_DIR</span><span class="o">);</span>
                <span class="n">tempFileManager</span><span class="o">.</span><span class="na">clearDir</span><span class="o">();</span>
                <span class="c1">//Compute the bg size</span>
                <span class="kt">int</span> <span class="n">photoSize</span> <span class="o">=</span> <span class="nc">ScreenHelper</span><span class="o">.</span><span class="na">dpToPixel</span><span class="o">(</span><span class="n">getResources</span><span class="o">(),</span> <span class="mi">50</span><span class="o">);</span>
                <span class="nc">UCrop</span><span class="o">.</span><span class="na">Options</span> <span class="n">options</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UCrop</span><span class="o">.</span><span class="na">Options</span><span class="o">();</span>
                <span class="n">options</span><span class="o">.</span><span class="na">setToolbarColor</span><span class="o">(</span><span class="nc">ThemeManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getThemeMainColor</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()));</span>
                <span class="n">options</span><span class="o">.</span><span class="na">setStatusBarColor</span><span class="o">(</span><span class="nc">ThemeManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getThemeDarkColor</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()));</span>
                <span class="nc">UCrop</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getData</span><span class="o">(),</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">fromFile</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">tempFileManager</span><span class="o">.</span><span class="na">getDir</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="nc">FileManager</span><span class="o">.</span><span class="na">createRandomFileName</span><span class="o">())))</span>
                        <span class="o">.</span><span class="na">withMaxResultSize</span><span class="o">(</span><span class="n">photoSize</span><span class="o">,</span> <span class="n">photoSize</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withAspectRatio</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withOptions</span><span class="o">(</span><span class="n">options</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">toast_photo_intent_error</span><span class="o">),</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
</code></pre></div></div>

<p>onActivityResult 부분에서 처리과정을 살펴보면 Uri.fromFile을 통해 data로부터 file 정보를 가져와 new File을 생성하는데 디렉터리 정보와 randomFileName을 합친 값으로 생성을 진행한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">createRandomFileName</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>createRandomFileName은 randomUUID 정보를 가지고 생성하는데 인터넷을 찾아보니 고유 식별변호를 만들어주는 것으로 겹칠 확률이 희박하기 때문에 랜덤으로 이름정보를 생성할 시에 효율적으로 사용된다고 한다. 이렇게 파일 편집 라이브러리인 Ucrop의 src로 data.getData가, dst로 새로 만든 file이 들어가서 편집 작업이 수행된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="nc">UCrop</span><span class="o">.</span><span class="na">REQUEST_CROP</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">resultCode</span> <span class="o">==</span> <span class="no">RESULT_OK</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="nc">Uri</span> <span class="n">resultUri</span> <span class="o">=</span> <span class="nc">UCrop</span><span class="o">.</span><span class="na">getOutput</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
            <span class="n">IV_your_name_profile_picture</span><span class="o">.</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="nc">BitmapFactory</span><span class="o">.</span><span class="na">decodeFile</span><span class="o">(</span><span class="n">resultUri</span><span class="o">.</span><span class="na">getPath</span><span class="o">()));</span>
            <span class="n">profilePictureFileName</span> <span class="o">=</span> <span class="nc">FileManager</span><span class="o">.</span><span class="na">getFileNameByUri</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">resultUri</span><span class="o">);</span>
            <span class="n">isAddNewProfilePicture</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">toast_crop_profile_picture_fail</span><span class="o">),</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>그리고 해당 작업이 끝난 뒤에 IV_your_name_profile_picture의 이미지가 변경된다. 그리고 uCrop의 경우 Manifest에 다음과 같이 선언이 되어야 사용이 가능하다.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--Ucrop--&gt;</span>
<span class="nt">&lt;activity</span>
    <span class="na">android:name=</span><span class="s">"com.yalantis.ucrop.UCropActivity"</span>
    <span class="na">android:screenOrientation=</span><span class="s">"portrait"</span>
    <span class="na">android:theme=</span><span class="s">"@style/Theme.AppCompat.Light.NoActionBar"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>MainSettingDialogFragment는 BottomSheetDialogFragment를 상속받는데 원래는 com.android.support:design 였지만 바뀌고 나서는 아래의 라이브러리를 추가해주어야 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="err">'</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">material</span><span class="o">:</span><span class="nl">material:</span><span class="mf">1.1</span><span class="o">.</span><span class="mi">0</span><span class="err">'</span>
</code></pre></div></div>

<p>참고로 compile이 deprecated 되고 implementation의 사용을 권장하는데 그에 대한 설명이 아래의 블로그에 있다.</p>

<p><a href="https://developer88.tistory.com/149">compile vs implementation</a></p>

<p>쉽게 프로젝트를 빌드하는 순간에 implementation을 사용하게 되면 전체 빌드가 아니라 관련된 부분만 빌드가 된다고 이해하였다.</p>

<p>MainDetailDialogFragment는 adapter 내부에서 홀더의 왼쪽에 있는 버튼에 대한 기능을 구현하기 위해 존재하며 해당 Fragment를 통해 ITopic을 상속받는 객체에 대한 수정, 추가 작업이 진행된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">holder</span><span class="o">.</span><span class="na">getTopicLeftSettingEditView</span><span class="o">().</span><span class="na">setOnClickListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClick</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">position</span> <span class="o">=</span> <span class="n">holder</span><span class="o">.</span><span class="na">getAdapterPosition</span><span class="o">();</span>
        <span class="nc">TopicDetailDialogFragment</span> <span class="n">createTopicDialogFragment</span> <span class="o">=</span>
                <span class="nc">TopicDetailDialogFragment</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="n">position</span><span class="o">,</span>
                        <span class="n">filteredTopicList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">getId</span><span class="o">(),</span>
                        <span class="n">filteredTopicList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">getTitle</span><span class="o">(),</span>
                        <span class="n">filteredTopicList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">getType</span><span class="o">(),</span>
                        <span class="n">filteredTopicList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">getColor</span><span class="o">());</span>
        <span class="n">createTopicDialogFragment</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">activity</span><span class="o">.</span><span class="na">getSupportFragmentManager</span><span class="o">(),</span> <span class="s">"createTopicDialogFragment"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></div></div>

<p>기존 코드와 다르게 listener를 생성자 쪽에 설치해주었기 때문에 pos는 getAdapterPosition을 통해 가져오도록 하였다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">TopicDetailDialogFragment</span> <span class="nf">newInstance</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isEditMode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="kt">long</span> <span class="n">topicId</span><span class="o">,</span>
                                                    <span class="nc">String</span> <span class="n">title</span><span class="o">,</span> <span class="kt">int</span> <span class="n">topicType</span><span class="o">,</span> <span class="kt">int</span> <span class="n">topicColorCode</span><span class="o">){</span>
    <span class="nc">Bundle</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bundle</span><span class="o">();</span>
    <span class="nc">TopicDetailDialogFragment</span> <span class="n">fragment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopicDetailDialogFragment</span><span class="o">();</span>
    <span class="n">args</span><span class="o">.</span><span class="na">putBoolean</span><span class="o">(</span><span class="s">"isEditMode"</span><span class="o">,</span> <span class="n">isEditMode</span><span class="o">);</span>
    <span class="n">args</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">"position"</span><span class="o">,</span> <span class="n">position</span><span class="o">);</span>
    <span class="n">args</span><span class="o">.</span><span class="na">putString</span><span class="o">(</span><span class="s">"title"</span><span class="o">,</span> <span class="n">title</span><span class="o">);</span>
    <span class="n">args</span><span class="o">.</span><span class="na">putLong</span><span class="o">(</span><span class="s">"topicId"</span><span class="o">,</span> <span class="n">topicId</span><span class="o">);</span>
    <span class="n">args</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">"topicType"</span><span class="o">,</span> <span class="n">topicType</span><span class="o">);</span>
    <span class="n">args</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="s">"topicColorCode"</span><span class="o">,</span> <span class="n">topicColorCode</span><span class="o">);</span>
    <span class="n">fragment</span><span class="o">.</span><span class="na">setArguments</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">fragment</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>newInstance로 만들어주는 이유는 fragment또한 가비지 컬렉션의 타겟이기 때문에 인자로 넘어온 값들에 대한 유지가 필요하다. 하지만 fragment의 경우 재 생성시에 인자가 없는 생성자가 호출되기 떄문에 newInstance를 선언해줌으로써 내부적으로 Bundle에서 값을 다시 가져오는 루틴을 타게 한다. 즉 재생성 하는 순간에 Bundle에 대한 정보가 다시 넘어온다는 것이다.</p>

<p>추가/변경/삭제의 관점에서 해당 행위를 살펴보자면 다음과 같다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">TopicCreated</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">topicTitle</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">color</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">openDB</span><span class="o">();</span>
    <span class="kd">final</span> <span class="kt">long</span> <span class="n">newTopicId</span> <span class="o">=</span> <span class="n">dbManager</span><span class="o">.</span><span class="na">insertTopic</span><span class="o">(</span><span class="n">topicTitle</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">color</span><span class="o">);</span>
    <span class="n">topicList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">ITopic</span><span class="o">()</span> <span class="o">{</span>
                <span class="o">..</span> <span class="n">생략</span>
            <span class="o">});</span>
    <span class="kt">int</span> <span class="n">orderNumber</span> <span class="o">=</span> <span class="n">topicList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">deleteAllCurrentTopicOrder</span><span class="o">();</span>

    <span class="k">for</span><span class="o">(</span><span class="nc">ITopic</span> <span class="n">topic</span> <span class="o">:</span> <span class="n">topicList</span><span class="o">){</span>
        <span class="n">dbManager</span><span class="o">.</span><span class="na">insertTopicOrder</span><span class="o">(</span><span class="n">topic</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="o">--</span><span class="n">orderNumber</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">loadTopic</span><span class="o">();</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">closeDB</span><span class="o">();</span>

    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">EDT_main_topic_search</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>topicList의 처음 인덱스에 새로 추가되는 데이터를 추가하고 그 뒤를 기존의 데이터로 재배치시킨다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">notifyDataSetChanged</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">clear</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">clear</span><span class="o">){</span>
        <span class="n">filteredTopicList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">filteredTopicList</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">originalTopicList</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>그 후 notifyDataSetChanged를 호출하는 과정에서 clear를 한 뒤, adapter의 전체 리스트에 대한 초기화를 진행한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">TopicUpdated</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="nc">String</span> <span class="n">newTopicTitle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">color</span><span class="o">,</span> <span class="kt">int</span> <span class="n">topicBgStatus</span><span class="o">,</span> <span class="nc">String</span> <span class="n">newBgFileName</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">DBManager</span> <span class="n">dbManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DBManager</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">openDB</span><span class="o">();</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">updateTopic</span><span class="o">(</span><span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">getId</span><span class="o">(),</span> <span class="n">newTopicTitle</span><span class="o">,</span> <span class="n">color</span><span class="o">);</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">closeDB</span><span class="o">();</span>

    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">setTitle</span><span class="o">(</span><span class="n">newTopicTitle</span><span class="o">);</span>
    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">setColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

    <span class="n">updateTopicBg</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">topicBgStatus</span><span class="o">,</span> <span class="n">newBgFileName</span><span class="o">);</span>
    <span class="n">EDT_main_topic_search</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>update 부분의 경우 해당 부분에 대한 결과만 바꿔주면 되기 때문에 리스트를 재생성하지 않고 해당 부분에 대한 결과만 바꿔준다. 하지만 이부분도 비효율적인게 DataSet이 아닌 특정 하나의 아이템이 변경된 것이기 때문에 이를 다음과 같이 변경해준다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">TopicUpdated</span><span class="o">(</span><span class="kt">int</span> <span class="n">position</span><span class="o">,</span> <span class="nc">String</span> <span class="n">newTopicTitle</span><span class="o">,</span> <span class="kt">int</span> <span class="n">color</span><span class="o">,</span> <span class="kt">int</span> <span class="n">topicBgStatus</span><span class="o">,</span> <span class="nc">String</span> <span class="n">newBgFileName</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">DBManager</span> <span class="n">dbManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DBManager</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">openDB</span><span class="o">();</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">updateTopic</span><span class="o">(</span><span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">getId</span><span class="o">(),</span> <span class="n">newTopicTitle</span><span class="o">,</span> <span class="n">color</span><span class="o">);</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">closeDB</span><span class="o">();</span>

    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">setTitle</span><span class="o">(</span><span class="n">newTopicTitle</span><span class="o">);</span>
    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">setColor</span><span class="o">(</span><span class="n">color</span><span class="o">);</span>
    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">notifyItemChanged</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>

    <span class="n">updateTopicBg</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">topicBgStatus</span><span class="o">,</span> <span class="n">newBgFileName</span><span class="o">);</span>
    <span class="n">EDT_main_topic_search</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>position에 대한 정보또한 알고 있기 때문에 notifyItemChanged를 호출하며 position을 인자로 넘겨주면 해당 부분만 변경되었음을 알려줄 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">topicList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">topicList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">position</span><span class="o">).</span><span class="na">getId</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">topicList</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>

    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">notifyItemRemoved</span><span class="o">(</span><span class="n">position</span><span class="o">);</span>
    <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">notifyItemRangeChanged</span><span class="o">(</span><span class="n">position</span><span class="o">,</span> <span class="n">mainTopicAdapter</span><span class="o">.</span><span class="na">getItemCount</span><span class="o">());</span>

    <span class="n">EDT_main_topic_search</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
</code></pre></div></div>

<p>삭제의 경우 list에서 해당 부분을 찾아내 삭제한 뒤, remove를 통해 adapter부분에서도 삭제를 진행한다. 그리고 notifyItemRemoved를 position 정보와 함께 호출하여 해당 부분이 삭제된 사실을 알리고 이로인하여 변경된 구간들을 notifyItemRangeChanged를 통해 최신화를 진행해준다.</p>

<h3 id="settingactivity">SettingActivity</h3>

<p>환경설정과 관련된 작업을 수행하는 곳이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SettingColorPickerFragment</span> <span class="kd">extends</span> <span class="nc">DialogFragment</span> <span class="kd">implements</span> <span class="nc">View</span><span class="o">.</span><span class="na">OnClickListener</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">colorPickerCallback</span> <span class="o">{</span>
        <span class="kt">void</span> <span class="nf">onColorChange</span><span class="o">(</span><span class="kt">int</span> <span class="n">colorCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">viewId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">oldColor</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">viewId</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">ColorPicker</span> <span class="n">picker</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">SVBar</span> <span class="n">svBar</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Button</span> <span class="n">But_setting_change_color</span><span class="o">,</span> <span class="n">But_setting_cancel</span><span class="o">;</span>

    <span class="kd">private</span> <span class="n">colorPickerCallback</span> <span class="n">callback</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAttach</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onAttach</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="o">(</span><span class="n">colorPickerCallback</span><span class="o">)</span> <span class="n">context</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassCastException</span> <span class="n">e</span><span class="o">){</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>위와 같이 Fragment와 관련된 developer 문서를 보면 Activity에서 수행할 callback을 onAttach 부분에서 할당해주는데 이게 대체 무슨의미인지가 궁금하였다. 내가 알기로 context는 Application과 Activity 레벨로 나뉘어져 있으며 Context를 상속받아 특정 리소스에 접근을 하기 위해 사용되는 것으로 안다. 그런데 callback에 context를 할당한다는게 무슨뜻일까라는 고민을 가지고 검색을 한 결과 위의 예제의 colorPickerCallback 인터페이스 내부의 onColorChange 메소드에 대한 구현정보를 context를 통해 Activity로부터 가져와 casting 해주는 과정이다. 그렇기 떄문에 해당 메소드에 대한 정의가 되어있지 않은 경우 ClassCastException에러가 발생하게 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">applySetting</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">killProcess</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//Restart App</span>
    <span class="nc">Intent</span> <span class="n">i</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">getBaseContext</span><span class="o">().</span><span class="na">getPackageManager</span><span class="o">()</span>
            <span class="o">.</span><span class="na">getLaunchIntentForPackage</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getBaseContext</span><span class="o">().</span><span class="na">getPackageName</span><span class="o">());</span>
    <span class="n">i</span><span class="o">.</span><span class="na">addFlags</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_CLEAR_TASK</span> <span class="o">|</span> <span class="nc">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span><span class="o">);</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">killProcess</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">killProcess</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">finish</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>다른 액티비티와 다른 기능을 수행하는 코드를 뽑자면 applySetting이 있다. Intent는 packageName을 가져옴으로써 본인을 intent로 설정한다. 그리고 Flags를 추가하는데 FLAG_ACTIVITY_CLEAR_TASK는 본인을 제외한 모든 액티비티를 종료하는 것을 의미한다. 해당 intent를 수행하게 되면 앱이 재시작되게 된다.</p>

<h3 id="backupactivity">BackupActivity</h3>

<p>com.nononsenseapps.filepicker.FilePickerActivity 라이브러리를 사용하여 구현된 Activity이다. 이를 위해서 먼저 DirectoryPickerActivity를 만든다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectoryPickerActivity</span> <span class="kd">extends</span> <span class="nc">FilePickerActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">DirectoryPickerFragment</span> <span class="n">currentFragment</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">AbstractFilePickerFragment</span><span class="o">&lt;</span><span class="nc">File</span><span class="o">&gt;</span> <span class="nf">getFragment</span><span class="o">(</span>
            <span class="nd">@Nullable</span> <span class="nc">String</span> <span class="n">startPath</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowMultiple</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">allowCreateDir</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">allowExistingFile</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">singleClick</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="o">(</span><span class="n">startPath</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">startPath</span> <span class="o">:</span> <span class="nc">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">().</span><span class="na">getPath</span><span class="o">());</span>

        <span class="n">currentFragment</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DirectoryPickerFragment</span><span class="o">();</span>
        <span class="n">currentFragment</span><span class="o">.</span><span class="na">setArgs</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">mode</span><span class="o">,</span> <span class="n">allowMultiple</span><span class="o">,</span> <span class="n">allowCreateDir</span><span class="o">,</span> <span class="n">allowExistingFile</span><span class="o">,</span> <span class="n">singleClick</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">currentFragment</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onBackPressed</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">currentFragment</span><span class="o">.</span><span class="na">isBackTop</span><span class="o">())</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">.</span><span class="na">onBackPressed</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">currentFragment</span><span class="o">.</span><span class="na">goUp</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>FilePickerActivity를 상속한 DirectoryPickerActivity는 AbstractFilePickerFragment를 가져온다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectoryPickerFragment</span> <span class="kd">extends</span> <span class="nc">FilePickerFragment</span> <span class="o">{</span>

    <span class="nd">@RequiresApi</span><span class="o">(</span><span class="n">api</span> <span class="o">=</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">LOLLIPOP</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">View</span> <span class="nf">onCreateView</span><span class="o">(</span><span class="nc">LayoutInflater</span> <span class="n">inflater</span><span class="o">,</span> <span class="nc">ViewGroup</span> <span class="n">container</span><span class="o">,</span> <span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">View</span> <span class="n">rootView</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">onCreateView</span><span class="o">(</span><span class="n">inflater</span><span class="o">,</span> <span class="n">container</span><span class="o">,</span> <span class="n">savedInstanceState</span><span class="o">);</span>

        <span class="nc">Toolbar</span> <span class="n">toolbar</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Toolbar</span><span class="o">)</span> <span class="n">rootView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">nononsenseapps</span><span class="o">.</span><span class="na">filepicker</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">nnf_picker_toolbar</span><span class="o">);</span>
        <span class="n">toolbar</span><span class="o">.</span><span class="na">setBackgroundColor</span><span class="o">(</span><span class="nc">ThemeManager</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getThemeMainColor</span><span class="o">(</span><span class="n">getActivity</span><span class="o">()));</span>

        <span class="n">recyclerView</span><span class="o">.</span><span class="na">setBackgroundColor</span><span class="o">(</span><span class="nc">Color</span><span class="o">.</span><span class="na">WHITE</span><span class="o">);</span>

        <span class="o">((</span><span class="nc">Button</span><span class="o">)</span> <span class="n">rootView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">nononsenseapps</span><span class="o">.</span><span class="na">filepicker</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">nnf_button_cancel</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="s">"Cancel"</span><span class="o">);</span>
        <span class="o">((</span><span class="nc">Button</span><span class="o">)</span> <span class="n">rootView</span><span class="o">.</span><span class="na">findViewById</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">nononsenseapps</span><span class="o">.</span><span class="na">filepicker</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">nnf_button_ok</span><span class="o">)).</span><span class="na">setText</span><span class="o">(</span><span class="s">"OK"</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">rootView</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">File</span> <span class="nf">getBackTop</span><span class="o">(){</span>
        <span class="k">return</span> <span class="nf">getPath</span><span class="o">(</span><span class="n">getArguments</span><span class="o">().</span><span class="na">getString</span><span class="o">(</span><span class="no">KEY_START_PATH</span><span class="o">,</span> <span class="s">"/"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// if root path</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isBackTop</span><span class="o">(){</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">compareFiles</span><span class="o">(</span><span class="n">mCurrentPath</span><span class="o">,</span> <span class="n">getBackTop</span><span class="o">())</span> <span class="o">||</span>
                <span class="mi">0</span> <span class="o">==</span> <span class="n">compareFiles</span><span class="o">(</span><span class="n">mCurrentPath</span><span class="o">,</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// ..</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">goUp</span><span class="o">(){</span>
        <span class="n">mCurrentPath</span> <span class="o">=</span> <span class="n">getParent</span><span class="o">(</span><span class="n">mCurrentPath</span><span class="o">);</span>
        <span class="n">mCheckedItems</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">mCheckedVisibleViewHolders</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">refresh</span><span class="o">(</span><span class="n">mCurrentPath</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>fragment에서는 getBackTop, isBackTop, goUp을 구현하는데 이는 경로와 관련된 부분을 설정한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="no">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">TV_backup_export_src</span><span class="o">:</span>
    <span class="nc">Intent</span> <span class="n">exportIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="nc">DirectoryPickerActivity</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">exportIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">FilePickerActivity</span><span class="o">.</span><span class="na">EXTRA_ALLOW_MULTIPLE</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="n">exportIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">FilePickerActivity</span><span class="o">.</span><span class="na">EXTRA_ALLOW_CREATE_DIR</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
    <span class="n">exportIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">FilePickerActivity</span><span class="o">.</span><span class="na">EXTRA_MODE</span><span class="o">,</span> <span class="nc">FilePickerActivity</span><span class="o">.</span><span class="na">MODE_DIR</span><span class="o">);</span>
    <span class="n">exportIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">FilePickerActivity</span><span class="o">.</span><span class="na">EXTRA_START_PATH</span><span class="o">,</span> <span class="nc">Environment</span><span class="o">.</span><span class="na">getExternalStorageDirectory</span><span class="o">().</span><span class="na">getPath</span><span class="o">());</span>
    <span class="n">startActivityForResult</span><span class="o">(</span><span class="n">exportIntent</span><span class="o">,</span> <span class="no">EXPORT_SRC_PICKER_CODE</span><span class="o">);</span>
    <span class="k">break</span><span class="o">;</span>
</code></pre></div></div>

<p>intent로 호출을 할 경우 flag값을 extra로 설정해서 보내줌으로써 실행이 가능하다.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;activity</span> <span class="na">android:name=</span><span class="s">".backup.DirectoryPickerActivity"</span>
    <span class="na">android:theme=</span><span class="s">"@style/FilePickerTheme"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;intent-filter&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.GET_CONTENT"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">"android.intent.category.DEFAULT"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/intent-filter&gt;</span>
<span class="nt">&lt;/activity&gt;</span>
</code></pre></div></div>

<p>그리고 manifest에 activity를 추가해주면 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onActivityResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="kt">int</span> <span class="n">resultCode</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Intent</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onActivityResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">resultCode</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="no">EXPORT_SRC_PICKER_CODE</span> <span class="o">&amp;&amp;</span> <span class="n">resultCode</span> <span class="o">==</span> <span class="nc">Activity</span><span class="o">.</span><span class="na">RESULT_OK</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">uri</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">nononsenseapps</span><span class="o">.</span><span class="na">filepicker</span><span class="o">.</span><span class="na">Utils</span><span class="o">.</span><span class="na">getFileForUri</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>

            <span class="k">if</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">canWrite</span><span class="o">()){</span>
                <span class="n">TV_backup_export_src</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
                <span class="n">But_backup_export</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">backup_export_can_not_write</span><span class="o">),</span>
                        <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="no">IMPORT_SRC_PICKER_CODE</span> <span class="o">&amp;&amp;</span> <span class="n">resultCode</span> <span class="o">==</span> <span class="nc">Activity</span><span class="o">.</span><span class="na">RESULT_OK</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Uri</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">uri</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">nononsenseapps</span><span class="o">.</span><span class="na">filepicker</span><span class="o">.</span><span class="na">Utils</span><span class="o">.</span><span class="na">getFileForUri</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
            
            <span class="k">if</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">canRead</span><span class="o">()){</span>
                <span class="n">TV_backup_import_src</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">());</span>
                <span class="n">But_backup_import</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> 
                <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">backup_import_can_not_read</span><span class="o">),</span>
                        <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_SHORT</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>해당 부분이 실행되고 나서 Result 부분으로 돌아오게 되면 uri를 통해 File에 대한 정보를 가져온 뒤, 권한을 확인하고 path를 가져오고 setEnabled를 true로 바꾸어 버튼에 대한 리스너가 작동하도록 한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">ExportAsyncTask</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span> <span class="nc">ExportCallBack</span> <span class="n">callBack</span><span class="o">,</span> <span class="nc">String</span> <span class="n">backupZipRootPath</span><span class="o">){</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">callBack</span> <span class="o">=</span> <span class="n">callBack</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">backupManager</span><span class="o">.</span><span class="na">initBackupManagerExportInfo</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dbManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DBManager</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

    <span class="nc">FileManager</span> <span class="n">backupFM</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileManager</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">FileManager</span><span class="o">.</span><span class="na">BACKUP_DIR</span><span class="o">);</span>

    <span class="k">this</span><span class="o">.</span><span class="na">backupJsonFilePath</span> <span class="o">=</span> <span class="n">backupFM</span><span class="o">.</span><span class="na">getDirAbsolutePath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"/"</span>
            <span class="o">+</span> <span class="nc">BackupManager</span><span class="o">.</span><span class="na">BACKUP_JSON_FILE_NAME</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">backupZipRootPath</span> <span class="o">=</span> <span class="n">backupZipRootPath</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">backupZipFileName</span> <span class="o">=</span> <span class="no">BACKUP_ZIP_FILE_HEADER</span> <span class="o">+</span> <span class="n">sdf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">())</span> <span class="o">+</span> <span class="no">BACKUP_ZIP_FILE_SUB_FILE_NAME</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">callBack</span> <span class="o">=</span> <span class="n">callBack</span><span class="o">;</span>

    <span class="k">this</span><span class="o">.</span><span class="na">progressDialog</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ProgressDialog</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
    <span class="n">progressDialog</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="s">"Loading..."</span><span class="o">);</span>
    <span class="n">progressDialog</span><span class="o">.</span><span class="na">setCancelable</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="n">progressDialog</span><span class="o">.</span><span class="na">setProgressStyle</span><span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">style</span><span class="o">.</span><span class="na">Widget_ProgressBar</span><span class="o">);</span>
    <span class="n">progressDialog</span><span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p>AsyncTask 부분이 실행되면 초기화 과정에서 progressDialog가 생성이 되고 setMessage로 인하여 Loading이 호출된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="nc">Boolean</span> <span class="nf">doInBackground</span><span class="o">(</span><span class="nc">Void</span><span class="o">...</span> <span class="n">params</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">exportSuccessful</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">//Load the data</span>
        <span class="n">exportDataIntoBackupManager</span><span class="o">();</span>
        <span class="c1">//Create backup.json</span>
        <span class="n">outputBackupJson</span><span class="o">();</span>
        <span class="c1">//Zip the json file and photo</span>
        <span class="n">zipBackupFile</span><span class="o">();</span>
        <span class="c1">//Delete the json file</span>
        <span class="n">deleteBackupJsonFile</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"export fail"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="n">exportSuccessful</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">exportSuccessful</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>task가 실행되면 가장 먼저 exportDataIntoBackupManager가 호출된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">exportDataIntoBackupManager</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">openDB</span><span class="o">();</span>

    <span class="nc">Cursor</span> <span class="n">topicCursor</span> <span class="o">=</span> <span class="n">dbManager</span><span class="o">.</span><span class="na">selectTopic</span><span class="o">();</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">topicCursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++){</span>
        <span class="nc">BackupManager</span><span class="o">.</span><span class="na">BackupTopicListBean</span> <span class="n">exportTopic</span> <span class="o">=</span> <span class="n">loadTopicDataFormDB</span><span class="o">(</span><span class="n">topicCursor</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">exportTopic</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="n">backupManager</span><span class="o">.</span><span class="na">addTopic</span><span class="o">(</span><span class="n">exportTopic</span><span class="o">);</span>
            <span class="n">topicCursor</span><span class="o">.</span><span class="na">moveToNext</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s">"backup type Exception"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">topicCursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="n">dbManager</span><span class="o">.</span><span class="na">closeDB</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>해당 메소드가 실행되면 db로부터 topic에 대한 리스트를 가져온 뒤 순회하면서 loadTopicDataFormDB을 호출한다. 해당 부분에서는 ITopic 인터페이스의 TYPE의 되는 정보를 DB로부터 가져와서 그에 맞는 구조로 파싱해서 List에 추가해준다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">outputBackupJson</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="nc">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="n">backupJsonFilePath</span><span class="o">);</span>
    <span class="nc">Gson</span> <span class="n">gson</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GsonBuilder</span><span class="o">().</span><span class="na">create</span><span class="o">();</span>
    <span class="n">gson</span><span class="o">.</span><span class="na">toJson</span><span class="o">(</span><span class="n">backupManager</span><span class="o">,</span> <span class="n">writer</span><span class="o">);</span>
    <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>outputBackupJson에서 사용하는 gson은 자바 객체를 json으로 serialize해주는 라이브러리이다. 해당 라이브러리를 통해 backupManager가 가지고 있는 ArrayList값을 json으로 바꿔준다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">zipBackupJsonFile</span><span class="o">(</span><span class="nc">String</span> <span class="n">backupJsonFilePath</span><span class="o">,</span> <span class="nc">ZipOutputStream</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="kt">byte</span> <span class="n">data</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="no">BUFFER_SIZE</span><span class="o">];</span>
    <span class="nc">FileInputStream</span> <span class="n">fi</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">backupJsonFilePath</span><span class="o">);</span>
    <span class="nc">BufferedInputStream</span> <span class="n">jsonFileOrigin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">fi</span><span class="o">,</span> <span class="no">BUFFER_SIZE</span><span class="o">);</span>
    <span class="nc">ZipEntry</span> <span class="n">entry</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZipEntry</span><span class="o">(</span><span class="nc">BackupManager</span><span class="o">.</span><span class="na">BACKUP_JSON_FILE_NAME</span><span class="o">);</span>
    <span class="n">out</span><span class="o">.</span><span class="na">putNextEntry</span><span class="o">(</span><span class="n">entry</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="k">while</span> <span class="o">((</span><span class="n">count</span> <span class="o">=</span> <span class="n">jsonFileOrigin</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="no">BUFFER_SIZE</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">count</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>그 후 FileInputStream을 BufferedInputStream으로 만든 뒤 ZipEntry에 추가하여 write를 수행함으로써 zip파일을 생성한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onPostExecute</span><span class="o">(</span><span class="nc">Boolean</span> <span class="n">exportSuccessful</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onPostExecute</span><span class="o">(</span><span class="n">exportSuccessful</span><span class="o">);</span>
    <span class="n">progressDialog</span><span class="o">.</span><span class="na">dismiss</span><span class="o">();</span>
    <span class="k">if</span><span class="o">(</span><span class="n">exportSuccessful</span><span class="o">){</span>
        <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">mContext</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%1$s export successful"</span><span class="o">,</span> <span class="n">backupZipFileName</span><span class="o">),</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
        <span class="n">callBack</span><span class="o">.</span><span class="na">onExportCompiled</span><span class="o">(</span><span class="n">backupZipRootPath</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="n">backupZipFileName</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">mContext</span><span class="o">,</span> <span class="s">"export fail... please check permission or storage"</span><span class="o">,</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>작업이 마무리되면 호출되는 OnPostExecute 부분에서는 callback이 호출된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onExportCompiled</span><span class="o">(</span><span class="nc">String</span> <span class="n">backupZipFilePath</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Intent</span> <span class="n">sendIntent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">backupZipFilePath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="nc">File</span> <span class="n">backupFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">backupZipFilePath</span><span class="o">);</span>
            <span class="nc">Uri</span> <span class="n">backupFileUri</span> <span class="o">=</span> <span class="nc">FileProvider</span><span class="o">.</span><span class="na">getUriForFile</span><span class="o">(</span><span class="k">this</span><span class="o">,</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">getPackageName</span><span class="o">()+</span><span class="s">".provider"</span><span class="o">,</span> <span class="n">backupFile</span><span class="o">);</span>
            <span class="n">sendIntent</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">ACTION_SEND</span><span class="o">);</span>
            <span class="n">sendIntent</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">EXTRA_STREAM</span><span class="o">,</span> <span class="n">backupFileUri</span><span class="o">);</span>
            <span class="n">sendIntent</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="s">"application/zip"</span><span class="o">);</span>
            <span class="n">startActivity</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">createChooser</span><span class="o">(</span><span class="n">sendIntent</span><span class="o">,</span> <span class="s">"Share with"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>안드로이드 컴포넌트 중 Provider는 데이터를 제공하며 응용 프로그램끼리 데이터를 공유하는 방식으로 많이 사용된다. 이 부분에서는 파일 공유를 위하여 FileProvider가 호출이 된다. 그리고 provider는 package name + .provider의 형태를 가지는데 manifest에 선언되어야 사용할 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="o">&lt;</span><span class="n">provider</span>
        <span class="nl">android:</span><span class="n">authorities</span><span class="o">=</span><span class="s">"${applicationId}.provider"</span>
        <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">"androidx.core.content.FileProvider"</span>
        <span class="nl">android:</span><span class="n">exported</span><span class="o">=</span><span class="s">"false"</span>
        <span class="nl">android:</span><span class="n">grantUriPermissions</span><span class="o">=</span><span class="s">"true"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">meta</span><span class="o">-</span><span class="n">data</span>
            <span class="nl">android:</span><span class="n">name</span><span class="o">=</span><span class="s">"android.support.FILE_PROVIDER_PATHS"</span>
            <span class="nl">android:</span><span class="n">resource</span><span class="o">=</span><span class="s">"@xml/nnf_provider_paths"</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">provider</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>이름으로 application의 패키지 이름 + provider를 가지며 exported False를 통해 다른 어플리케이션에서 해당 프로바이더를 사용하지 못하게 하며 잠시 동안 유저가 기능을 사용할 수 있도록 grantUriPermission 권한이 주어졌다.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;paths&gt;</span>
    <span class="nt">&lt;external-path</span>
        <span class="na">name=</span><span class="s">"external_files"</span>
        <span class="na">path=</span><span class="s">"."</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;root-path</span>
        <span class="na">name=</span><span class="s">"root"</span>
        <span class="na">path=</span><span class="s">"."</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/paths&gt;</span>
</code></pre></div></div>

<p>그리고 paths에 대한 정보를 담고 있는 path에 대한 설정을 해주어야 된다. 하지만 위에 있는 provider의 경우 FilePickerFragment 번들 내부에 하드코딩 되어 있기 떄문에 nnf_provider_paths로부터 정보를 가져와 사용하므로 default한 프로바이더는 아니다.</p>

<h3 id="contactsactivity">ContactsActivity</h3>

<p>해당 액티비티에서는 RecyclerView로 동작하는 여러 기능들은 위에서 살펴보았고 특별한 점이라고는 전화 intent를 사용한다는 것이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TelephonyManager</span> <span class="n">tm</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TelephonyManager</span><span class="o">)</span> <span class="n">getActivity</span><span class="o">().</span><span class="na">getSystemService</span><span class="o">(</span><span class="nc">Context</span><span class="o">.</span><span class="na">TELEPHONY_SERVICE</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="na">getPhoneType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">TelephonyManager</span><span class="o">.</span><span class="na">PHONE_TYPE_NONE</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//No module for calling phone</span>
    <span class="nc">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getActivity</span><span class="o">(),</span> <span class="n">getString</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">contacts_call_phone_no_call_function</span><span class="o">),</span> <span class="nc">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">)</span>
            <span class="o">.</span><span class="na">show</span><span class="o">();</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">//Can call phone</span>
    <span class="nc">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Intent</span><span class="o">(</span><span class="nc">Intent</span><span class="o">.</span><span class="na">ACTION_CALL</span><span class="o">,</span> <span class="nc">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"tel:"</span> <span class="o">+</span> <span class="n">contactsPhoneNumber</span><span class="o">));</span>
    <span class="n">startActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">dismiss</span><span class="o">();</span>
</code></pre></div></div>

<p>위와 같이 TELEPHONY_SERVICE 정보를 가져와 ACTION_CALL을 발생시켜 전화를 수행하는 activity를 호출하는 것이 가능하다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadContacts</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">contactsNamesList</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">openDB</span><span class="o">();</span>
    <span class="nc">Cursor</span> <span class="n">contactsCursor</span> <span class="o">=</span> <span class="n">dbManager</span><span class="o">.</span><span class="na">selectContacts</span><span class="o">(</span><span class="n">topicId</span><span class="o">);</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">contactsCursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">();</span> <span class="n">i</span><span class="o">++){</span>
        <span class="n">contactsNamesList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">ContactsEntity</span><span class="o">(</span><span class="n">contactsCursor</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span>
                        <span class="n">contactsCursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span>
                        <span class="n">contactsCursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span>
                        <span class="n">contactsCursor</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="mi">3</span><span class="o">))</span>
        <span class="o">);</span>
        <span class="n">contactsCursor</span><span class="o">.</span><span class="na">moveToNext</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">contactsCursor</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="n">dbManager</span><span class="o">.</span><span class="na">closeDB</span><span class="o">();</span>

    <span class="n">sortContacts</span><span class="o">();</span>
<span class="o">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addContacts</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">loadContacts</span><span class="o">();</span>
    <span class="n">contactsAdapter</span><span class="o">.</span><span class="na">notifyDataSetChanged</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>adapter에 알리는 부분은 배열을 초기화하고 내용을 다시 db로부터 가져온 뒤, notifyDataSetChanged을 하는 방식으로 진행되었다.</p>

<h3 id="memoactivity">MemoActivity</h3>

<p>ItemTouchHelper라는 서브클래스가 등장하는데 viewholder의 drag와 같은 이벤트를 처리하기 위해 사용된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTouch</span><span class="o">(</span><span class="nc">View</span> <span class="n">v</span><span class="o">,</span> <span class="nc">MotionEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">MotionEventCompat</span><span class="o">.</span><span class="na">getActionMasked</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">==</span> <span class="nc">MotionEvent</span><span class="o">.</span><span class="na">ACTION_DOWN</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">dragStartListener</span><span class="o">.</span><span class="na">onStartDrag</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>보통은 adapter내부에 onTouch 와 같은 이벤트가 발생하고 원하는 행동일 경우 interface를 통해 해당 행위를 전달한다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nc">ItemTouchHelper</span><span class="o">.</span><span class="na">Callback</span> <span class="n">callback</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MemoItemTouchHelperCallback</span><span class="o">(</span><span class="n">memoAdapter</span><span class="o">);</span>
<span class="n">touchHelper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ItemTouchHelper</span><span class="o">(</span><span class="n">callback</span><span class="o">);</span>
<span class="n">touchHelper</span><span class="o">.</span><span class="na">attachToRecyclerView</span><span class="o">(</span><span class="n">RecyclerView_memo</span><span class="o">);</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartDrag</span><span class="o">(</span><span class="nc">RecyclerView</span><span class="o">.</span><span class="na">ViewHolder</span> <span class="n">viewHolder</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">touchHelper</span><span class="o">.</span><span class="na">startDrag</span><span class="o">(</span><span class="n">viewHolder</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Recycler_view에 touchHelper를 callback과 함께 연결하는데 MemoItemTouchHelperCallback은 swap또는 drag의 행동을 판별하는데 사용되며 onMove, getMovementFlags 등의 함수를 오버라이딩하여 재정의한다. 이렇게 행동에 대해 정의된 callback을 가진 ItemTouchHelper가 호출이 되면 그에 맞는 콜백이 실행되며 위치를 움직이거나 밀어서 삭제하는 것과 같은 행위가 가능해지게 된다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">setMemoContent</span><span class="o">(</span><span class="nc">MemoViewHolder</span> <span class="n">memoViewHolder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">itemPosition</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">memoList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemPosition</span><span class="o">).</span><span class="na">isChecked</span><span class="o">())</span> <span class="o">{</span>
        <span class="nc">SpannableString</span> <span class="n">spannableContent</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SpannableString</span><span class="o">(</span><span class="n">memoList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemPosition</span><span class="o">).</span><span class="na">getContent</span><span class="o">());</span>
        <span class="n">spannableContent</span><span class="o">.</span><span class="na">setSpan</span><span class="o">(</span><span class="k">new</span> <span class="nc">StrikethroughSpan</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">spannableContent</span><span class="o">.</span><span class="na">length</span><span class="o">(),</span> <span class="nc">Spanned</span><span class="o">.</span><span class="na">SPAN_EXCLUSIVE_EXCLUSIVE</span><span class="o">);</span>
        <span class="n">memoViewHolder</span><span class="o">.</span><span class="na">getTVContent</span><span class="o">().</span><span class="na">setText</span><span class="o">(</span><span class="n">spannableContent</span><span class="o">);</span>
        <span class="n">memoViewHolder</span><span class="o">.</span><span class="na">getTVContent</span><span class="o">().</span><span class="na">setAlpha</span><span class="o">(</span><span class="mf">0.4</span><span class="no">F</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">memoViewHolder</span><span class="o">.</span><span class="na">getTVContent</span><span class="o">().</span><span class="na">setText</span><span class="o">(</span><span class="n">memoList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">itemPosition</span><span class="o">).</span><span class="na">getContent</span><span class="o">());</span>
        <span class="n">memoViewHolder</span><span class="o">.</span><span class="na">getTVContent</span><span class="o">().</span><span class="na">setAlpha</span><span class="o">(</span><span class="mi">1</span><span class="no">F</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>또 다른 재밌는 코드는 SpannableString이다. 해당 부분을 통해 Text의 형태를 결정하는데 StrikethroughSpan을 사용하여 선택된 홀더의 text부분에 중간 밑줄을 그음으로써 특정 메모에 대한 상태를 나타낸다.</p>


        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#android" class="page__taxonomy-item" rel="tag">Android</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#java" class="page__taxonomy-item" rel="tag">JAVA</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#dev" class="page__taxonomy-item" rel="tag">dev</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 게시일:</strong> <time datetime="2020-06-02T00:00:00+09:00">June 2, 2020</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%EB%84%88%EC%9D%98+%EC%9D%B4%EB%A6%84%EC%9D%80+%EC%98%81%ED%99%94%EC%97%90+%EB%82%98%EC%98%A8+MyDiary%EB%A5%BC+%EA%B5%AC%ED%98%84%ED%95%9C+%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4+%EC%95%B1+%EB%98%91%EA%B0%99%EC%9D%B4+%EB%94%B0%EB%9D%BC+%EC%BD%94%EB%94%A9%ED%95%B4%EB%B3%B4%EA%B8%B0%20http%3A%2F%2Flocalhost%3A4000%2Fdev%2F%25EB%2584%2588%25EC%259D%2598-%25EC%259D%25B4%25EB%25A6%2584%25EC%259D%2580-%25EC%2598%2581%25ED%2599%2594%25EC%2597%2590-%25EB%2582%2598%25EC%2598%25A8-MyDiary%25EB%25A5%25BC-%25EA%25B5%25AC%25ED%2598%2584%25ED%2595%259C-%25EC%2598%25A4%25ED%2594%2588%25EC%2586%258C%25EC%258A%25A4-%25EC%2595%25B1-%25EB%2598%2591%25EA%25B0%2599%25EC%259D%25B4-%25EB%2594%25B0%25EB%259D%25BC-%25EC%25BD%2594%25EB%2594%25A9%25ED%2595%25B4%25EB%25B3%25B4%25EA%25B8%25B0%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fdev%2F%25EB%2584%2588%25EC%259D%2598-%25EC%259D%25B4%25EB%25A6%2584%25EC%259D%2580-%25EC%2598%2581%25ED%2599%2594%25EC%2597%2590-%25EB%2582%2598%25EC%2598%25A8-MyDiary%25EB%25A5%25BC-%25EA%25B5%25AC%25ED%2598%2584%25ED%2595%259C-%25EC%2598%25A4%25ED%2594%2588%25EC%2586%258C%25EC%258A%25A4-%25EC%2595%25B1-%25EB%2598%2591%25EA%25B0%2599%25EC%259D%25B4-%25EB%2594%25B0%25EB%259D%25BC-%25EC%25BD%2594%25EB%2594%25A9%25ED%2595%25B4%25EB%25B3%25B4%25EA%25B8%25B0%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fdev%2F%25EB%2584%2588%25EC%259D%2598-%25EC%259D%25B4%25EB%25A6%2584%25EC%259D%2580-%25EC%2598%2581%25ED%2599%2594%25EC%2597%2590-%25EB%2582%2598%25EC%2598%25A8-MyDiary%25EB%25A5%25BC-%25EA%25B5%25AC%25ED%2598%2584%25ED%2595%259C-%25EC%2598%25A4%25ED%2594%2588%25EC%2586%258C%25EC%258A%25A4-%25EC%2595%25B1-%25EB%2598%2591%25EA%25B0%2599%25EC%259D%25B4-%25EB%2594%25B0%25EB%259D%25BC-%25EC%25BD%2594%25EB%2594%25A9%25ED%2595%25B4%25EB%25B3%25B4%25EA%25B8%25B0%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/dev/JAVA-+-graphQL%EB%A1%9C-%EC%95%88%EB%93%9C%EB%A1%9C%EC%9D%B4%EB%93%9C-%EC%96%B4%ED%94%8C-%ED%81%B4%EB%A1%A0%EC%BD%94%EB%94%A9%ED%95%98%EA%B8%B0/" class="pagination--pager" title="JAVA + graphQL로 안드로이드 어플 클론코딩하기
">이전</a>
    
    
      <a href="#" class="pagination--pager disabled">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">참고</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/dev/JAVA-+-graphQL%EB%A1%9C-%EC%95%88%EB%93%9C%EB%A1%9C%EC%9D%B4%EB%93%9C-%EC%96%B4%ED%94%8C-%ED%81%B4%EB%A1%A0%EC%BD%94%EB%94%A9%ED%95%98%EA%B8%B0/" rel="permalink">JAVA + graphQL로 안드로이드 어플 클론코딩하기
</a>
      
    </h2>
    <!--
      comments:
        아카이브 싱글 페이지 각 포스트 제목 하단에 Updated 시간 표기
        기존에는 read_time이 표기됨
    
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  53 분 소요

</p>
    
    -->
    
    <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> April 03 2020</p>
    

    <p class="archive__item-excerpt" itemprop="description">Overview
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/dev/Django-+-REST-+-SQLite-@-docker%EB%A1%9C-Eaten_Away-%EC%84%9C%EB%B9%84%EC%8A%A4-%EA%B0%9C%EB%B0%9C%ED%95%98%EA%B8%B0/" rel="permalink">Django + REST + SQLite @ docker로 Eaten_Away 서비스 개발하기
</a>
      
    </h2>
    <!--
      comments:
        아카이브 싱글 페이지 각 포스트 제목 하단에 Updated 시간 표기
        기존에는 read_time이 표기됨
    
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  46 분 소요

</p>
    
    -->
    
    <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> March 02 2020</p>
    

    <p class="archive__item-excerpt" itemprop="description">Overview
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/dev/PHP-+-nginx-+-mysql-@-docker%EB%A1%9C-%EA%B2%8C%EC%8B%9C%ED%8C%90-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0/" rel="permalink">PHP + nginx + mysql @ docker로 게시판 구현하기
</a>
      
    </h2>
    <!--
      comments:
        아카이브 싱글 페이지 각 포스트 제목 하단에 Updated 시간 표기
        기존에는 read_time이 표기됨
    
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  37 분 소요

</p>
    
    -->
    
    <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> February 25 2020</p>
    

    <p class="archive__item-excerpt" itemprop="description">Overview
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/dev/Hello-Design-Pattern/" rel="permalink">Hello Design Pattern!
</a>
      
    </h2>
    <!--
      comments:
        아카이브 싱글 페이지 각 포스트 제목 하단에 Updated 시간 표기
        기존에는 read_time이 표기됨
    
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 분 소요

</p>
    
    -->
    
    <p class="page__meta"><i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i> February 19 2020</p>
    

    <p class="archive__item-excerpt" itemprop="description">HelloWorld!
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    

    
      
        
          <li><a href="https://github.com/wizleysw" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2020 Wizley. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>
